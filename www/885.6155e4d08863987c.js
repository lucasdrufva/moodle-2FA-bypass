"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[885],{70885:(e,t,o)=>{o.r(t),o.d(t,{default:()=>G});var n=o(10467),i=o(3353),r=o(37184),a=o(23732),s=o(30270),l=o(85618),d=o(89417),c=o(75629),u=o(91120),m=o(44682),y=o(94247),f=o(98833),h=o(16082),g=o(8444),v=o(23780),b=o(15324),p=o(94455),E=o(52749),C=o(48966),I=o(89911),_=o(43411),F=o(79555),x=o(49882),M=o(63153),S=o(16474),N=o(55554),R=o(54438),k=o(41450),w=o(95638),O=o(64422),T=o(7570),j=o(86198),B=o(58197),P=o(88246),U=o(43570),W=o(73465),A=o(73955);const D=["editEntryForm"],_c1=(e,t)=>({modtype:e,modname:t}),_c2=e=>({$a:e}),_c3=e=>({coursename:e});function AddonBlogEditEntryPage_Conditional_35_Conditional_8_Conditional_1_Template(e,t){if(1&e&&(R.j41(0,"ion-toggle",17),R.nrm(1,"core-format-text",18),R.nI1(2,"translate"),R.k0s()),2&e){const e=R.XpG(3);R.R7$(),R.Y8G("text",R.i5U(2,4,"addon.blog.associatewithmodule",R.eq3(10,_c2,R.l_i(7,_c1,e.associatedModule.modname,e.associatedModule.name))))("contextLevel",e.moduleContext)("contextInstanceId",e.modId)("courseId",e.courseId)}}function AddonBlogEditEntryPage_Conditional_35_Conditional_8_Conditional_2_Template(e,t){if(1&e&&(R.j41(0,"ion-toggle",19),R.nrm(1,"core-format-text",18),R.nI1(2,"translate"),R.k0s()),2&e){const e=R.XpG(3);R.R7$(),R.Y8G("text",R.i5U(2,4,"addon.blog.associatewithcourse",R.eq3(9,_c2,R.eq3(7,_c3,e.associatedCourse.fullname))))("contextLevel",e.courseContext)("contextInstanceId",e.courseId)("courseId",e.courseId)}}function AddonBlogEditEntryPage_Conditional_35_Conditional_8_Template(e,t){if(1&e&&(R.j41(0,"ion-item"),R.DNE(1,AddonBlogEditEntryPage_Conditional_35_Conditional_8_Conditional_1_Template,3,12,"ion-toggle",17)(2,AddonBlogEditEntryPage_Conditional_35_Conditional_8_Conditional_2_Template,3,11),R.k0s()),2&e){const e=R.XpG(2);R.R7$(),R.vxM(1,e.associatedModule?1:e.associatedCourse?2:-1)}}function AddonBlogEditEntryPage_Conditional_35_Template(e,t){if(1&e){const e=R.RV6();R.j41(0,"ion-item",14),R.nI1(1,"translate"),R.bIt("click",(function AddonBlogEditEntryPage_Conditional_35_Template_ion_item_click_0_listener(){R.eBV(e);const t=R.XpG();return R.Njj(t.toggleAssociations())})),R.nrm(2,"ion-icon",15),R.j41(3,"ion-label")(4,"h2"),R.EFF(5),R.nI1(6,"translate"),R.k0s()()(),R.j41(7,"div",16),R.DNE(8,AddonBlogEditEntryPage_Conditional_35_Conditional_8_Template,3,1,"ion-item"),R.k0s()}if(2&e){const e=R.XpG();R.AVh("expandable-status-icon-expanded",e.associationsExpanded),R.Y8G("detail",!1),R.BMQ("aria-label",R.bMT(1,8,e.associationsExpanded?"core.collapse":"core.expand"))("aria-expanded",e.associationsExpanded),R.R7$(2),R.Y8G("name",e.associationsExpanded?"fas-chevron-down":"fas-chevron-right"),R.R7$(3),R.JRh(R.bMT(6,10,"addon.blog.associations")),R.R7$(3),R.vxM(8,e.associationsExpanded?8:-1)}}let G=(()=>{var e;class AddonBlogEditEntryPage{constructor(){this.publishState=a.F6,this.form=new d.gE({subject:new d.MJ("",{nonNullable:!0,validators:[d.k0.required]}),summary:new d.MJ("",{nonNullable:!0,validators:[d.k0.required]}),publishState:new d.MJ(a.F6.site,{nonNullable:!0,validators:[d.k0.required]}),associateWithCourse:new d.MJ(!1,{nonNullable:!0,validators:[d.k0.required]}),associateWithModule:new d.MJ(!1,{nonNullable:!0,validators:[d.k0.required]})}),this.loaded=!1,this.maxFiles=99,this.initialFiles=[],this.files=[],this.associationsExpanded=!1,this.moduleContext="module",this.courseContext="course",this.contextLevel="system",this.contextInstanceId=0,this.component=a.Ed.COMPONENT,this.forceLeave=!1,this.isOfflineEntry=!1}get hasDataChangedForEdit(){var e,t,o,n,i;const r=this.form.controls;return r.summary.value!==(null===(e=this.entry)||void 0===e?void 0:e.summary)||r.subject.value!==(null===(t=this.entry)||void 0===t?void 0:t.subject)||r.publishState.value!==(null===(o=this.entry)||void 0===o?void 0:o.publishstate)||h.CoreFileUploader.areFileListDifferent(this.files,this.initialFiles)||r.associateWithModule.value!==(0!==(null===(n=this.entry)||void 0===n?void 0:n.moduleid))||r.associateWithCourse.value!==(0!==(null===(i=this.entry)||void 0===i?void 0:i.courseid))}get hasDataChangedForNewEntry(){const e=this.form.controls;return""!==e.subject.value||""!==e.summary.value||e.publishState.value!==a.F6.site||h.CoreFileUploader.areFileListDifferent(this.files,this.initialFiles)}ngOnInit(){var e=this;return(0,n.A)((function*(){var t,o,n,i,s,d,u;const f=yield E.CoreSites.getSite(),h=yield a.hU.isEditingEnabled();if(!f||!h)return b.CoreNavigator.back();const g=b.CoreNavigator.getRouteParam("id"),v=b.CoreNavigator.getRouteNumberParam("lastModified"),p=b.CoreNavigator.getRouteParam("filters"),_=b.CoreNavigator.getRouteNumberParam("courseId"),F=b.CoreNavigator.getRouteNumberParam("cmId");e.userId=b.CoreNavigator.getRouteNumberParam("userId"),e.siteHomeId=E.CoreSites.getCurrentSiteHomeId(),e.isOfflineEntry=null!==(t=null==g?void 0:g.startsWith("new-"))&&void 0!==t&&t;const x=Number(g);if(0!==x){try{var M,S;if(yield l.a.waitForSync(r.mO),e.isOfflineEntry){if(e.entry=yield e.getFormattedBlogOfflineEntry({created:Number(null==g?void 0:g.slice(4))}),!e.entry)throw new c.CoreError("This offline entry no longer exists.")}else{const t=yield e.getFormattedBlogOfflineEntry({id:x});e.entry=null!=t?t:yield e.getEntry({filters:p,lastModified:v,entryId:x})}if(e.files=[...null!==(M=e.entry.attachmentfiles)&&void 0!==M?M:[]],e.initialFiles=[...e.files],e.entry)C.CoreSync.blockOperation(a.Ed.COMPONENT,null!==(S=e.entry.id)&&void 0!==S?S:e.entry.created),e.courseId=e.courseId||e.entry.courseid,e.modId=b.CoreNavigator.getRouteNumberParam("cmId")||e.entry.coursemoduleid;if(e.courseId){e.form.controls.associateWithCourse.setValue(!0);const{course:t}=yield y.CoreCourseHelper.getCourse(e.courseId);e.associatedCourse=t}e.modId&&(e.form.controls.associateWithModule.setValue(!0),e.associatedModule=yield m.CoreCourse.getModule(e.modId))}catch(t){return I.CoreDomUtils.showErrorModalDefault(t,"Error retrieving data."),e.forceLeave=!0,b.CoreNavigator.back(),void 0}e.form.setValue({subject:null!==(o=null===(n=e.entry)||void 0===n?void 0:n.subject)&&void 0!==o?o:"",summary:null!==(i=null===(s=e.entry)||void 0===s?void 0:s.summary)&&void 0!==i?i:"",publishState:null!==(d=null===(u=e.entry)||void 0===u?void 0:u.publishstate)&&void 0!==d?d:a.F6.site,associateWithCourse:e.form.controls.associateWithCourse.value,associateWithModule:e.form.controls.associateWithModule.value}),e.calculateContext(),e.loaded=!0}else{e.loaded=!0;try{if(F&&(e.modId=F,e.form.controls.associateWithModule.setValue(!0),e.associatedModule=yield m.CoreCourse.getModule(e.modId)),_){e.courseId=_,e.form.controls.associateWithCourse.setValue(!0);const{course:t}=yield y.CoreCourseHelper.getCourse(e.courseId);e.associatedCourse=t}}catch(e){I.CoreDomUtils.showErrorModalDefault(e,"Error getting associations, they may not be displayed correctly.")}}}))()}ngOnDestroy(){var e;this.entry&&C.CoreSync.unblockOperation(a.Ed.COMPONENT,null!==(e=this.entry.id)&&void 0!==e?e:this.entry.created)}getEntry(e){return(0,n.A)((function*(){try{const{entries:t}=yield a.hU.getEntries({entryid:e.entryId},{readingStrategy:3}),o=t.find((t=>t.id===e.entryId));if(!o)throw new c.CoreError("Entry not found");if(e.filters&&e.lastModified&&o.lastmodified<e.lastModified)throw new c.CoreError("Entry is outdated");return o}catch(t){if(!e.filters||_.CoreWSError.isWebServiceError(t))throw t;const o=(yield a.hU.getEntries(e.filters)).entries.find((t=>t.id===e.entryId));if(!o)throw t;return o}}))()}calculateContext(){!this.userId||this.courseId||this.modId?this.courseId&&this.courseId!=this.siteHomeId?(this.contextLevel="course",this.contextInstanceId=this.courseId):(this.contextLevel="system",this.contextInstanceId=0):(this.contextLevel="user",this.contextInstanceId=this.userId)}save(){var e=this;return(0,n.A)((function*(){var t,o,n;const{summary:i,subject:r,publishState:s}=e.form.value;if(!r||!i||!s)return;const l=yield v.CoreLoadings.show("core.sending",!0);if(null!==(t=e.entry)&&void 0!==t&&t.id)try{var d;if(!p.WE.isOnline()){const t=yield e.uploadOrStoreFiles({entryId:e.entry.id});return yield e.saveEntry({attachmentsId:t})}if(!h.CoreFileUploader.areFileListDifferent(e.files,e.initialFiles))return yield e.saveEntry({});const{attachmentsid:t}=yield a.hU.prepareEntryForEdition({entryid:e.entry.id}),o=b.CoreNavigator.getRouteNumberParam("lastModified"),n=b.CoreNavigator.getRouteParam("filters"),i=e.entry&&"attachment"in e.entry?e.entry:yield N.g.ignoreErrors(e.getEntry({filters:n,lastModified:o,entryId:e.entry.id})),r=h.CoreFileUploader.getFilesToDelete(null!==(d=null==i?void 0:i.attachmentfiles)&&void 0!==d?d:[],e.files);return r.length&&(yield h.CoreFileUploader.deleteDraftFiles(t,r)),yield h.CoreFileUploader.uploadFiles(t,e.files),yield e.saveEntry({attachmentsId:t})}catch(t){if(_.CoreWSError.isWebServiceError(t))return I.CoreDomUtils.showErrorModalDefault(t,"Error updating entry."),void 0;const o=yield e.uploadOrStoreFiles({entryId:e.entry.id,forceStorage:!0});return yield e.saveEntry({attachmentsId:o,forceOffline:!0})}finally{yield l.dismiss()}const c=null!==(o=null===(n=e.entry)||void 0===n?void 0:n.created)&&void 0!==o?o:S.CoreTimeUtils.timestamp();try{if(!e.files.length)return yield e.saveEntry({created:c});const t=yield e.uploadOrStoreFiles({created:c});yield e.saveEntry({created:c,attachmentsId:t})}catch(t){if(_.CoreWSError.isWebServiceError(t))return I.CoreDomUtils.showErrorModalDefault(t,"Error creating entry."),void 0;const o=yield e.uploadOrStoreFiles({created:c,forceStorage:!0});return yield e.saveEntry({attachmentsId:o,forceOffline:!0})}finally{yield l.dismiss()}}))()}uploadOrStoreFiles(e){var t=this;return(0,n.A)((function*(){if(p.WE.isOnline()&&!e.forceStorage)return yield h.CoreFileUploader.uploadOrReuploadFiles(t.files,t.component);const o="entryId"in e?{id:e.entryId}:{created:e.created},n=yield s.Q.getOfflineEntryFilesFolderPath(o);return yield h.CoreFileUploader.storeFilesToUpload(n,t.files)}))()}toggleAssociations(){this.associationsExpanded=!this.associationsExpanded}canLeave(){var e=this;return(0,n.A)((function*(){return e.forceLeave||((!e.entry&&e.hasDataChangedForNewEntry||e.entry&&e.hasDataChangedForEdit)&&(yield I.CoreDomUtils.showConfirm(F.HT.instant("core.confirmcanceledit"))),M.R.triggerFormCancelledEvent(e.formElement,E.CoreSites.getCurrentSiteId())),!0}))()}saveEntry(e){var t=this;return(0,n.A)((function*(){var o;const{summary:n,subject:i,publishState:s}=t.form.value;if(!n||!i||!s)return;const l=[{name:"publishstate",value:s},{name:"courseassoc",value:t.form.controls.associateWithCourse.value&&t.courseId?t.courseId:0},{name:"modassoc",value:t.form.controls.associateWithModule.value&&t.modId?t.modId:0}];var d;(e.attachmentsId&&l.push({name:"attachmentsid",value:e.attachmentsId}),null!==(o=t.entry)&&void 0!==o&&o.id)?yield a.hU.updateEntry({subject:i,summary:n,summaryformat:1,options:l,forceOffline:e.forceOffline,entryid:t.entry.id,created:t.entry.created}):yield a.hU.addEntry({subject:i,summary:n,summaryformat:1,options:l,created:null!==(d=e.created)&&void 0!==d?d:S.CoreTimeUtils.timestamp(),forceOffline:e.forceOffline});return x.z.trigger(r.d4),t.forceLeave=!0,M.R.triggerFormSubmittedEvent(t.formElement,!0,E.CoreSites.getCurrentSiteId()),b.CoreNavigator.back()}))()}getFormattedBlogOfflineEntry(e){return(0,n.A)((function*(){const t=yield s.Q.getOfflineEntry(e);return t?yield a.hU.formatOfflineEntry(t):void 0}))()}}return(e=AddonBlogEditEntryPage).ɵfac=function AddonBlogEditEntryPage_Factory(t){return new(t||e)},e.ɵcmp=R.VBU({type:e,selectors:[["addon-blog-edit-entry"]],viewQuery:function AddonBlogEditEntryPage_Query(e,t){if(1&e&&R.GBs(D,5),2&e){let e;R.mGM(e=R.lsd())&&(t.formElement=e.first)}},standalone:!0,features:[R.aNF],decls:40,vars:54,consts:[["editEntryForm",""],["slot","start"],[3,"text"],["slot","end"],[3,"hideUntil"],[3,"formGroup"],["labelPlacement","stacked","formControlName","subject","type","text","name","title",3,"placeholder","label"],["position","stacked","for","addon_blog_entry_body"],["name","addon_blog_entry_body",3,"control","placeholder","componentId","autoSave","contextInstanceId","contextLevel","elementId"],["lines","none"],["name","addon_blog_publish_to","formControlName","publishState",3,"label"],[1,"core-select-option-title",3,"value"],[3,"files","maxSubmissions","maxSize","component","allowOffline","componentId"],["expand","block",1,"ion-margin",3,"click","ariaLabel","disabled"],["button","","aria-controls","addon-blog-associations",1,"divider","section",3,"click","detail"],["flip-rtl","","slot","start",1,"expandable-status-icon",3,"name"],["id","addon-blog-associations"],["formControlName","associateWithModule"],[3,"text","contextLevel","contextInstanceId","courseId"],["formControlName","associateWithCourse"]],template:function AddonBlogEditEntryPage_Template(e,t){if(1&e){const e=R.RV6();R.j41(0,"ion-header")(1,"ion-toolbar")(2,"ion-buttons",1),R.nrm(3,"ion-back-button",2),R.nI1(4,"translate"),R.k0s(),R.j41(5,"ion-title")(6,"h1"),R.EFF(7),R.nI1(8,"translate"),R.k0s()(),R.nrm(9,"ion-buttons",3),R.k0s()(),R.j41(10,"ion-content")(11,"core-loading",4)(12,"form",5,0)(14,"ion-item"),R.nrm(15,"ion-input",6),R.nI1(16,"translate"),R.nI1(17,"translate"),R.k0s(),R.j41(18,"ion-item")(19,"ion-label",7),R.EFF(20),R.nI1(21,"translate"),R.k0s(),R.nrm(22,"core-rich-text-editor",8),R.nI1(23,"translate"),R.nI1(24,"translate"),R.k0s(),R.j41(25,"ion-item",9)(26,"core-combobox",10),R.nI1(27,"translate"),R.j41(28,"ion-select-option",11),R.EFF(29),R.nI1(30,"translate"),R.k0s(),R.j41(31,"ion-select-option",11),R.EFF(32),R.nI1(33,"translate"),R.k0s()()(),R.nrm(34,"core-attachments",12),R.DNE(35,AddonBlogEditEntryPage_Conditional_35_Template,9,12),R.j41(36,"ion-button",13),R.nI1(37,"translate"),R.bIt("click",(function AddonBlogEditEntryPage_Template_ion_button_click_36_listener(){return R.eBV(e),R.Njj(t.save())})),R.EFF(38),R.nI1(39,"translate"),R.k0s()()()()}if(2&e){let e,o;R.R7$(3),R.Y8G("text",R.bMT(4,30,"core.back")),R.R7$(4),R.JRh(t.entry?t.entry.subject:R.bMT(8,32,"addon.blog.addnewentry")),R.R7$(4),R.Y8G("hideUntil",t.loaded),R.R7$(),R.Y8G("formGroup",t.form),R.R7$(3),R.Y8G("placeholder",R.bMT(16,34,"addon.blog.entrytitle"))("label",R.bMT(17,36,"addon.blog.entrytitle")),R.R7$(5),R.JRh(R.bMT(21,38,"addon.blog.entrybody")),R.R7$(2),R.Y8G("control",t.form.controls.summary)("placeholder",R.bMT(23,40,"addon.blog.entrybody"))("componentId",t.component)("autoSave",!0)("contextInstanceId",t.contextInstanceId)("contextLevel",t.contextLevel)("elementId",null!==(e=null==t.entry?null:t.entry.id)&&void 0!==e?e:"new_entry"),R.BMQ("aria-label",R.bMT(24,42,"addon.blog.entrybody")),R.R7$(4),R.Y8G("label",R.bMT(27,44,"addon.blog.publishto")),R.R7$(2),R.Y8G("value",t.publishState.draft),R.R7$(),R.SpI(" ",R.bMT(30,46,"addon.blog.publishtonoone")," "),R.R7$(2),R.Y8G("value",t.publishState.site),R.R7$(),R.SpI(" ",R.bMT(33,48,"addon.blog.publishtosite")," "),R.R7$(2),R.Y8G("files",t.files)("maxSubmissions",t.maxFiles)("maxSize",0)("component",t.component)("allowOffline",!0)("componentId",null!==(o=null==t.entry?null:t.entry.id)&&void 0!==o?o:0),R.R7$(),R.vxM(35,t.courseId&&t.associatedCourse?35:-1),R.R7$(),R.Y8G("ariaLabel",R.bMT(37,50,"core.save"))("disabled",t.form.invalid||t.entry&&!t.hasDataChangedForEdit),R.R7$(2),R.SpI(" ",R.bMT(39,52,"core.save")," ")}},dependencies:[f.d,k.u,i.n,w.V,O.R,T._,j.t,B.B,P.i,U.T,d.qT,d.BC,d.cb,W.Jm,W.QW,W.W9,W.eU,W.iq,W.$w,W.uz,W.he,W.Ip,W.BC,W.BY,W.ai,W.hB,W.Gw,W.el,d.j4,d.JD,A.D9,u.G,g.O],encapsulation:2}),AddonBlogEditEntryPage})()}}]);