"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[833],{35853:(e,t,s)=>{s.d(t,{V:()=>g});var r=s(10467),i=s(75629),n=s(97254),o=s(98870),a=s(52749),d=s(79555),c=s(22535),h=s(74431),u=s(54438);let l=(()=>{var e;class AddonModChatProvider{getChat(e,t,s={}){var n=this;return(0,r.A)((function*(){const r=yield a.CoreSites.getSite(s.siteId),o={courseids:[e]},u={cacheKey:n.getChatsCacheKey(e),updateFrequency:h.CoreCacheUpdateFrequency.RARELY,component:c.L5,...a.CoreSites.getReadingStrategyPreSets(s.readingStrategy)},l=(yield r.read("mod_chat_get_chats_by_courses",o,u)).chats.find((e=>e.coursemodule==t));if(l)return l;throw new i.CoreError(d.HT.instant("core.course.modulenotfound"))}))()}loginUser(e,t){return(0,r.A)((function*(){const s=yield a.CoreSites.getSite(t),r={chatid:e};return(yield s.write("mod_chat_login_user",r)).chatsid}))()}logView(e,t){return(0,r.A)((function*(){const s={chatid:e};yield n.CoreCourseLogHelper.log("mod_chat_view_chat",s,c.L5,e,t)}))()}logViewSessions(e,t){return(0,r.A)((function*(){const s={cmid:e};t&&(s.start=t.start,s.end=t.end),yield n.CoreCourseLogHelper.log("mod_chat_view_sessions",s,c.L5,e)}))()}sendMessage(e,t,s,i){return(0,r.A)((function*(){const r=yield a.CoreSites.getSite(i),n={chatsid:e,messagetext:t,beepid:String(s)};return(yield r.write("mod_chat_send_chat_message",n)).messageid}))()}getLatestMessages(e,t,s){return(0,r.A)((function*(){return(yield a.CoreSites.getSite(s)).write("mod_chat_get_chat_latest_messages",{chatsid:e,chatlasttime:t})}))()}getMessagesUserData(e,t,s){return(0,r.A)((function*(){const i=e;return yield Promise.all(i.map(function(){var e=(0,r.A)((function*(e){try{const r=yield o.CoreUser.getProfile(e.userid,t,!0,s);e.userfullname=r.fullname,e.userprofileimageurl=r.profileimageurl}catch{e.userfullname=d.HT.instant("core.deleteduser")+" "+e.userid}}));return function(t){return e.apply(this,arguments)}}())),i}))()}getChatUsers(e,t={}){return(0,r.A)((function*(){t.readingStrategy=t.readingStrategy||3;const s=yield a.CoreSites.getSite(t.siteId),r={chatsid:e},i={component:c.L5,componentId:t.cmId,...a.CoreSites.getReadingStrategyPreSets(t.readingStrategy)};return s.read("mod_chat_get_chat_users",r,i)}))()}getSessions(e,t=0,s=!1,i={}){var n=this;return(0,r.A)((function*(){const r=yield a.CoreSites.getSite(i.siteId),o={chatid:e,groupid:t,showall:s},d={cacheKey:n.getSessionsCacheKey(e,t,s),updateFrequency:h.CoreCacheUpdateFrequency.SOMETIMES,component:c.L5,componentId:i.cmId,...a.CoreSites.getReadingStrategyPreSets(i.readingStrategy)};return(yield r.read("mod_chat_get_sessions",o,d)).sessions}))()}getSessionMessages(e,t,s,i=0,n={}){var o=this;return(0,r.A)((function*(){const r=yield a.CoreSites.getSite(n.siteId),d={chatid:e,sessionstart:t,sessionend:s,groupid:i},u={cacheKey:o.getSessionMessagesCacheKey(e,t,i),updateFrequency:h.CoreCacheUpdateFrequency.RARELY,component:c.L5,componentId:n.cmId,...a.CoreSites.getReadingStrategyPreSets(n.readingStrategy)};return(yield r.read("mod_chat_get_session_messages",d,u)).messages}))()}invalidateChats(e,t){var s=this;return(0,r.A)((function*(){const r=yield a.CoreSites.getSite(t);yield r.invalidateWsCacheForKey(s.getChatsCacheKey(e))}))()}invalidateSessions(e,t=0,s=!1,i){var n=this;return(0,r.A)((function*(){const r=yield a.CoreSites.getSite(i);yield r.invalidateWsCacheForKey(n.getSessionsCacheKey(e,t,s))}))()}invalidateAllSessions(e,t){var s=this;return(0,r.A)((function*(){const r=yield a.CoreSites.getSite(t);yield r.invalidateWsCacheForKeyStartingWith(s.getSessionsCacheKeyPrefix(e))}))()}invalidateSessionMessages(e,t,s=0,i){var n=this;return(0,r.A)((function*(){const r=yield a.CoreSites.getSite(i);yield r.invalidateWsCacheForKey(n.getSessionMessagesCacheKey(e,t,s))}))()}invalidateAllSessionMessages(e,t){var s=this;return(0,r.A)((function*(){const r=yield a.CoreSites.getSite(t);yield r.invalidateWsCacheForKeyStartingWith(s.getSessionMessagesCacheKeyPrefix(e))}))()}getChatsCacheKey(e){return AddonModChatProvider.ROOT_CACHE_KEY+"chats:"+e}getSessionsCacheKey(e,t,s){return this.getSessionsCacheKeyPrefix(e)+t+":"+(s?1:0)}getSessionsCacheKeyPrefix(e){return AddonModChatProvider.ROOT_CACHE_KEY+"sessions:"+e+":"}getSessionMessagesCacheKey(e,t,s){return this.getSessionMessagesCacheKeyPrefix(e)+t+":"+s}getSessionMessagesCacheKeyPrefix(e){return AddonModChatProvider.ROOT_CACHE_KEY+"sessionsMessages:"+e+":"}}return(e=AddonModChatProvider).ROOT_CACHE_KEY="AddonModChat:",e.ɵfac=function AddonModChatProvider_Factory(t){return new(t||e)},e.ɵprov=u.jDH({token:e,factory:e.ɵfac,providedIn:"root"}),AddonModChatProvider})();const g=(0,d.Qd)(l)},30833:(e,t,s)=>{s.r(t),s.d(t,{AddonModChatPrefetchHandler:()=>g,AddonModChatPrefetchHandlerLazyService:()=>l});var r=s(10467),i=s(80234),n=s(35853),o=s(55554),a=s(44682),d=s(15221),c=s(98870),h=s(79555),u=s(54438);let l=(()=>{var e;class AddonModChatPrefetchHandlerLazyService extends i.F{invalidateContent(e,t){return(0,r.A)((function*(){const s=yield n.V.getChat(t,e);yield o.g.allPromises([n.V.invalidateAllSessions(s.id),n.V.invalidateAllSessionMessages(s.id)])}))()}invalidateModule(e,t){return(0,r.A)((function*(){yield o.g.allPromises([n.V.invalidateChats(t),a.CoreCourse.invalidateModule(e.id)])}))()}prefetch(e,t){return this.prefetchPackage(e,t,(s=>this.prefetchChat(e,t,s)))}prefetchChat(e,t,s){var i=this;return(0,r.A)((function*(){const r={readingStrategy:2,siteId:s},o={...r,cmId:e.id},[a,c]=yield Promise.all([n.V.getChat(t,e.id,r),d.CoreGroups.getActivityGroupInfo(e.id,!1,void 0,s)]),h=[];let u=[0];c.groups&&c.groups.length>0&&(u=c.groups.map((e=>e.id))),u.forEach((e=>{h.push(i.prefetchSessions(a.id,e,t,!1,o)),h.push(i.prefetchSessions(a.id,e,t,!0,o))})),yield Promise.all(h)}))()}prefetchSessions(e,t,s,i,o){var a=this;return(0,r.A)((function*(){try{const r=yield n.V.getSessions(e,t,i,o);i&&(yield Promise.all(r.map((r=>a.prefetchSession(e,r,t,s,o)))))}catch(e){if(e&&"notingroup"==e.errorcode)return;throw e}}))()}prefetchSession(e,t,s,i,o){return(0,r.A)((function*(){const r=yield n.V.getSessionMessages(e,t.sessionstart,t.sessionend,s,o),a={};t.sessionusers.forEach((e=>{a[e.userid]=e.userid})),r.forEach((e=>{a[e.userid]=e.userid}));const d=Object.values(a);yield c.CoreUser.prefetchProfiles(d,i,o.siteId)}))()}}return(e=AddonModChatPrefetchHandlerLazyService).ɵfac=(()=>{let t;return function AddonModChatPrefetchHandlerLazyService_Factory(s){return(t||(t=u.xGo(e)))(s||e)}})(),e.ɵprov=u.jDH({token:e,factory:e.ɵfac,providedIn:"root"}),AddonModChatPrefetchHandlerLazyService})();const g=(0,h.Qd)(l)}}]);