"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[8719],{48719:(e,o,s)=>{s.r(o),s.d(o,{default:()=>re});var t=s(21182),n=s(6007),a=s(3353),r=s(2138),i=s(15324),d=s(48049),l=s(54438),m=s(58197),c=s(68273),h=s(88246),u=s(73465),p=s(73955);let g=(()=>{var e;class AddonModWorkshopIndexPage extends r._{constructor(){super(...arguments),this.selectedGroup=0}ngOnInit(){super.ngOnInit(),this.selectedGroup=i.CoreNavigator.getRouteNumberParam("group")||0}}return(e=AddonModWorkshopIndexPage).ɵfac=(()=>{let o;return function AddonModWorkshopIndexPage_Factory(s){return(o||(o=l.xGo(e)))(s||e)}})(),e.ɵcmp=l.VBU({type:e,selectors:[["page-addon-mod-workshop-index"]],viewQuery:function AddonModWorkshopIndexPage_Query(e,o){if(1&e&&l.GBs(d.AddonModWorkshopIndexComponent,5),2&e){let e;l.mGM(e=l.lsd())&&(o.activityComponent=e.first)}},features:[l.Vt3],decls:14,vars:13,consts:[["collapsible",""],["slot","start"],[3,"text"],["contextLevel","module",3,"text","contextInstanceId","courseId"],["slot","end"],[1,"limited-width"],["slot","fixed",3,"ionRefresh","disabled"],[3,"pullingText"],[3,"dataRetrieved","module","courseId","group"]],template:function AddonModWorkshopIndexPage_Template(e,o){1&e&&(l.j41(0,"ion-header",0)(1,"ion-toolbar")(2,"ion-buttons",1),l.nrm(3,"ion-back-button",2),l.nI1(4,"translate"),l.k0s(),l.j41(5,"ion-title")(6,"h1"),l.nrm(7,"core-format-text",3),l.k0s()(),l.nrm(8,"ion-buttons",4),l.k0s()(),l.j41(9,"ion-content",5)(10,"ion-refresher",6),l.bIt("ionRefresh",(function AddonModWorkshopIndexPage_Template_ion_refresher_ionRefresh_10_listener(e){return null==o.activityComponent?null:o.activityComponent.doRefresh(e.target)})),l.nrm(11,"ion-refresher-content",7),l.nI1(12,"translate"),l.k0s(),l.j41(13,"addon-mod-workshop-index",8),l.bIt("dataRetrieved",(function AddonModWorkshopIndexPage_Template_addon_mod_workshop_index_dataRetrieved_13_listener(e){return o.updateData(e)})),l.k0s()()),2&e&&(l.R7$(3),l.Y8G("text",l.bMT(4,9,"core.back")),l.R7$(4),l.Y8G("text",o.title)("contextInstanceId",o.module.id)("courseId",o.courseId),l.R7$(3),l.Y8G("disabled",null==o.activityComponent?null:o.activityComponent.showLoading),l.R7$(),l.FS9("pullingText",l.bMT(12,11,"core.pulltorefresh")),l.R7$(2),l.Y8G("module",o.module)("courseId",o.courseId)("group",o.selectedGroup))},dependencies:[m.B,c.M,h.i,u.QW,u.W9,u.eU,u.To,u.Ki,u.BC,u.ai,u.el,d.AddonModWorkshopIndexComponent,p.D9],encapsulation:2}),AddonModWorkshopIndexPage})();var f=s(31851),k=s(17443),_=s(98833),I=s(10467),v=s(89417),b=s(44682),w=s(97383),A=s(98870),M=s(52749),y=s(48966),W=s(89911),R=s(75383),T=s(79555),x=s(49882),G=s(63153),P=s(67193),E=s(80178),F=s(26327),C=s(24742),D=s(22693),S=s(81552),$=s(23780),Y=s(60177),q=s(64422),j=s(17778),N=s(16658),O=s(43570),U=s(45157),L=s(41450);const B=["evaluateFormEl"],_c1=e=>({$a:e}),_c2=e=>({header:e}),_c3=e=>({asid:e});function AddonModWorkshopAssessmentPage_ion_refresher_13_Template(e,o){if(1&e){const e=l.RV6();l.j41(0,"ion-refresher",16),l.bIt("ionRefresh",(function AddonModWorkshopAssessmentPage_ion_refresher_13_Template_ion_refresher_ionRefresh_0_listener(o){l.eBV(e);const s=l.XpG();return l.Njj(s.refreshAssessment(o.target))})),l.nrm(1,"ion-refresher-content",17),l.nI1(2,"translate"),l.k0s()}if(2&e){const e=l.XpG();l.Y8G("disabled",!e.loaded),l.R7$(),l.FS9("pullingText",l.bMT(2,2,"core.pulltorefresh"))}}function AddonModWorkshopAssessmentPage_core_user_avatar_16_Template(e,o){if(1&e&&l.nrm(0,"core-user-avatar",18),2&e){const e=l.XpG();l.Y8G("user",e.profile)("courseId",e.courseId)("userId",e.profile.id)}}function AddonModWorkshopAssessmentPage_h2_18_Template(e,o){if(1&e&&(l.j41(0,"h2"),l.EFF(1),l.k0s()),2&e){const e=l.XpG();l.R7$(),l.JRh(e.profile.fullname)}}function AddonModWorkshopAssessmentPage_p_19_Template(e,o){if(1&e&&(l.j41(0,"p"),l.EFF(1),l.nI1(2,"translate"),l.k0s()),2&e){const e=l.XpG();l.R7$(),l.Lme(" ",l.i5U(2,2,"addon.mod_workshop.submissiongradeof",l.eq3(5,_c1,e.workshop.grade)),": ",e.assessment.grade," ")}}function AddonModWorkshopAssessmentPage_p_20_Template(e,o){if(1&e&&(l.j41(0,"p"),l.EFF(1),l.nI1(2,"translate"),l.k0s()),2&e){const e=l.XpG();l.AVh("core-has-overriden-grade",e.showGrade(e.assessment.gradinggrade)),l.R7$(),l.Lme(" ",l.i5U(2,4,"addon.mod_workshop.gradinggradeof",l.eq3(7,_c1,e.workshop.gradinggrade)),": ",e.assessment.gradinggrade," ")}}function AddonModWorkshopAssessmentPage_p_21_Template(e,o){if(1&e&&(l.j41(0,"p",19),l.EFF(1),l.nI1(2,"translate"),l.k0s()),2&e){const e=l.XpG();l.R7$(),l.Lme(" ",l.bMT(2,2,"addon.mod_workshop.gradinggradeover"),": ",e.assessment.gradinggradeover," ")}}function AddonModWorkshopAssessmentPage_p_22_Template(e,o){if(1&e&&(l.j41(0,"p"),l.EFF(1),l.nI1(2,"translate"),l.k0s()),2&e){const e=l.XpG();l.R7$(),l.SpI(" ",l.i5U(2,1,"addon.mod_workshop.weightinfo",l.eq3(4,_c1,e.assessment.weight))," ")}}function AddonModWorkshopAssessmentPage_ion_badge_23_Template(e,o){1&e&&(l.j41(0,"ion-badge",20),l.EFF(1),l.nI1(2,"translate"),l.k0s()),2&e&&(l.R7$(),l.SpI(" ",l.bMT(2,1,"addon.mod_workshop.notassessed")," "))}function AddonModWorkshopAssessmentPage_addon_mod_workshop_assessment_strategy_24_Template(e,o){if(1&e&&l.nrm(0,"addon-mod-workshop-assessment-strategy",21),2&e){const e=l.XpG();l.Y8G("workshop",e.workshop)("access",e.access)("assessmentId",e.assessmentId)("userId",e.profile&&e.profile.id)("strategy",e.strategy)}}function AddonModWorkshopAssessmentPage_form_25_ion_item_7_ion_select_option_7_Template(e,o){if(1&e&&(l.j41(0,"ion-select-option",28),l.EFF(1),l.k0s()),2&e){const e=o.$implicit;l.Y8G("value",e),l.R7$(),l.JRh(e)}}function AddonModWorkshopAssessmentPage_form_25_ion_item_7_Template(e,o){if(1&e&&(l.j41(0,"ion-item",8)(1,"ion-select",25),l.nI1(2,"translate"),l.nI1(3,"translate"),l.j41(4,"div",26),l.EFF(5),l.nI1(6,"translate"),l.k0s(),l.DNE(7,AddonModWorkshopAssessmentPage_form_25_ion_item_7_ion_select_option_7_Template,2,2,"ion-select-option",27),l.k0s()()),2&e){const e=l.XpG(2);l.R7$(),l.Y8G("cancelText",l.bMT(2,5,"core.cancel"))("interfaceOptions",l.eq3(11,_c2,l.bMT(3,7,"addon.mod_workshop.assessmentweight"))),l.R7$(3),l.Y8G("core-mark-required",!0),l.R7$(),l.SpI(" ",l.bMT(6,9,"addon.mod_workshop.assessmentweight")," "),l.R7$(2),l.Y8G("ngForOf",e.weights)}}function AddonModWorkshopAssessmentPage_form_25_ion_item_15_ion_select_option_5_Template(e,o){if(1&e&&(l.j41(0,"ion-select-option",28),l.EFF(1),l.k0s()),2&e){const e=o.$implicit;l.Y8G("value",e.value),l.R7$(),l.SpI(" ",e.label," ")}}function AddonModWorkshopAssessmentPage_form_25_ion_item_15_Template(e,o){if(1&e&&(l.j41(0,"ion-item",8)(1,"ion-select",29),l.nI1(2,"translate"),l.nI1(3,"translate"),l.nI1(4,"translate"),l.DNE(5,AddonModWorkshopAssessmentPage_form_25_ion_item_15_ion_select_option_5_Template,2,2,"ion-select-option",27),l.k0s()()),2&e){const e=l.XpG(2);l.R7$(),l.Y8G("cancelText",l.bMT(2,4,"core.cancel"))("interfaceOptions",l.eq3(10,_c2,l.bMT(3,6,"addon.mod_workshop.gradinggradeover")))("label",l.bMT(4,8,"addon.mod_workshop.gradinggradeover")),l.R7$(4),l.Y8G("ngForOf",e.evaluationGrades)}}function AddonModWorkshopAssessmentPage_form_25_ion_item_16_Template(e,o){if(1&e&&(l.j41(0,"ion-item")(1,"ion-label",30),l.EFF(2),l.nI1(3,"translate"),l.k0s(),l.nrm(4,"core-rich-text-editor",31),l.k0s()),2&e){const e=l.XpG(2);l.R7$(2),l.JRh(l.bMT(3,5,"addon.mod_workshop.feedbackreviewer")),l.R7$(2),l.Y8G("control",e.evaluateForm.controls.text)("autoSave",!0)("contextInstanceId",null==e.workshop?null:e.workshop.coursemodule)("draftExtraParams",l.eq3(7,_c3,e.assessmentId))}}function AddonModWorkshopAssessmentPage_form_25_Template(e,o){if(1&e&&(l.j41(0,"form",22,0)(2,"ion-item",8)(3,"ion-label")(4,"h3",23),l.EFF(5),l.nI1(6,"translate"),l.k0s()()(),l.DNE(7,AddonModWorkshopAssessmentPage_form_25_ion_item_7_Template,8,13,"ion-item",24),l.j41(8,"ion-item",8)(9,"ion-label")(10,"h3",23),l.EFF(11),l.nI1(12,"translate"),l.k0s(),l.j41(13,"p"),l.EFF(14),l.k0s()()(),l.DNE(15,AddonModWorkshopAssessmentPage_form_25_ion_item_15_Template,6,12,"ion-item",24)(16,AddonModWorkshopAssessmentPage_form_25_ion_item_16_Template,5,9,"ion-item",10),l.k0s()),2&e){const e=l.XpG();l.Y8G("formGroup",e.evaluateForm),l.R7$(5),l.JRh(l.bMT(6,7,"addon.mod_workshop.assessmentsettings")),l.R7$(2),l.Y8G("ngIf",null==e.access?null:e.access.canallocate),l.R7$(4),l.JRh(l.bMT(12,9,"addon.mod_workshop.gradinggradecalculated")),l.R7$(3),l.JRh(e.gradingGrade),l.R7$(),l.Y8G("ngIf",null==e.access?null:e.access.canoverridegrades),l.R7$(),l.Y8G("ngIf",null==e.access?null:e.access.canoverridegrades)}}function AddonModWorkshopAssessmentPage_ion_list_26_core_user_avatar_2_Template(e,o){if(1&e&&l.nrm(0,"core-user-avatar",18),2&e){const e=l.XpG(2);l.Y8G("user",e.evaluateByProfile)("courseId",e.courseId)("userId",e.evaluateByProfile.id)}}function AddonModWorkshopAssessmentPage_ion_list_26_h3_4_Template(e,o){if(1&e&&(l.j41(0,"h3",23),l.EFF(1),l.nI1(2,"translate"),l.k0s()),2&e){const e=l.XpG(2);l.R7$(),l.SpI(" ",l.i5U(2,1,"addon.mod_workshop.feedbackby",l.eq3(4,_c1,e.evaluateByProfile.fullname))," ")}}function AddonModWorkshopAssessmentPage_ion_list_26_Template(e,o){if(1&e&&(l.j41(0,"ion-list")(1,"ion-item",8),l.DNE(2,AddonModWorkshopAssessmentPage_ion_list_26_core_user_avatar_2_Template,1,3,"core-user-avatar",9),l.j41(3,"ion-label"),l.DNE(4,AddonModWorkshopAssessmentPage_ion_list_26_h3_4_Template,3,6,"h3",32),l.nrm(5,"core-format-text",3),l.k0s()()()),2&e){const e=l.XpG();l.R7$(2),l.Y8G("ngIf",e.evaluateByProfile),l.R7$(2),l.Y8G("ngIf",e.evaluateByProfile&&e.evaluateByProfile.fullname),l.R7$(),l.Y8G("text",e.evaluate.text)("contextInstanceId",null==e.workshop?null:e.workshop.coursemodule)("courseId",e.courseId)}}let V=(()=>{var e;class AddonModWorkshopAssessmentPage{constructor(e){var o=this;this.fb=e,this.evaluating=!1,this.loaded=!1,this.title="",this.evaluate={text:"",grade:-1,weight:1},this.weights=[],this.evaluationGrades=[],this.originalEvaluation={text:"",grade:-1,weight:1},this.hasOffline=!1,this.isDestroyed=!1,this.forceLeave=!1,this.siteId=M.CoreSites.getCurrentSiteId(),this.currentUserId=M.CoreSites.getCurrentSiteUserId(),this.showGrade=E.AddonModWorkshopHelper.showGrade,this.evaluateForm=new v.gE({}),this.evaluateForm.addControl("weight",this.fb.control("",v.k0.required)),this.evaluateForm.addControl("grade",this.fb.control("")),this.evaluateForm.addControl("text",this.fb.control("")),this.syncObserver=x.z.on(S.N7,(e=>{this.workshopId===e.workshopId&&(this.loaded=!1,this.refreshAllData())}),this.siteId),this.logView=C.j.once((0,I.A)((function*(){o.workshop&&D.OF.logEvent({type:D.qr.VIEW_ITEM,ws:"mod_workshop_get_assessment",name:o.workshop.name,data:{id:o.workshop.id,assessmentid:o.assessment.id,category:"workshop"},url:`/mod/workshop/assessment.php?asid=${o.assessment.id}`})})))}ngOnInit(){try{this.assessment=i.CoreNavigator.getRequiredRouteParam("assessment"),this.submission=i.CoreNavigator.getRequiredRouteParam("submission"),this.profile=i.CoreNavigator.getRouteParam("profile"),this.courseId=i.CoreNavigator.getRequiredRouteNumberParam("courseId")}catch(e){return W.CoreDomUtils.showErrorModal(e),i.CoreNavigator.back(),void 0}this.assessmentId=this.assessment.id,this.workshopId=this.submission.workshopid,this.fetchAssessmentData()}canLeave(){var e=this;return(0,I.A)((function*(){return!(!e.forceLeave&&e.evaluating)||(!e.hasEvaluationChanged()||(yield W.CoreDomUtils.showConfirm(T.HT.instant("core.confirmcanceledit")),G.R.triggerFormCancelledEvent(e.formElement,e.siteId),!0))}))()}fetchAssessmentData(){var e=this;return(0,I.A)((function*(){try{var o,s;e.workshop=yield P.AddonModWorkshop.getWorkshopById(e.courseId,e.workshopId),e.title=e.workshop.name,e.strategy=e.workshop.strategy;const t=yield b.CoreCourse.getModuleBasicGradeInfo(e.workshop.coursemodule);if(e.maxGrade=null==t?void 0:t.grade,e.access=yield P.AddonModWorkshop.getWorkshopAccessInformation(e.workshopId,{cmId:e.workshop.coursemodule}),e.assessmentId&&(e.access.canallocate||e.access.canoverridegrades)?(e.isDestroyed||y.CoreSync.blockOperation(S.Ug,e.workshopId),e.evaluating=!0):e.evaluating=!1,!e.evaluating&&50!=e.workshop.phase)return;const n=yield E.AddonModWorkshopHelper.getReviewerAssessmentById(e.workshopId,e.assessmentId,{userId:null===(o=e.profile)||void 0===o?void 0:o.id,cmId:e.workshop.coursemodule});if(e.assessment=E.AddonModWorkshopHelper.realGradeValue(e.workshop,n),e.evaluate.text=e.assessment.feedbackreviewer||"",e.evaluate.weight=e.assessment.weight,e.gradingGrade=null!==(s=e.assessment.gradinggrade)&&void 0!==s?s:"-",e.evaluating){if(e.access.canallocate){e.weights=[];for(let o=16;o>=0;o--)e.weights[o]=o}if(e.access.canoverridegrades){const o=T.HT.instant("addon.mod_workshop.notoverridden");e.evaluationGrades=yield w.CoreGradesHelper.makeGradesMenu(e.workshop.gradinggrade,void 0,o,-1)}try{const o=yield F.AddonModWorkshopOffline.getEvaluateAssessment(e.workshopId,e.assessmentId);e.hasOffline=!0,e.evaluate.weight=o.weight,e.access.canoverridegrades&&(e.evaluate.text=o.feedbacktext||"",e.evaluate.grade=parseInt(o.gradinggradeover,10)||-1)}catch{e.hasOffline=!1,e.access.canoverridegrades&&(e.evaluate.text=e.assessment.feedbackreviewer||"",e.evaluate.grade=parseInt(String(e.assessment.gradinggradeover),10)||-1)}finally{e.originalEvaluation.weight=e.evaluate.weight,e.access.canoverridegrades&&(e.originalEvaluation.text=e.evaluate.text,e.originalEvaluation.grade=e.evaluate.grade),e.evaluateForm.controls.weight.setValue(e.evaluate.weight),e.access.canoverridegrades&&(e.evaluateForm.controls.grade.setValue(e.evaluate.grade),e.evaluateForm.controls.text.setValue(e.evaluate.text))}}else 50==e.workshop.phase&&e.assessment.gradinggradeoverby&&(e.evaluateByProfile=yield A.CoreUser.getProfile(e.assessment.gradinggradeoverby,e.courseId,!0))}catch(e){W.CoreDomUtils.showErrorModalDefault(e,"core.course.errorgetmodule",!0)}finally{e.loaded=!0}}))()}forceLeavePage(){this.forceLeave=!0,i.CoreNavigator.back()}hasEvaluationChanged(){if(!this.loaded||!this.evaluating)return!1;const e=this.evaluateForm.value;if(this.originalEvaluation.weight!=e.weight)return!0;if(this.access&&this.access.canoverridegrades){if(this.originalEvaluation.text!=e.text)return!0;if(this.originalEvaluation.grade!=e.grade)return!0}return!1}refreshAllData(){var e=this;return(0,I.A)((function*(){const o=[];o.push(P.AddonModWorkshop.invalidateWorkshopData(e.courseId)),o.push(P.AddonModWorkshop.invalidateWorkshopAccessInformationData(e.workshopId)),o.push(P.AddonModWorkshop.invalidateReviewerAssesmentsData(e.workshopId)),e.assessmentId&&(o.push(P.AddonModWorkshop.invalidateAssessmentFormData(e.workshopId,e.assessmentId)),o.push(P.AddonModWorkshop.invalidateAssessmentData(e.workshopId,e.assessmentId)));try{yield Promise.all(o)}finally{x.z.trigger(S.Dl,null,e.siteId),yield e.fetchAssessmentData()}}))()}refreshAssessment(e){this.loaded&&this.refreshAllData().finally((()=>{null==e||e.complete()}))}saveEvaluation(){var e=this;return(0,I.A)((function*(){e.hasEvaluationChanged()&&(yield e.sendEvaluation()),e.forceLeavePage()}))()}sendEvaluation(){var e=this;return(0,I.A)((function*(){const o=yield $.CoreLoadings.show("core.sending",!0),s=e.evaluateForm.value,t=s.grade>=0?String(s.grade):"",n=R.Ni.formatHtmlLines(s.text);try{const o=yield P.AddonModWorkshop.evaluateAssessment(e.workshopId,e.assessmentId,e.courseId,n,s.weight,t);G.R.triggerFormSubmittedEvent(e.formElement,!!o,e.siteId);const a={workshopId:e.workshopId,assessmentId:e.assessmentId,userId:e.currentUserId};return P.AddonModWorkshop.invalidateAssessmentData(e.workshopId,e.assessmentId).finally((()=>{x.z.trigger(S.Px,a,e.siteId)}))}catch(e){W.CoreDomUtils.showErrorModalDefault(e,"Cannot save assessment evaluation")}finally{o.dismiss()}}))()}ngOnDestroy(){var e;this.isDestroyed=!0,null===(e=this.syncObserver)||void 0===e||e.off(),y.CoreSync.unblockOperation(S.Ug,this.workshopId)}}return(e=AddonModWorkshopAssessmentPage).ɵfac=function AddonModWorkshopAssessmentPage_Factory(o){return new(o||e)(l.rXU(v.ok))},e.ɵcmp=l.VBU({type:e,selectors:[["page-addon-mod-workshop-assessment-page"]],viewQuery:function AddonModWorkshopAssessmentPage_Query(e,o){if(1&e&&l.GBs(B,5),2&e){let e;l.mGM(e=l.lsd())&&(o.formElement=e.first)}},decls:27,vars:22,consts:[["evaluateFormEl",""],["slot","start"],[3,"text"],["contextLevel","module",3,"text","contextInstanceId","courseId"],["slot","end",3,"hidden"],["fill","clear",3,"click"],["slot","fixed",3,"disabled","ionRefresh",4,"ngIf"],[3,"hideUntil"],[1,"ion-text-wrap"],["slot","start",3,"user","courseId","userId",4,"ngIf"],[4,"ngIf"],[3,"core-has-overriden-grade",4,"ngIf"],["class","core-overriden-grade",4,"ngIf"],["color","danger",4,"ngIf"],[3,"workshop","access","assessmentId","userId","strategy",4,"ngIf"],[3,"formGroup",4,"ngIf"],["slot","fixed",3,"ionRefresh","disabled"],[3,"pullingText"],["slot","start",3,"user","courseId","userId"],[1,"core-overriden-grade"],["color","danger"],[3,"workshop","access","assessmentId","userId","strategy"],[3,"formGroup"],[1,"item-heading"],["class","ion-text-wrap",4,"ngIf"],["labelPlacement","stacked","formControlName","weight","required","true","interface","action-sheet",3,"cancelText","interfaceOptions"],["slot","label",3,"core-mark-required"],[3,"value",4,"ngFor","ngForOf"],[3,"value"],["labelPlacement","stacked","formControlName","grade","interface","action-sheet",3,"cancelText","interfaceOptions","label"],["position","stacked"],["name","text","contextLevel","module","elementId","feedbackreviewer_editor",3,"control","autoSave","contextInstanceId","draftExtraParams"],["class","item-heading",4,"ngIf"]],template:function AddonModWorkshopAssessmentPage_Template(e,o){1&e&&(l.j41(0,"ion-header")(1,"ion-toolbar")(2,"ion-buttons",1),l.nrm(3,"ion-back-button",2),l.nI1(4,"translate"),l.k0s(),l.j41(5,"ion-title")(6,"h1"),l.nrm(7,"core-format-text",3),l.k0s()(),l.j41(8,"ion-buttons",4)(9,"ion-button",5),l.bIt("click",(function AddonModWorkshopAssessmentPage_Template_ion_button_click_9_listener(){return o.saveEvaluation()})),l.EFF(10),l.nI1(11,"translate"),l.k0s()()()(),l.j41(12,"ion-content"),l.DNE(13,AddonModWorkshopAssessmentPage_ion_refresher_13_Template,3,4,"ion-refresher",6),l.j41(14,"core-loading",7)(15,"ion-item",8),l.DNE(16,AddonModWorkshopAssessmentPage_core_user_avatar_16_Template,1,3,"core-user-avatar",9),l.j41(17,"ion-label"),l.DNE(18,AddonModWorkshopAssessmentPage_h2_18_Template,2,1,"h2",10)(19,AddonModWorkshopAssessmentPage_p_19_Template,3,7,"p",10)(20,AddonModWorkshopAssessmentPage_p_20_Template,3,9,"p",11)(21,AddonModWorkshopAssessmentPage_p_21_Template,3,4,"p",12)(22,AddonModWorkshopAssessmentPage_p_22_Template,3,6,"p",10)(23,AddonModWorkshopAssessmentPage_ion_badge_23_Template,3,3,"ion-badge",13),l.k0s()(),l.DNE(24,AddonModWorkshopAssessmentPage_addon_mod_workshop_assessment_strategy_24_Template,1,5,"addon-mod-workshop-assessment-strategy",14)(25,AddonModWorkshopAssessmentPage_form_25_Template,17,11,"form",15)(26,AddonModWorkshopAssessmentPage_ion_list_26_Template,6,5,"ion-list",10),l.k0s()()),2&e&&(l.R7$(3),l.Y8G("text",l.bMT(4,18,"core.back")),l.R7$(4),l.Y8G("text",o.title)("contextInstanceId",o.workshop&&o.workshop.coursemodule)("courseId",o.courseId),l.R7$(),l.Y8G("hidden",!o.evaluating),l.R7$(2),l.SpI(" ",l.bMT(11,20,"core.save")," "),l.R7$(3),l.Y8G("ngIf",!o.evaluating),l.R7$(),l.Y8G("hideUntil",o.loaded),l.R7$(2),l.Y8G("ngIf",o.profile),l.R7$(2),l.Y8G("ngIf",o.profile&&o.profile.fullname),l.R7$(),l.Y8G("ngIf",o.workshop&&o.assessment&&o.showGrade(o.assessment.grade)),l.R7$(),l.Y8G("ngIf",o.workshop&&o.access&&o.access.canviewallsubmissions&&o.assessment&&o.showGrade(o.assessment.gradinggrade)),l.R7$(),l.Y8G("ngIf",o.access&&o.access.canviewallsubmissions&&o.assessment&&o.showGrade(o.assessment.gradinggradeover)),l.R7$(),l.Y8G("ngIf",o.assessment&&o.assessment.weight&&1!==o.assessment.weight),l.R7$(),l.Y8G("ngIf",!o.assessment||!o.showGrade(o.assessment.grade)),l.R7$(),l.Y8G("ngIf",o.assessment&&o.assessmentId&&o.showGrade(o.assessment.grade)&&o.workshop&&o.access),l.R7$(),l.Y8G("ngIf",o.evaluating),l.R7$(),l.Y8G("ngIf",!o.evaluating&&o.evaluate&&o.evaluate.text))},dependencies:[Y.Sq,Y.bT,q.R,j.j,N.T,m.B,h.i,O.T,v.qT,v.BC,v.cb,v.YS,u.In,u.Jm,u.QW,u.W9,u.eU,u.uz,u.he,u.nf,u.To,u.Ki,u.Nm,u.Ip,u.BC,u.ai,u.Je,u.el,v.j4,v.JD,U.o,L.u,p.D9],encapsulation:2}),AddonModWorkshopAssessmentPage})();var X=s(75629),J=s(16082),H=s(45507),z=s(88436),Q=s(43411),K=s(82907),Z=s(95638);const ee=["editFormEl"];function AddonModWorkshopEditSubmissionPage_form_16_ion_item_8_Template(e,o){if(1&e&&(l.j41(0,"ion-item")(1,"ion-label",13)(2,"div",14),l.EFF(3),l.nI1(4,"translate"),l.k0s()(),l.nrm(5,"core-rich-text-editor",15),l.nI1(6,"translate"),l.k0s()),2&e){const e=l.XpG(2);l.R7$(2),l.Y8G("core-mark-required",e.textRequired),l.R7$(),l.SpI(" ",l.bMT(4,9,"addon.mod_workshop.submissioncontent")," "),l.R7$(2),l.Y8G("control",e.editForm.controls.content)("placeholder",l.bMT(6,11,"addon.mod_workshop.submissioncontent"))("component",e.component)("componentId",e.componentId)("autoSave",!0)("contextInstanceId",e.module.id)("draftExtraParams",e.editorExtraParams)}}function AddonModWorkshopEditSubmissionPage_form_16_core_attachments_9_Template(e,o){if(1&e&&l.nrm(0,"core-attachments",16),2&e){const e=l.XpG(2);l.Y8G("files",e.attachments)("maxSize",e.workshop.maxbytes)("maxSubmissions",e.workshop.nattachments)("component",e.component)("componentId",e.workshop.coursemodule)("acceptedTypes",e.workshop.submissionfiletypes)("required",e.fileRequired)("courseId",e.workshop.course)}}function AddonModWorkshopEditSubmissionPage_form_16_Template(e,o){if(1&e&&(l.j41(0,"form",7,0)(2,"ion-item",8)(3,"ion-input",9),l.nI1(4,"translate"),l.j41(5,"div",10),l.EFF(6),l.nI1(7,"translate"),l.k0s()()(),l.DNE(8,AddonModWorkshopEditSubmissionPage_form_16_ion_item_8_Template,7,13,"ion-item",11)(9,AddonModWorkshopEditSubmissionPage_form_16_core_attachments_9_Template,1,8,"core-attachments",12),l.k0s()),2&e){const e=l.XpG();l.Y8G("formGroup",e.editForm),l.R7$(3),l.Y8G("placeholder",l.bMT(4,6,"addon.mod_workshop.submissiontitle")),l.R7$(2),l.Y8G("core-mark-required",!0),l.R7$(),l.SpI(" ",l.bMT(7,8,"addon.mod_workshop.submissiontitle")," "),l.R7$(2),l.Y8G("ngIf",e.textAvailable),l.R7$(),l.Y8G("ngIf",e.fileAvailable)}}let oe=(()=>{var e;class AddonModWorkshopEditSubmissionPage{constructor(e){this.fb=e,this.loaded=!1,this.component=S.Ug,this.editorExtraParams={},this.textAvailable=!1,this.textRequired=!1,this.fileAvailable=!1,this.fileRequired=!1,this.attachments=[],this.submissionId=0,this.originalData={title:"",content:"",attachmentfiles:[]},this.hasOffline=!1,this.editing=!1,this.forceLeave=!1,this.isDestroyed=!1,this.userId=M.CoreSites.getCurrentSiteUserId(),this.siteId=M.CoreSites.getCurrentSiteId(),this.editForm=new v.gE({}),this.editForm.addControl("title",this.fb.control("",v.k0.required)),this.editForm.addControl("content",this.fb.control(""))}ngOnInit(){try{this.module=i.CoreNavigator.getRequiredRouteParam("module"),this.courseId=i.CoreNavigator.getRequiredRouteNumberParam("courseId"),this.access=i.CoreNavigator.getRequiredRouteParam("access"),this.submissionId=i.CoreNavigator.getRouteNumberParam("submissionId")||0}catch(e){return W.CoreDomUtils.showErrorModal(e),i.CoreNavigator.back(),void 0}this.submissionId>0&&(this.editorExtraParams.id=this.submissionId),this.workshopId=this.module.instance,this.componentId=this.module.id,this.isDestroyed||y.CoreSync.blockOperation(this.component,this.workshopId),this.fetchSubmissionData()}canLeave(){var e=this;return(0,I.A)((function*(){var o;return e.forceLeave||(e.hasDataChanged()&&(yield W.CoreDomUtils.showConfirm(T.HT.instant("core.confirmcanceledit"))),null!==(o=e.submission)&&void 0!==o&&o.attachmentfiles&&J.CoreFileUploader.clearTmpFiles(e.submission.attachmentfiles),G.R.triggerFormCancelledEvent(e.formElement,e.siteId)),!0}))()}fetchSubmissionData(){var e=this;return(0,I.A)((function*(){try{if(e.workshop=yield P.AddonModWorkshop.getWorkshop(e.courseId,e.module.id),e.textAvailable=0!=e.workshop.submissiontypetext,e.textRequired=2==e.workshop.submissiontypetext,e.fileAvailable=0!=e.workshop.submissiontypefile,e.fileRequired=2==e.workshop.submissiontypefile,e.editForm.controls.content.setValidators(e.textRequired?v.k0.required:null),e.submissionId>0){e.editing=!0,e.submission=yield E.AddonModWorkshopHelper.getSubmissionById(e.workshopId,e.submissionId,{cmId:e.module.id});if(!(e.userId==e.submission.authorid&&e.access.cansubmit&&e.access.modifyingsubmissionallowed))return e.forceLeavePage(),void 0}else if(!e.access.cansubmit||!e.access.creatingsubmissionallowed)return e.forceLeavePage(),void 0;const o=yield F.AddonModWorkshopOffline.getSubmissions(e.workshopId);o&&o.length?(e.hasOffline=!0,e.submission=yield E.AddonModWorkshopHelper.applyOfflineData(e.submission,o)):e.hasOffline=!1,e.submission&&(e.originalData.title=e.submission.title||"",e.originalData.content=e.submission.content||"",e.originalData.attachmentfiles=[],(e.submission.attachmentfiles||[]).forEach((o=>{let s=H.CoreFile.getFileName(o);s||(s=z.CoreFileHelper.getFilenameFromPath(o)||""),e.originalData.attachmentfiles.push({filename:s,fileurl:"fileurl"in o?o.fileurl:""})})),e.editForm.controls.title.setValue(e.submission.title),e.editForm.controls.content.setValue(e.submission.content),e.attachments=e.submission.attachmentfiles||[]),e.loaded=!0,e.logView()}catch(o){e.loaded=!1,W.CoreDomUtils.showErrorModalDefault(o,"core.course.errorgetmodule",!0),e.forceLeavePage()}}))()}logView(){this.workshop&&D.OF.logEvent({type:D.qr.VIEW_ITEM,ws:this.editing?"mod_workshop_update_submission":"mod_workshop_add_submission",name:this.workshop.name,data:{id:this.workshop.id,submissionid:this.submissionId,category:"workshop"},url:`/mod/workshop/submission.php?cmid=${this.module.id}&id=${this.submissionId}&edit=on`})}forceLeavePage(){this.forceLeave=!0,i.CoreNavigator.back()}getInputData(){const e={title:this.editForm.value.title,content:"",attachmentfiles:[]};return this.textAvailable&&(e.content=this.editForm.value.content||""),this.fileAvailable&&(e.attachmentfiles=this.attachments),e}hasDataChanged(){if(!this.loaded)return!1;const e=this.getInputData();return!!(this.originalData.title!=e.title||this.textAvailable&&this.originalData.content!=e.content)||!!this.fileAvailable&&J.CoreFileUploader.areFileListDifferent(e.attachmentfiles,this.originalData.attachmentfiles)}save(){var e=this;return(0,I.A)((function*(){if(e.hasDataChanged())try{yield e.saveSubmission(),e.forceLeavePage()}catch{}else e.forceLeavePage()}))()}saveSubmission(){var e=this;return(0,I.A)((function*(){var o;const s=e.getInputData();if(!s.title)throw W.CoreDomUtils.showAlertTranslated("core.notice","addon.mod_workshop.submissionrequiredtitle"),new X.CoreError(T.HT.instant("addon.mod_workshop.submissionrequiredtitle"));const t=K.y.htmlIsBlank(s.content),n=!s.attachmentfiles.length;if(e.textRequired&&t||e.fileRequired&&n||t&&n)throw W.CoreDomUtils.showAlertTranslated("core.notice","addon.mod_workshop.submissionrequiredcontent"),new X.CoreError(T.HT.instant("addon.mod_workshop.submissionrequiredcontent"));let a=!1;const r=yield $.CoreLoadings.show("core.sending",!0),i=null===(o=e.submission)||void 0===o?void 0:o.id;e.textAvailable&&(s.content=R.Ni.formatHtmlLines(s.content));let d=!s.attachmentfiles.length;try{let o,t,n;try{o=yield E.AddonModWorkshopHelper.uploadOrStoreSubmissionFiles(e.workshopId,s.attachmentfiles,!1)}catch(o){if(Q.CoreWSError.isWebServiceError(o))throw o;a=!0,d=!0,t=yield E.AddonModWorkshopHelper.uploadOrStoreSubmissionFiles(e.workshopId,s.attachmentfiles,!0)}if(a||e.fileAvailable||(o=void 0),e.editing)if(a)yield F.AddonModWorkshopOffline.saveSubmission(e.workshopId,e.courseId,s.title,s.content,t,i,"update"),n=!1;else{if(!i)throw new X.CoreError("Submission cannot be updated without a submissionId");n=yield P.AddonModWorkshop.updateSubmission(e.workshopId,i,e.courseId,s.title,s.content,o,void 0,d)}else a?(yield F.AddonModWorkshopOffline.saveSubmission(e.workshopId,e.courseId,s.title,s.content,t,void 0,"add"),n=!1):n=yield P.AddonModWorkshop.addSubmission(e.workshopId,e.courseId,s.title,s.content,o,void 0,d);G.R.triggerFormSubmittedEvent(e.formElement,!!n,e.siteId);const r={workshopId:e.workshopId};n&&(F.AddonModWorkshopOffline.deleteSubmissionAction(e.workshopId,e.editing?"update":"add"),E.AddonModWorkshopHelper.deleteSubmissionStoredFiles(e.workshopId,e.siteId),r.submissionId=n),x.z.trigger(x.z.ACTIVITY_DATA_SENT,{module:"workshop"});const l=n?P.AddonModWorkshop.invalidateSubmissionData(e.workshopId,n):Promise.resolve();yield l.finally((()=>{x.z.trigger(S.AZ,r,e.siteId),J.CoreFileUploader.clearTmpFiles(s.attachmentfiles)}))}catch(e){W.CoreDomUtils.showErrorModalDefault(e,"Cannot save submission")}finally{r.dismiss()}}))()}getFilesComponentId(){return this.workshopId+"_"+(this.submissionId>0?this.submissionId:"newsub")}ngOnDestroy(){this.isDestroyed=!0,y.CoreSync.unblockOperation(this.component,this.workshopId)}}return(e=AddonModWorkshopEditSubmissionPage).ɵfac=function AddonModWorkshopEditSubmissionPage_Factory(o){return new(o||e)(l.rXU(v.ok))},e.ɵcmp=l.VBU({type:e,selectors:[["page-addon-mod-workshop-edit-submission"]],viewQuery:function AddonModWorkshopEditSubmissionPage_Query(e,o){if(1&e&&l.GBs(ee,5),2&e){let e;l.mGM(e=l.lsd())&&(o.formElement=e.first)}},decls:17,vars:14,consts:[["editFormEl",""],["slot","start"],[3,"text"],["slot","end"],["fill","clear",3,"click","ariaLabel"],[3,"hideUntil"],[3,"formGroup",4,"ngIf"],[3,"formGroup"],[1,"ion-text-wrap"],["labelPlacement","stacked","name","title","type","text","formControlName","title",3,"placeholder"],["slot","label",3,"core-mark-required"],[4,"ngIf"],["allowOffline","true",3,"files","maxSize","maxSubmissions","component","componentId","acceptedTypes","required","courseId",4,"ngIf"],["position","stacked"],[3,"core-mark-required"],["name","content","contextLevel","module","elementId","content_editor",3,"control","placeholder","component","componentId","autoSave","contextInstanceId","draftExtraParams"],["allowOffline","true",3,"files","maxSize","maxSubmissions","component","componentId","acceptedTypes","required","courseId"]],template:function AddonModWorkshopEditSubmissionPage_Template(e,o){1&e&&(l.j41(0,"ion-header")(1,"ion-toolbar")(2,"ion-buttons",1),l.nrm(3,"ion-back-button",2),l.nI1(4,"translate"),l.k0s(),l.j41(5,"ion-title")(6,"h1"),l.EFF(7),l.nI1(8,"translate"),l.k0s()(),l.j41(9,"ion-buttons",3)(10,"ion-button",4),l.nI1(11,"translate"),l.bIt("click",(function AddonModWorkshopEditSubmissionPage_Template_ion_button_click_10_listener(){return o.save()})),l.EFF(12),l.nI1(13,"translate"),l.k0s()()()(),l.j41(14,"ion-content")(15,"core-loading",5),l.DNE(16,AddonModWorkshopEditSubmissionPage_form_16_Template,10,10,"form",6),l.k0s()()),2&e&&(l.R7$(3),l.Y8G("text",l.bMT(4,6,"core.back")),l.R7$(4),l.JRh(l.bMT(8,8,"addon.mod_workshop.editsubmission")),l.R7$(3),l.Y8G("ariaLabel",l.bMT(11,10,"core.save")),l.R7$(2),l.SpI(" ",l.bMT(13,12,"core.save")," "),l.R7$(3),l.Y8G("hideUntil",o.loaded),l.R7$(),l.Y8G("ngIf",o.workshop))},dependencies:[Y.bT,Z.V,q.R,j.j,h.i,O.T,v.qT,v.BC,v.cb,u.Jm,u.QW,u.W9,u.eU,u.$w,u.uz,u.he,u.BC,u.ai,u.Gw,u.el,v.j4,v.JD,L.u,p.D9],encapsulation:2}),AddonModWorkshopEditSubmissionPage})();var se=s(86198),te=s(61919),ne=s(40803);const ae=[{path:":courseId/:cmId",component:g},{path:":courseId/:cmId/:submissionId",component:k.D,canDeactivate:[n.V]},{path:":courseId/:cmId/:submissionId/edit",component:oe,canDeactivate:[n.V]},{path:":courseId/:cmId/:submissionId/:assessmentId",component:V,canDeactivate:[n.V]}];let re=(()=>{var e;class AddonModWorkshopLazyModule{}return(e=AddonModWorkshopLazyModule).ɵfac=function AddonModWorkshopLazyModule_Factory(o){return new(o||e)},e.ɵmod=l.$C({type:e}),e.ɵinj=l.G2t({imports:[t.iI.forChild(ae),a.n,f.AddonModWorkshopComponentsModule,_.d]}),AddonModWorkshopLazyModule})();void(("undefined"==typeof ngJitMode||ngJitMode)&&l.Obh(re,{declarations:[g,k.D,V,oe],imports:[t.iI,a.n,f.AddonModWorkshopComponentsModule,_.d]})),l.wjB(k.D,(function(){return[Y.Sq,Y.bT,q.R,N.T,se.t,m.B,h.i,O.T,v.qT,v.BC,v.cb,u.Jm,u.QW,u.W9,u.eU,u.iq,u.uz,u.Dg,u.he,u.nf,u.To,u.Ki,u.Nm,u.Ip,u.BC,u.BY,u.ai,u.hB,u.Je,u.el,v.j4,v.JD,te.J,ne.Z,U.o,L.u]}),(function(){return[p.D9]}))}}]);