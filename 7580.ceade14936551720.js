"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[7580],{57580:(e,t,n)=>{n.r(t),n.d(t,{CoreSitePluginsInit:()=>ce,CoreSitePluginsInitService:()=>ue});var r=n(10467),i=n(2806),s=n(62007),o=n(95790),l=n(15646),a=n(75629),d=n(63114),u=n(48236),c=n(78765),g=n(14001),h=n(97086),p=n(8979),m=n(95376),S=n(13482),C=n(89857),f=n(63196),v=n(5784),y=n(999),P=n(88793),H=n(72881),A=n(52749),b=n(75383),k=n(55554),D=n(99121),R=n(49882),I=n(6787),E=n(3379),w=n(79555);class CoreSitePluginsAssignFeedbackHandler extends E.W{constructor(e,t,n){super(),this.name=e,this.type=t,this.prefix=n}getComponent(){return(0,r.A)((function*(){const{CoreSitePluginsAssignFeedbackComponent:e}=yield n.e(2076).then(n.bind(n,88646));return e}))()}getPluginName(e){const t=this.prefix+"pluginname",n=w.HT.instant(t);return t!=n?n:e.name}}var F=n(81672);class CoreSitePluginsAssignSubmissionHandler extends F.x{constructor(e,t,n){super(),this.name=e,this.type=t,this.prefix=n}getComponent(){return(0,r.A)((function*(){const{CoreSitePluginsAssignSubmissionComponent:e}=yield n.e(2076).then(n.bind(n,72918));return e}))()}getPluginName(e){const t=this.prefix+"pluginname",n=w.HT.instant(t);return t!=n?n:e.name}}var M=n(2638),x=n(26766),N=n(91768),_=n(3484),O=n(32832),B=n(15324),U=n(3353),T=n(54438),L=n(73465),$=n(73955);let j=(()=>{var e;class CoreSitePluginsOnlyTitleBlockComponent extends _.d{constructor(){super("CoreSitePluginsOnlyTitleBlockComponent")}ngOnInit(){var _superprop_getNgOnInit=()=>super.ngOnInit,e=this;return(0,r.A)((function*(){var t;_superprop_getNgOnInit().call(e),e.fetchContentDefaultError="Error getting "+((null===(t=e.block.contents)||void 0===t?void 0:t.title)||"block")+" data."}))()}gotoBlock(){const e=d.CoreBlockDelegate.getHandlerName(this.block.name),t=O.CoreSitePlugins.getSitePluginHandler(e);if(!t)return;const n={contextlevel:this.contextLevel,instanceid:this.instanceId},r=N.VV.hashAsciiStr(JSON.stringify(n));B.CoreNavigator.navigateToSitePath(`siteplugins/content/${t.plugin.component}/${t.handlerSchema.method}/${r}`,{params:{title:this.title,args:n,initResult:t.initResult,ptrEnabled:t.handlerSchema.ptrenabled}})}}return(e=CoreSitePluginsOnlyTitleBlockComponent).ɵfac=function CoreSitePluginsOnlyTitleBlockComponent_Factory(t){return new(t||e)},e.ɵcmp=T.VBU({type:e,selectors:[["core-siteplugins-only-title-block"]],standalone:!0,features:[T.Vt3,T.aNF],decls:5,vars:4,consts:[["button","",1,"divider","ion-text-wrap",3,"click","detail"]],template:function CoreSitePluginsOnlyTitleBlockComponent_Template(e,t){1&e&&(T.j41(0,"ion-item",0),T.bIt("click",(function CoreSitePluginsOnlyTitleBlockComponent_Template_ion_item_click_0_listener(){return t.gotoBlock()})),T.j41(1,"ion-label")(2,"h2"),T.EFF(3),T.nI1(4,"translate"),T.k0s()()()),2&e&&(T.Y8G("detail",!0),T.R7$(3),T.JRh(T.bMT(4,2,t.title)))},dependencies:[U.n,L.uz,L.he,$.D9],styles:["[_nghost-%COMP%]{display:contents}"]}),CoreSitePluginsOnlyTitleBlockComponent})();class CoreSitePluginsBaseHandler{constructor(e){this.name=e}isEnabled(){return(0,r.A)((function*(){return!0}))()}}class CoreSitePluginsBlockHandler extends CoreSitePluginsBaseHandler{constructor(e,t,n,r,i){super(e),this.title=t,this.blockName=n,this.handlerSchema=r,this.initResult=i,this.logger=I.CoreLogger.getInstance("CoreSitePluginsBlockHandler")}getDisplayData(e,t,n){var i=this;return(0,r.A)((function*(){var r,s,o;const l=(null===(r=i.handlerSchema.displaydata)||void 0===r?void 0:r.class)||"block_"+e.name;let u;if("title"==(null===(s=i.handlerSchema.displaydata)||void 0===s?void 0:s.type))u=j;else if("prerendered"==(null===(o=i.handlerSchema.displaydata)||void 0===o?void 0:o.type))u=M.S;else if(i.handlerSchema.fallback&&!i.handlerSchema.method){const r=e.name;e.name=i.handlerSchema.fallback;try{const s=yield d.CoreBlockDelegate.getBlockDisplayData(e,t,n);if(!s)throw new a.CoreError("Cannot get display data for fallback block.");i.logger.debug(`Using fallback "${i.handlerSchema.fallback}" for block "${r}"`),u=s.component}catch(e){throw i.logger.error(`Error using fallback "${i.handlerSchema.fallback}" for block "${r}", maybe it doesn't exist or isn't enabled.`,e),e}}else u=x.CoreSitePluginsBlockComponent;return{title:i.title,class:l,component:u}}))()}}var Q=n(46254);class CoreSitePluginsCourseFormatHandler extends CoreSitePluginsBaseHandler{constructor(e,t,n){super(e),this.format=t,this.handlerSchema=n}canViewAllSections(){var e;return null===(e=this.handlerSchema.canviewallsections)||void 0===e||e}displayCourseIndex(){var e;return null===(e=this.handlerSchema.displaycourseindex)||void 0===e||e}getCourseFormatComponent(){var e=this;return(0,r.A)((function*(){if(e.handlerSchema.method)return Q.CoreSitePluginsCourseFormatComponent}))()}}var V=n(25124);class CoreSitePluginsCourseOptionHandler extends CoreSitePluginsBaseHandler{constructor(e,t,n,r,i){super(e),this.title=t,this.plugin=n,this.handlerSchema=r,this.initResult=i,this.priority=r.priority||0,this.isMenuHandler=!!r.ismenuhandler}isEnabledForCourse(e){var t=this;return(0,r.A)((function*(){var n;return t.updatingDefer&&(yield t.updatingDefer),O.CoreSitePlugins.isHandlerEnabledForCourse(e,t.handlerSchema.restricttoenrolledcourses,null===(n=t.initResult)||void 0===n?void 0:n.restrict)}))()}getDisplayData(){var e;return{title:this.title,class:null===(e=this.handlerSchema.displaydata)||void 0===e?void 0:e.class,page:`siteplugins/${this.name}`,pageParams:{}}}getMenuDisplayData(e){var t,n;const r={courseid:e.id},i=N.VV.hashAsciiStr(JSON.stringify(r));return{title:this.title,class:null===(t=this.handlerSchema.displaydata)||void 0===t?void 0:t.class,icon:(null===(n=this.handlerSchema.displaydata)||void 0===n?void 0:n.icon)||"",page:`siteplugins/content/${this.plugin.component}/${this.handlerSchema.method}/${i}`,pageParams:{title:this.title,args:r,initResult:this.initResult,ptrEnabled:this.handlerSchema.ptrenabled}}}prefetch(e){return O.CoreSitePlugins.prefetchFunctions(this.plugin.component,{courseid:e.id},this.handlerSchema,e.id,void 0,!0)}setInitResult(e){var t;this.initResult=e,null===(t=this.updatingDefer)||void 0===t||t.resolve(),delete this.updatingDefer}updatingInit(){this.updatingDefer=new V._}}class CoreSitePluginsMainMenuHandler extends CoreSitePluginsBaseHandler{constructor(e,t,n,r,i){super(e),this.title=t,this.plugin=n,this.handlerSchema=r,this.initResult=i,this.priority=r.priority||0}getDisplayData(){var e,t;return{title:this.title,icon:(null===(e=this.handlerSchema.displaydata)||void 0===e?void 0:e.icon)||"fas-question",class:null===(t=this.handlerSchema.displaydata)||void 0===t?void 0:t.class,page:`siteplugins/content/${this.plugin.component}/${this.handlerSchema.method}/0`,pageParams:{title:this.title,initResult:this.initResult,ptrEnabled:this.handlerSchema.ptrenabled},onlyInMore:!0}}}class CoreSitePluginsMessageOutputHandler extends CoreSitePluginsBaseHandler{constructor(e,t,n,r,i,s){super(e),this.processorName=t,this.title=n,this.plugin=r,this.handlerSchema=i,this.initResult=s}getDisplayData(){var e;return{priority:this.handlerSchema.priority||0,label:this.title,icon:(null===(e=this.handlerSchema.displaydata)||void 0===e?void 0:e.icon)||"fas-question",page:`siteplugins/content/${this.plugin.component}/${this.handlerSchema.method}/0`,pageParams:{title:this.title,initResult:this.initResult,ptrEnabled:this.handlerSchema.ptrenabled}}}}var q=n(74431),z=n(44682),J=n(94247),W=n(57085);class CoreSitePluginsModuleHandler extends CoreSitePluginsBaseHandler{constructor(e,t,n,r,i){super(e),this.modName=t,this.plugin=n,this.handlerSchema=r,this.initResult=i,this.logger=I.CoreLogger.getInstance("CoreSitePluginsModuleHandler"),this.supportedFeatures=r.supportedfeatures,null!=i&&i.jsResult&&i.jsResult.supportsFeature&&(this.supportsFeature=e=>i.jsResult.supportsFeature(e))}getData(e,t,n,i){var s=this;return(0,r.A)((function*(){var n,o,l;const a=e.modicon||(null===(n=s.handlerSchema.displaydata)||void 0===n?void 0:n.icon);if(s.shouldOnlyDisplayDescription(e,i)){var d;const t=e.description;return e.description="",{icon:z.CoreCourse.getModuleIconSrc(e.modname,a),title:t||"",a11yTitle:"",class:null===(d=s.handlerSchema.displaydata)||void 0===d?void 0:d.class}}const u=!(!s.handlerSchema.offlinefunctions||!Object.keys(s.handlerSchema.offlinefunctions).length),c=s.handlerSchema.downloadbutton,g={title:e.name,icon:z.CoreCourse.getModuleIconSrc(e.modname,a),class:null===(o=s.handlerSchema.displaydata)||void 0===o?void 0:o.class,showDownloadButton:void 0!==c?c:u,hasCustomCmListItem:null!==(l=s.handlerSchema.hascustomcmlistitem)&&void 0!==l&&l};if(s.handlerSchema.method&&(g.action=function(){var e=(0,r.A)((function*(e,t,n,r){e.preventDefault(),e.stopPropagation(),yield s.openActivityPage(t,n,r)}));return function(t,n,r,i){return e.apply(this,arguments)}}()),i&&s.handlerSchema.coursepagemethod&&!J.CoreCourseHelper.isModuleStealth(e)){const n=s.handlerSchema.coursepagemethod;s.loadCoursePageTemplate(e,t,g,n),R.z.on(W.Vs,(r=>{r.cmId===e.id&&s.loadCoursePageTemplate(e,t,g,n,!r.alreadyFetched)}))}return g}))()}shouldOnlyDisplayDescription(e,t){if(t&&this.handlerSchema.coursepagemethod)return!1;const n=this.supportsNoViewLink();return void 0!==n?n:"noviewlink"in e&&!!e.noviewlink}supportsNoViewLink(){var e;return this.supportsFeature?this.supportsFeature(q.CoreConstants.FEATURE_NO_VIEW_LINK):null===(e=this.supportedFeatures)||void 0===e?void 0:e[q.CoreConstants.FEATURE_NO_VIEW_LINK]}loadCoursePageTemplate(e,t,n,i,s){var o=this;return(0,r.A)((function*(){n.loading=!0;const r={courseid:t,cmid:e.id};s&&(yield k.g.ignoreErrors(O.CoreSitePlugins.invalidateContent(o.plugin.component,i,r)));try{var l,a;const t=yield O.CoreSitePlugins.getContent(o.plugin.component,i,r);n.title=null!==(l=null===(a=t.templates[0])||void 0===a?void 0:a.html)&&void 0!==l?l:"",e.description=""}catch(e){o.logger.error("Error calling course page method:",e)}finally{n.loading=!1}}))()}getMainComponent(){return(0,r.A)((function*(){const{CoreSitePluginsModuleIndexComponent:e}=yield n.e(2076).then(n.bind(n,71930));return e}))()}manualCompletionAlwaysShown(e){var t=this;return(0,r.A)((function*(){var n;return void 0!==t.handlerSchema.manualcompletionalwaysshown?t.handlerSchema.manualcompletionalwaysshown:!(null===(n=t.initResult)||void 0===n||!n.jsResult||!t.initResult.jsResult.manualCompletionAlwaysShown)&&t.initResult.jsResult.manualCompletionAlwaysShown(e)}))()}openActivityPage(e,t,n){return(0,r.A)((function*(){z.CoreCourse.moduleHasView(e)&&((n=n||{}).params=n.params||{},Object.assign(n.params,{title:e.name,module:e}),B.CoreNavigator.navigateToSitePath(`siteplugins/module/${t}/${e.id}`,n))}))()}}var G=n(38911);class CoreSitePluginsModulePrefetchHandler extends G.CoreCourseActivityPrefetchHandlerBase{constructor(e,t,n,r){if(super(),this.handlerSchema=r,this.component=e,this.name=t,this.modName=n,this.isResource=!!r.isresource,r.updatesnames)try{this.updatesNames=new RegExp(r.updatesnames)}catch(e){}}download(e,t,n){const r=A.CoreSites.getCurrentSiteId();return this.prefetchPackage(e,t,(r=>this.downloadPrefetchPlugin(e,t,!1,n,r)),r)}downloadPrefetchPlugin(e,t,n,i,s){var o=this;return(0,r.A)((function*(){const r=yield A.CoreSites.getSite(s),l={courseid:t,cmid:e.id,userid:r.getUserId()};yield Promise.all([o.downloadOrPrefetchFiles(r.getId(),e,t,n,i),O.CoreSitePlugins.prefetchFunctions(o.component,l,o.handlerSchema,t,e,n,i,r)])}))()}downloadOrPrefetchFiles(e,t,n,i,s){var o=this;return(0,r.A)((function*(){yield o.loadContents(t,n,!0);const r=yield o.getIntroFiles(t,n),l=o.getContentDownloadableFiles(t);s?yield Promise.all([P.CoreFilepool.downloadOrPrefetchFiles(e,r,i,!1,o.component,t.id),P.CoreFilepool.downloadOrPrefetchFiles(e,l,i,!1,o.component,t.id,s)]):yield P.CoreFilepool.downloadOrPrefetchFiles(e,r.concat(l),i,!1,o.component,t.id)}))()}getDownloadSize(){return(0,r.A)((function*(){return{size:-1,total:!1}}))()}invalidateContent(e,t){var n=this;return(0,r.A)((function*(){const r=A.CoreSites.getCurrentSite();if(!r)return;const i=[],s=r.getId(),o={courseid:t,cmid:e,userid:r.getUserId()};i.push(P.CoreFilepool.invalidateFilesByComponent(s,n.component,e)),i.push(z.CoreCourse.invalidateModule(e,s));for(const e in n.handlerSchema.offlinefunctions)r.wsAvailable(e)?i.push(r.invalidateWsCacheForKey(O.CoreSitePlugins.getCallWSCacheKey(e,o))):i.push(O.CoreSitePlugins.invalidateContent(n.component,e,o,s));return k.g.allPromises(i)}))()}isEnabled(){return(0,r.A)((function*(){return!0}))()}loadContents(e,t,n){var i=this;return(0,r.A)((function*(){if(i.isResource)return z.CoreCourse.loadModuleContents(e,t,void 0,!1,n)}))()}prefetch(e,t,n,r){return this.prefetchPackage(e,t,(n=>this.downloadPrefetchPlugin(e,t,!0,r,n)))}}var K=n(32016),Y=n(11684);class CoreSitePluginsQuestionBehaviourHandler extends K.o{constructor(e,t,n){super(),this.name=e,this.type=t,this.hasTemplate=n}handleQuestion(){if(this.hasTemplate)return[Y.CoreSitePluginsQuestionBehaviourComponent]}}var X=n(21457);class CoreSitePluginsQuestionHandler extends X.b{constructor(e,t){super(),this.name=e,this.type=t}getComponent(){return(0,r.A)((function*(){const{CoreSitePluginsQuestionComponent:e}=yield n.e(2076).then(n.bind(n,55792));return e}))()}}var Z=n(96350);class CoreSitePluginsQuizAccessRuleHandler{constructor(e,t,n){this.name=e,this.ruleName=t,this.hasTemplate=n}isEnabled(){return(0,r.A)((function*(){return!0}))()}isPreflightCheckRequired(){return this.hasTemplate}getFixedPreflightData(){}getPreflightComponent(){if(this.hasTemplate)return Z.CoreSitePluginsQuizAccessRuleComponent}notifyPreflightCheckPassed(){}notifyPreflightCheckFailed(){}shouldShowTimeLeft(){return!1}}class CoreSitePluginsSettingsHandler extends CoreSitePluginsBaseHandler{constructor(e,t,n,r,i){super(e),this.title=t,this.plugin=n,this.handlerSchema=r,this.initResult=i,this.priority=r.priority||0}getDisplayData(){var e,t;return{title:this.title,icon:null===(e=this.handlerSchema.displaydata)||void 0===e?void 0:e.icon,class:null===(t=this.handlerSchema.displaydata)||void 0===t?void 0:t.class,page:`siteplugins/content/${this.plugin.component}/${this.handlerSchema.method}/0`,params:{title:this.title,initResult:this.initResult,ptrEnabled:this.handlerSchema.ptrenabled}}}}class CoreSitePluginsUserProfileHandler extends CoreSitePluginsBaseHandler{constructor(e,t,n,r,i){super(e),this.title=t,this.plugin=n,this.handlerSchema=r,this.initResult=i,this.priority=r.priority||0,this.type=r.type&&r.type!==v.CoreUserProfileHandlerType.LIST_ACCOUNT_ITEM?r.type:v.CoreUserProfileHandlerType.LIST_ITEM}isEnabledForContext(e,t){var n=this;return(0,r.A)((function*(){var e;return O.CoreSitePlugins.isHandlerEnabledForCourse(t,n.handlerSchema.restricttoenrolledcourses,null===(e=n.initResult)||void 0===e?void 0:e.restrict)}))()}isEnabledForUser(e){var t=this;return(0,r.A)((function*(){var n;return O.CoreSitePlugins.isHandlerEnabledForUser(e.id,t.handlerSchema.restricttocurrentuser,null===(n=t.initResult)||void 0===n?void 0:n.restrict)}))()}getDisplayData(){var e,t;return{title:this.title,icon:null===(e=this.handlerSchema.displaydata)||void 0===e?void 0:e.icon,class:null===(t=this.handlerSchema.displaydata)||void 0===t?void 0:t.class,action:(e,t,n,r)=>{e.preventDefault(),e.stopPropagation();const i={courseid:r,userid:t.id},s=N.VV.hashAsciiStr(JSON.stringify(i));B.CoreNavigator.navigateToSitePath(`siteplugins/content/${this.plugin.component}/${this.handlerSchema.method}/${s}`,{params:{title:this.title,args:i,initResult:this.initResult,ptrEnabled:this.handlerSchema.ptrenabled}})}}}setInitResult(e){var t;this.initResult=e,null===(t=this.updatingDefer)||void 0===t||t.resolve(),delete this.updatingDefer}updatingInit(){this.updatingDefer=new V._}}class CoreSitePluginsUserProfileFieldHandler extends CoreSitePluginsBaseHandler{constructor(e,t){super(e),this.type=t}getComponent(){return(0,r.A)((function*(){const{CoreSitePluginsUserProfileFieldComponent:e}=yield n.e(2076).then(n.bind(n,44940));return e}))()}getData(e,t,n,i){return(0,r.A)((function*(){const t="profile_field_"+e.shortname;return{type:("type"in e?e.type:e.datatype)||"",name:t,value:i[t]}}))()}}var ee=n(17847);class CoreSitePluginsMainMenuHomeHandler extends CoreSitePluginsBaseHandler{constructor(e,t,n,r,i){super(e),this.title=t,this.plugin=n,this.handlerSchema=r,this.initResult=i,this.priority=r.priority||0}getDisplayData(){var e;return{title:this.title,class:null===(e=this.handlerSchema.displaydata)||void 0===e?void 0:e.class,page:`siteplugins/homecontent/${this.plugin.component}/${this.handlerSchema.method}`,pageParams:{title:this.title,initResult:this.initResult,ptrEnabled:this.handlerSchema.ptrenabled}}}}var te=n(65964);class CoreSitePluginsWorkshopAssessmentStrategyHandler extends CoreSitePluginsBaseHandler{constructor(e,t){super(e),this.name=e,this.strategyName=t}getComponent(){return(0,r.A)((function*(){const{CoreSitePluginsWorkshopAssessmentStrategyComponent:e}=yield n.e(6232).then(n.bind(n,56232));return e}))()}getOriginalValues(){return(0,r.A)((function*(){return[]}))()}hasDataChanged(){return!1}isEnabled(){return(0,r.A)((function*(){return!0}))()}prepareAssessmentData(){return(0,r.A)((function*(){return{}}))()}}var ne=n(30260),re=n(33504),ie=n(85720),se=n(58364),oe=n(8014),le=n(8756),ae=n(59656);class CoreSitePluginsEnrolHandler extends CoreSitePluginsBaseHandler{constructor(e,t,n,r,i){super(e),this.type=t,this.enrolmentAction=n,this.handlerSchema=r,this.initResult=i,this.logger=I.CoreLogger.getInstance("CoreSitePluginsEnrolHandler")}getInfoIcons(){var e=this;return(0,r.A)((function*(){var t;return null!==(t=e.handlerSchema.infoIcons)&&void 0!==t?t:[]}))()}invalidate(){return(0,r.A)((function*(){}))()}enrol(){return(0,r.A)((function*(){return!1}))()}canAccess(){return(0,r.A)((function*(){return{canAccess:!1}}))()}validateAccess(){return(0,r.A)((function*(){return!1}))()}}var de=n(9538);let ue=(()=>{var e;class CoreSitePluginsInitService{constructor(){this.logger=I.CoreLogger.getInstance("CoreSitePluginsInit"),this.courseRestrictHandlers={}}init(){var e=this;R.z.on(R.z.LOGIN,function(){var t=(0,r.A)((function*(t){try{const n=yield k.g.ignoreErrors(O.CoreSitePlugins.getPlugins(t.siteId));if(t.siteId!==A.CoreSites.getCurrentSiteId()||null==n||!n.length)return;try{yield e.loadSitePlugins(n)}finally{R.z.trigger(R.z.SITE_PLUGINS_LOADED,{},t.siteId)}}catch(t){e.logger.error(t)}finally{O.CoreSitePlugins.setPluginsFetched()}}));return function(e){return t.apply(this,arguments)}}()),R.z.on(de.CORE_COURSES_MY_COURSES_CHANGED_EVENT,(e=>{e.siteId&&e.siteId===A.CoreSites.getCurrentSiteId()&&e.added.length&&this.reloadCourseRestrictHandlers()}))}downloadStyles(e,t,n,i){return(0,r.A)((function*(){var r,s,o;const l=yield A.CoreSites.getSite(i);let a=null===(r=n.styles)||void 0===r?void 0:r.url;a&&!oe.F.isAbsoluteURL(a)&&(a=le.$.concatenatePaths(l.getURL(),a)),a&&null!==(s=n.styles)&&void 0!==s&&s.version&&(a+=(-1!=a.indexOf("?")?"&":"?")+"version="+n.styles.version);const d=O.CoreSitePlugins.getHandlerUniqueName(e,t)+"#main",u=yield k.g.ignoreErrors(P.CoreFilepool.getFilesByComponent(l.getId(),W.$k,d));if(null==u||u.forEach((e=>{e.url!==a&&k.g.ignoreErrors(P.CoreFilepool.removeFileByUrl(l.getId(),e.url))})),!a)return"";n.styles&&(n.styles.url=a);const c=yield P.CoreFilepool.downloadUrl(l.getId(),a,!1,W.$k,d,0,void 0,void 0,void 0,null===(o=n.styles)||void 0===o?void 0:o.version);return D.CoreWS.getText(c)}))()}executeHandlerInit(e,t){var n=this;return(0,r.A)((function*(){return t.init?n.executeMethodAndJS(e,t.init,!0):null}))()}executeMethodAndJS(e,t,n){return(0,r.A)((function*(){const r=A.CoreSites.getCurrentSiteId(),i={getFromCache:!1,deleteCacheIfWSError:n},s=yield O.CoreSitePlugins.getContent(e.component,t,{},i);if(!s.javascript||A.CoreSites.getCurrentSiteId()!=r)return s;const o={HANDLER_DISABLED:CoreSitePluginsInitService.HANDLER_DISABLED};yield u.V.loadLibraries(),u.V.injectLibraries(o);const l=O.CoreSitePlugins.createDataForJS(s);for(const e in l)o[e]=l[e];return s.jsResult=u.V.executeJavascript(o,s.javascript),s.jsResult===CoreSitePluginsInitService.HANDLER_DISABLED&&(s.disabled=!0),s}))()}getPrefixForStrings(e){return e?"plugin."+e+".":""}getPrefixedString(e,t="pluginname"){return this.getPrefixForStrings(e)+t}loadLangStrings(e){if(e.parsedLang)for(const t in e.parsedLang){const n=this.getPrefixForStrings(e.addon);H.CoreLang.addSitePluginsStrings(t,e.parsedLang[t],n)}}loadSitePlugin(e){var t=this;return(0,r.A)((function*(){if(t.logger.debug("Load site plugin:",e),!e.parsedHandlers&&e.handlers&&(e.parsedHandlers=b.Ni.parseJSON(e.handlers,null,(e=>t.logger.error("Error parsing site plugin handlers",e)))),!e.parsedLang&&e.lang&&(e.parsedLang=b.Ni.parseJSON(e.lang,null,(e=>t.logger.error("Error parsing site plugin lang",e)))),O.CoreSitePlugins.setPluginsLoaded(!0),t.loadLangStrings(e),e.parsedHandlers){const n=e.parsedHandlers;yield k.g.allPromises(Object.keys(n).map(function(){var i=(0,r.A)((function*(r){yield t.registerHandler(e,r,n[r])}));return function(e){return i.apply(this,arguments)}}()))}}))()}loadSitePlugins(e){var t=this;return(0,r.A)((function*(){t.courseRestrictHandlers={},yield k.g.allPromises(e.map(function(){var e=(0,r.A)((function*(e){const n=t.loadSitePlugin(e);O.CoreSitePlugins.registerSitePluginPromise(e.component,n),yield n}));return function(t){return e.apply(this,arguments)}}()))}))()}loadStyles(e,t,n,r,i,s){s=s||A.CoreSites.getCurrentSiteId();const o=document.createElement("style"),l=O.CoreSitePlugins.getHandlerUniqueName(e,t);o.setAttribute("id","siteplugin-"+l),o.innerHTML=r;let a=null;Array.from(document.head.querySelectorAll("style")).forEach((e=>{/^siteplugin-/.test(e.id)&&e.id>o.id&&(null===a||e.id<a.id)&&(a=e)})),a?document.head.insertBefore(o,a):document.head.appendChild(o),k.g.ignoreErrors(P.CoreFilepool.treatCSSCode(s,n,r,W.$k,l,i))}registerHandler(e,t,n){var i=this;return(0,r.A)((function*(){const r=A.CoreSites.getCurrentSiteId();try{var s;const[o,l]=yield Promise.all([i.executeHandlerInit(e,n),i.downloadStyles(e,t,n,r).catch((e=>{i.logger.error("Error getting styles for plugin",t,n,e)}))]);if(null!=o&&o.disabled)return i.logger.warn("Handler disabled by init function",e,n),void 0;let a;switch(l&&null!==(s=n.styles)&&void 0!==s&&s.url&&i.loadStyles(e,t,n.styles.url,l,n.styles.version,r),n.delegate){case"CoreMainMenuDelegate":a=i.registerMainMenuHandler(e,t,n,o);break;case"CoreCourseModuleDelegate":a=i.registerModuleHandler(e,t,n,o);break;case"CoreUserDelegate":a=i.registerUserProfileHandler(e,t,n,o);break;case"CoreCourseOptionsDelegate":a=i.registerCourseOptionHandler(e,t,n,o);break;case"CoreCourseFormatDelegate":a=i.registerCourseFormatHandler(e,t,n);break;case"CoreUserProfileFieldDelegate":a=yield i.registerUserProfileFieldHandler(e,t,n);break;case"CoreSettingsDelegate":a=i.registerSettingsHandler(e,t,n,o);break;case"CoreQuestionDelegate":a=yield i.registerQuestionHandler(e,t,n);break;case"CoreQuestionBehaviourDelegate":a=yield i.registerQuestionBehaviourHandler(e,t,n);break;case"CoreBlockDelegate":a=i.registerBlockHandler(e,t,n,o);break;case"AddonMessageOutputDelegate":a=i.registerMessageOutputHandler(e,t,n,o);break;case"AddonModQuizAccessRuleDelegate":a=yield i.registerQuizAccessRuleHandler(e,t,n);break;case"AddonModAssignFeedbackDelegate":a=yield i.registerAssignFeedbackHandler(e,t,n);break;case"AddonModAssignSubmissionDelegate":a=yield i.registerAssignSubmissionHandler(e,t,n);break;case"AddonWorkshopAssessmentStrategyDelegate":a=yield i.registerWorkshopAssessmentStrategyHandler(e,t,n);break;case"CoreMainMenuHomeDelegate":a=i.registerMainMenuHomeHandler(e,t,n,o);break;case"CoreEnrolDelegate":a=yield i.registerEnrolHandler(e,t,n,o)}a&&O.CoreSitePlugins.setSitePluginHandler(a,{plugin:e,handlerName:t,handlerSchema:n,initResult:o})}catch(e){throw new a.CoreError("Error executing init method "+n.init+": "+e.message)}}))()}registerComponentInitHandler(e,t,n,i,s){var o=this;return(0,r.A)((function*(){if(!n.method)return o.logger.warn("Ignore site plugin because it doesn't provide method",e,n),void 0;o.logger.debug("Register site plugin",e,n);try{const r=yield o.executeMethodAndJS(e,n.method),l=O.CoreSitePlugins.getHandlerUniqueName(e,t),a=s(l,r);if(n.methodTemplates=r.templates,n.methodJSResult=r.jsResult,n.methodOtherdata=r.otherdata,r.jsResult){const e=r.jsResult,t=se.T.getAllPropertyNames(a);for(const n of t)"constructor"!==n&&"function"==typeof a[n]&&"function"==typeof e[n]&&(a[n]=e[n].bind(a))}return i.registerHandler(a),l}catch(t){o.logger.error("Error executing main method",e.component,n.method,t)}}))()}registerAssignFeedbackHandler(e,t,n){return this.registerComponentInitHandler(e,t,n,s.AddonModAssignFeedbackDelegate.instance,(t=>{const r=(n.moodlecomponent||e.component).replace("assignfeedback_",""),i=this.getPrefixForStrings(e.addon);return new CoreSitePluginsAssignFeedbackHandler(t,r,i)}))}registerAssignSubmissionHandler(e,t,n){return this.registerComponentInitHandler(e,t,n,o.AddonModAssignSubmissionDelegate.instance,(t=>{const r=(n.moodlecomponent||e.component).replace("assignsubmission_",""),i=this.getPrefixForStrings(e.addon);return new CoreSitePluginsAssignSubmissionHandler(t,r,i)}))}registerBlockHandler(e,t,n,r){var i;const s=O.CoreSitePlugins.getHandlerUniqueName(e,t),o=(n.moodlecomponent||e.component).replace("block_",""),l=null===(i=n.displaydata)||void 0===i?void 0:i.title,a=this.getPrefixedString(e.addon,l);return d.CoreBlockDelegate.registerHandler(new CoreSitePluginsBlockHandler(s,a,o,n,r)),s}registerCourseFormatHandler(e,t,n){this.logger.debug("Register site plugin in course format delegate:",e,n);const r=O.CoreSitePlugins.getHandlerUniqueName(e,t),i=(n.moodlecomponent||e.component).replace("format_","");return g.CoreCourseFormatDelegate.registerHandler(new CoreSitePluginsCourseFormatHandler(r,i,n)),r}registerCourseOptionHandler(e,t,n,r){var i;if(!n.displaydata)return this.logger.warn("Ignore site plugin because it doesn't provide displaydata",e,n),void 0;this.logger.debug("Register site plugin in course option delegate:",e,n,r);const s=O.CoreSitePlugins.getHandlerUniqueName(e,t),o=this.getPrefixedString(e.addon,n.displaydata.title),l=new CoreSitePluginsCourseOptionHandler(s,o,e,n,r);return c.CoreCourseOptionsDelegate.registerHandler(l),null!=r&&null!==(i=r.restrict)&&void 0!==i&&i.courses&&(this.courseRestrictHandlers[s]={plugin:e,handlerName:t,handlerSchema:n,handler:l}),s}registerEnrolHandler(e,t,n,i){var s=this;return(0,r.A)((function*(){var r;const o=O.CoreSitePlugins.getHandlerUniqueName(e,t),l=(n.moodlecomponent||e.component).replace("enrol_",""),a=null!==(r=n.enrolmentAction)&&void 0!==r?r:ae.CoreEnrolAction.BROWSER,d=new CoreSitePluginsEnrolHandler(o,l,a,n,i);if(!n.method&&(a===ae.CoreEnrolAction.SELF||a===ae.CoreEnrolAction.GUEST))return s.logger.error('"self" or "guest" enrol plugins must implement a method to override the required JS functions.'),void 0;if(n.method){var u,c,g;const t=yield s.executeMethodAndJS(e,n.method);if(a===ae.CoreEnrolAction.SELF&&(null===(u=t.jsResult)||void 0===u||!u.enrol))return s.logger.error('"self" enrol plugins must implement an "enrol" function in the JS returned by the method.'),void 0;if(!(a!==ae.CoreEnrolAction.GUEST||null!==(c=t.jsResult)&&void 0!==c&&c.canAccess&&null!==(g=t.jsResult)&&void 0!==g&&g.validateAccess))return s.logger.error('"guest" enrol plugins must implement "canAccess" and "validateAccess" functions in the JS returned by the method.'),void 0;if(t.jsResult){const e=t.jsResult,n=se.T.getAllPropertyNames(d);for(const t of n)"constructor"!==t&&"function"==typeof d[t]&&"function"==typeof e[t]&&(d[t]=e[t].bind(d))}}return ae.CoreEnrolDelegate.registerHandler(d),o}))()}registerMainMenuHandler(e,t,n,r){if(!n.displaydata)return this.logger.warn("Ignore site plugin because it doesn't provide displaydata",e,n),void 0;this.logger.debug("Register site plugin in main menu delegate:",e,n,r);const i=O.CoreSitePlugins.getHandlerUniqueName(e,t),s=this.getPrefixedString(e.addon,n.displaydata.title);return m.CoreMainMenuDelegate.registerHandler(new CoreSitePluginsMainMenuHandler(i,s,e,n,r)),i}registerMessageOutputHandler(e,t,n,r){if(!n.displaydata)return this.logger.warn("Ignore site plugin because it doesn't provide displaydata",e,n),void 0;this.logger.debug("Register site plugin in message output delegate:",e,n,r);const s=O.CoreSitePlugins.getHandlerUniqueName(e,t),o=this.getPrefixedString(e.addon,n.displaydata.title),l=(n.moodlecomponent||e.component).replace("message_","");return i.AddonMessageOutputDelegate.registerHandler(new CoreSitePluginsMessageOutputHandler(s,l,o,e,n,r)),s}registerModuleHandler(e,t,n,r){if(!n.displaydata)return this.logger.warn("Ignore site plugin because it doesn't provide displaydata",e,n),void 0;this.logger.debug("Register site plugin in module delegate:",e,n,r);const i=O.CoreSitePlugins.getHandlerUniqueName(e,t),s=(n.moodlecomponent||e.component).replace("mod_",""),o=new CoreSitePluginsModuleHandler(i,s,e,n,r);if(h.CoreCourseModuleDelegate.registerHandler(o),O.CoreSitePlugins.setModuleHandlerInstance(s,o),n.offlinefunctions&&Object.keys(n.offlinefunctions).length&&p.CoreCourseModulePrefetchDelegate.registerHandler(new CoreSitePluginsModulePrefetchHandler(e.component,i,s,n)),!o.supportsNoViewLink()&&n.method&&!n.nolinkhandlers){const e=new ne.CoreContentLinksModuleIndexHandler(i,s);e.name=i+"_indexlink",e.priority=-1,re.CoreContentLinksDelegate.registerHandler(e);const t=new ie.S(i,s);t.name=i+"_listlink",t.priority=-1,re.CoreContentLinksDelegate.registerHandler(t)}return i}registerQuestionHandler(e,t,n){const r=n.moodlecomponent||e.component;return this.registerComponentInitHandler(e,t,n,C.CoreQuestionDelegate.instance,(e=>new CoreSitePluginsQuestionHandler(e,r)))}registerQuestionBehaviourHandler(e,t,n){return this.registerComponentInitHandler(e,t,n,S.CoreQuestionBehaviourDelegate.instance,((t,r)=>{const i=(n.moodlecomponent||e.component).replace("qbehaviour_","");return new CoreSitePluginsQuestionBehaviourHandler(t,i,!!r.templates.length)}))}registerQuizAccessRuleHandler(e,t,n){const r=n.moodlecomponent||e.component;return this.registerComponentInitHandler(e,t,n,l.AddonModQuizAccessRuleDelegate.instance,((e,t)=>new CoreSitePluginsQuizAccessRuleHandler(e,r,!!t.templates.length)))}registerSettingsHandler(e,t,n,r){if(!n.displaydata)return this.logger.warn("Ignore site plugin because it doesn't provide displaydata",e,n),void 0;this.logger.debug("Register site plugin in settings delegate:",e,n,r);const i=O.CoreSitePlugins.getHandlerUniqueName(e,t),s=this.getPrefixedString(e.addon,n.displaydata.title);return f.CoreSettingsDelegate.registerHandler(new CoreSitePluginsSettingsHandler(i,s,e,n,r)),i}registerUserProfileHandler(e,t,n,r){if(!n.displaydata)return this.logger.warn("Ignore site plugin because it doesn't provide displaydata",e,n),void 0;this.logger.debug("Register site plugin in user profile delegate:",e,n,r);const i=O.CoreSitePlugins.getHandlerUniqueName(e,t),s=this.getPrefixedString(e.addon,n.displaydata.title),o=new CoreSitePluginsUserProfileHandler(i,s,e,n,r);return v.CoreUserDelegate.registerHandler(o),r&&r.restrict&&r.restrict.courses&&(this.courseRestrictHandlers[i]={plugin:e,handlerName:t,handlerSchema:n,handler:o}),i}registerUserProfileFieldHandler(e,t,n){return this.registerComponentInitHandler(e,t,n,y.CoreUserProfileFieldDelegate.instance,(t=>{const r=(n.moodlecomponent||e.component).replace("profilefield_","");return new CoreSitePluginsUserProfileFieldHandler(t,r)}))}registerWorkshopAssessmentStrategyHandler(e,t,n){return this.registerComponentInitHandler(e,t,n,te.AddonWorkshopAssessmentStrategyDelegate.instance,(t=>{const r=(n.moodlecomponent||e.component).replace("workshopform_","");return new CoreSitePluginsWorkshopAssessmentStrategyHandler(t,r)}))}reloadCourseRestrictHandlers(){var e=this;return(0,r.A)((function*(){Object.keys(e.courseRestrictHandlers).length&&(yield Promise.all(Object.keys(e.courseRestrictHandlers).map(function(){var t=(0,r.A)((function*(t){const n=e.courseRestrictHandlers[t];if(n.handler&&n.handler.setInitResult){n.handler.updatingInit&&n.handler.updatingInit();try{const t=yield e.executeHandlerInit(n.plugin,n.handlerSchema);n.handler.setInitResult(t)}catch(t){e.logger.error("Error reloading course restrict handler",t,n.plugin)}}}));return function(e){return t.apply(this,arguments)}}())),R.z.trigger(R.z.SITE_PLUGINS_COURSE_RESTRICT_UPDATED,{}))}))()}registerMainMenuHomeHandler(e,t,n,r){if(!n.displaydata)return this.logger.warn("Ignore site plugin because it doesn't provide displaydata",e,n),void 0;this.logger.debug("Register site plugin in main menu home delegate:",e,n,r);const i=O.CoreSitePlugins.getHandlerUniqueName(e,t),s=this.getPrefixedString(e.addon,n.displaydata.title);return ee.CoreMainMenuHomeDelegate.registerHandler(new CoreSitePluginsMainMenuHomeHandler(i,s,e,n,r)),i}}return(e=CoreSitePluginsInitService).HANDLER_DISABLED="core_site_plugins_helper_handler_disabled",e.ɵfac=function CoreSitePluginsInitService_Factory(t){return new(t||e)},e.ɵprov=T.jDH({token:e,factory:e.ɵfac,providedIn:"root"}),CoreSitePluginsInitService})();const ce=(0,w.Qd)(ue)}}]);