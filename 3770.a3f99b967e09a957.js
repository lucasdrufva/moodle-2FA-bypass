"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[3770],{3770:(e,o,s)=>{s.r(o),s.d(o,{AddonModWorkshopPrefetchHandler:()=>y,AddonModWorkshopPrefetchHandlerLazyService:()=>g});var r=s(10467),i=s(44682),d=s(66110),t=s(98870),n=s(88793),a=s(15221),c=s(52749),l=s(58364),h=s(79555),p=s(67193),u=s(80178),f=s(36553),m=s(34751),k=s(55554),A=s(54438);let g=(()=>{var e;class AddonModWorkshopPrefetchHandlerLazyService extends m.w{getFiles(e,o){var s=this;return(0,r.A)((function*(){return(yield s.getWorkshopInfoHelper(e,o,{omitFail:!0})).files}))()}getWorkshopInfoHelper(e,o,s={}){var i=this;return(0,r.A)((function*(){var d;let t,n,l=[],h=[];const f={cmId:e.id,...s},m=yield c.CoreSites.getSite(s.siteId);s.siteId=null!==(d=s.siteId)&&void 0!==d?d:m.getId();const k=m.getUserId();try{t=yield p.AddonModWorkshop.getWorkshop(o,e.id,s)}catch(e){if(s.omitFail)return{groups:[],files:[]};throw e}try{if(h=i.getIntroFilesFromInstance(e,t),h=h.concat(t.instructauthorsfiles||[]).concat(t.instructreviewersfiles||[]),n=yield p.AddonModWorkshop.getWorkshopAccessInformation(t.id,f),n.canviewallsubmissions){const o=yield a.CoreGroups.getActivityGroupInfo(e.id,!1,void 0,s.siteId);o.groups&&0!=o.groups.length||(o.groups=[{id:0,name:""}]),l=o.groups}const o=yield p.AddonModWorkshop.getUserPlanPhases(t.id,f),d=u.AddonModWorkshopHelper.canSubmit(t,n,o[20].tasks),c=u.AddonModWorkshopHelper.canAssess(t,n),m=[];return d&&m.push(u.AddonModWorkshopHelper.getUserSubmission(t.id,{userId:k,cmId:e.id}).then((e=>{e&&(h=h.concat(e.contentfiles||[]).concat(e.attachmentfiles||[]))}))),n.canviewallsubmissions&&t.phase>=20&&m.push(p.AddonModWorkshop.getSubmissions(t.id,f).then(function(){var o=(0,r.A)((function*(o){yield Promise.all(o.map(function(){var o=(0,r.A)((function*(o){h=h.concat(o.contentfiles||[]).concat(o.attachmentfiles||[]);const s=yield p.AddonModWorkshop.getSubmissionAssessments(t.id,o.id,{cmId:e.id});s.forEach((e=>{h=h.concat(e.feedbackattachmentfiles).concat(e.feedbackcontentfiles)})),t.phase>=30&&c&&(yield Promise.all(s.map((e=>u.AddonModWorkshopHelper.getReviewerAssessmentById(t.id,e.id)))))}));return function(e){return o.apply(this,arguments)}}()))}));return function(e){return o.apply(this,arguments)}}())),t.phase>=30&&c&&m.push(u.AddonModWorkshopHelper.getReviewerAssessments(t.id,f).then((e=>{e.forEach((e=>{h=h.concat(e.feedbackattachmentfiles).concat(e.feedbackcontentfiles)}))}))),yield Promise.all(m),{workshop:t,groups:l,files:h.filter((e=>void 0!==e))}}catch(e){if(s.omitFail)return{workshop:t,groups:l,files:h.filter((e=>void 0!==e))};throw e}}))()}invalidateContent(e,o){return(0,r.A)((function*(){yield p.AddonModWorkshop.invalidateContent(e,o)}))()}isDownloadable(e,o){return(0,r.A)((function*(){const s=yield p.AddonModWorkshop.getWorkshop(o,e.id,{readingStrategy:1});return(yield p.AddonModWorkshop.getWorkshopAccessInformation(s.id,{cmId:e.id})).canswitchphase||s.phase>10}))()}prefetch(e,o){return this.prefetchPackage(e,o,(s=>this.prefetchWorkshop(e,o,s)))}getAllGradesReport(e,o,s,i){return(0,r.A)((function*(){const r=[];o.forEach((o=>{r.push(p.AddonModWorkshop.fetchAllGradeReports(e,{groupId:o.id,cmId:s,siteId:i}))}));const d=yield Promise.all(r),t={};return d.forEach((e=>{e.forEach((e=>{e.submissionid&&(t[e.submissionid]=e)}))})),l.T.toArray(t)}))()}prefetchWorkshop(e,o,s){var a=this;return(0,r.A)((function*(){const l=[],h={readingStrategy:2,siteId:s},f={cmId:e.id,...h},m=(yield c.CoreSites.getSite(s)).getUserId(),A=yield a.getWorkshopInfoHelper(e,o,h);if(!A.workshop)return;const g=A.workshop,y=[],v=[];y.push(n.CoreFilepool.addFilesToQueue(s,A.files,a.component,e.id)),y.push(p.AddonModWorkshop.getWorkshopAccessInformation(g.id,f).then(function(){var o=(0,r.A)((function*(o){const i=yield p.AddonModWorkshop.getUserPlanPhases(g.id,f),d=u.AddonModWorkshopHelper.canSubmit(g,o,i[20].tasks),t=u.AddonModWorkshopHelper.canAssess(g,o),c=[];d&&(c.push(p.AddonModWorkshop.getSubmissions(g.id,f)),l.push(m));let h=Promise.resolve();o.canviewallsubmissions&&g.phase>=20&&(h=a.getAllGradesReport(g.id,A.groups,e.id,s).then((e=>{e.forEach((e=>{l.push(e.userid),e.submissiongradeoverby&&l.push(e.submissiongradeoverby),e.reviewedby&&e.reviewedby.forEach((e=>{l.push(e.userid),v[e.assessmentid]=e.assessmentid})),e.reviewerof&&e.reviewerof.forEach((e=>{l.push(e.userid),v[e.assessmentid]=e.assessmentid}))}))}))),g.phase>=30&&t&&(h=h.finally((0,r.A)((function*(){const o=yield u.AddonModWorkshopHelper.getReviewerAssessments(g.id,{userId:m,cmId:e.id,siteId:s});let r=[];o.forEach((e=>{var o,s,i;(null===(o=e.submission)||void 0===o?void 0:o.authorid)==m&&y.push(p.AddonModWorkshop.getAssessment(g.id,e.id,f)),l.push(e.reviewerid),l.push(e.gradinggradeoverby),v[e.id]=e.id,r=r.concat((null===(s=e.submission)||void 0===s?void 0:s.attachmentfiles)||[]).concat((null===(i=e.submission)||void 0===i?void 0:i.contentfiles)||[])})),yield n.CoreFilepool.addFilesToQueue(s,r,a.component,e.id)})))),h=h.finally((()=>{if(v.length>0)return Promise.all(v.map((e=>p.AddonModWorkshop.getAssessmentForm(g.id,e,f))))})),c.push(h),50==g.phase&&(c.push(p.AddonModWorkshop.getGrades(g.id,f)),o.canviewpublishedsubmissions&&c.push(p.AddonModWorkshop.getSubmissions(g.id,f))),yield Promise.all(c)}));return function(e){return o.apply(this,arguments)}}())),y.push(i.CoreCourse.getModuleBasicInfoByInstance(g.id,"workshop",{siteId:s})),y.push(i.CoreCourse.getModuleBasicGradeInfo(e.id,s)),y.push(k.g.ignoreErrors(d.CoreCourses.getCourseByField("id",o,s))),yield Promise.all(y),yield t.CoreUser.prefetchProfiles(l,o,s)}))()}sync(e,o,s){return(0,r.A)((function*(){return f.AddonModWorkshopSync.syncWorkshop(e.instance,s)}))()}}return(e=AddonModWorkshopPrefetchHandlerLazyService).ɵfac=(()=>{let o;return function AddonModWorkshopPrefetchHandlerLazyService_Factory(s){return(o||(o=A.xGo(e)))(s||e)}})(),e.ɵprov=A.jDH({token:e,factory:e.ɵfac,providedIn:"root"}),AddonModWorkshopPrefetchHandlerLazyService})();const y=(0,h.Qd)(g)}}]);