"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[4078],{84078:(i,e,n)=>{n.r(e),n.d(e,{AddonModWikiIndexComponent:()=>F});var t=n(10467),o=n(75629),d=n(69006),r=n(44682),a=n(41094),s=n(98870),u=n(94455),c=n(15221),l=n(15324),g=n(52749),p=n(89911),k=n(55554),w=n(79555),m=n(49882),h=n(8756),_=n(91768),b=n(67981),f=n(59379),I=n(22357),v=n(51069),S=n(6319),C=n(23039),P=n(54438),y=n(73465),M=n(51024),T=n(60177),A=n(69502),x=n(17388),W=n(16986),O=n(64422),N=n(13988),E=n(19858),D=n(86198),G=n(58197),$=n(66731),j=n(43570),R=n(6736),L=n(30864),Y=n(25367),V=n(73955);const _c0=i=>({"addon-mod_wiki-noedit":i}),_c1=i=>({$a:i});function AddonModWikiIndexComponent_ion_button_1_ion_icon_2_Template(i,e){1&i&&P.nrm(0,"ion-icon",19)}function AddonModWikiIndexComponent_ion_button_1_ion_icon_3_Template(i,e){1&i&&P.nrm(0,"ion-icon",20)}function AddonModWikiIndexComponent_ion_button_1_Template(i,e){if(1&i){const i=P.RV6();P.j41(0,"ion-button",16),P.nI1(1,"translate"),P.bIt("click",(function AddonModWikiIndexComponent_ion_button_1_Template_ion_button_click_0_listener(e){P.eBV(i);const n=P.XpG();return P.Njj(n.showSubwikiPicker(e))})),P.DNE(2,AddonModWikiIndexComponent_ion_button_1_ion_icon_2_Template,1,0,"ion-icon",17)(3,AddonModWikiIndexComponent_ion_button_1_ion_icon_3_Template,1,0,"ion-icon",18),P.k0s()}if(2&i){const i=P.XpG();P.Y8G("ariaLabel",P.bMT(1,3,"addon.mod_wiki.subwiki")),P.R7$(2),P.Y8G("ngIf",!i.groupWiki),P.R7$(),P.Y8G("ngIf",i.groupWiki)}}function AddonModWikiIndexComponent_ion_button_2_Template(i,e){if(1&i){const i=P.RV6();P.j41(0,"ion-button",16),P.nI1(1,"translate"),P.bIt("click",(function AddonModWikiIndexComponent_ion_button_2_Template_ion_button_click_0_listener(){P.eBV(i);const e=P.XpG();return P.Njj(e.openMap())})),P.nrm(2,"ion-icon",21),P.k0s()}2&i&&P.Y8G("ariaLabel",P.bMT(1,1,"addon.mod_wiki.map"))}function AddonModWikiIndexComponent_core_context_menu_item_4_Template(i,e){if(1&i){const i=P.RV6();P.j41(0,"core-context-menu-item",22),P.nI1(1,"translate"),P.bIt("action",(function AddonModWikiIndexComponent_core_context_menu_item_4_Template_core_context_menu_item_action_0_listener(){P.eBV(i);const e=P.XpG();return P.Njj(e.goToEditPage())})),P.k0s()}2&i&&P.Y8G("priority",590)("content",P.bMT(1,2,"core.edit"))}function AddonModWikiIndexComponent_core_context_menu_item_5_Template(i,e){if(1&i){const i=P.RV6();P.j41(0,"core-context-menu-item",23),P.nI1(1,"translate"),P.bIt("action",(function AddonModWikiIndexComponent_core_context_menu_item_5_Template_core_context_menu_item_action_0_listener(){P.eBV(i);const e=P.XpG();return P.Njj(e.goToNewPage())})),P.k0s()}2&i&&P.Y8G("priority",580)("content",P.bMT(1,2,"addon.mod_wiki.createpage"))}function AddonModWikiIndexComponent_Conditional_6_Template(i,e){if(1&i){const i=P.RV6();P.j41(0,"core-context-menu-item",24),P.nI1(1,"translate"),P.bIt("action",(function AddonModWikiIndexComponent_Conditional_6_Template_core_context_menu_item_action_0_listener(){P.eBV(i);const e=P.XpG();return P.Njj(e.openModuleSummary())})),P.k0s()}2&i&&P.Y8G("priority",5e3)("content",P.bMT(1,2,"core.info"))}function AddonModWikiIndexComponent_Conditional_7_Template(i,e){if(1&i){const i=P.RV6();P.j41(0,"ion-button",25),P.nI1(1,"translate"),P.bIt("click",(function AddonModWikiIndexComponent_Conditional_7_Template_ion_button_click_0_listener(){P.eBV(i);const e=P.XpG();return P.Njj(e.openModuleSummary())})),P.nrm(2,"ion-icon",26),P.k0s()}2&i&&P.Y8G("ariaLabel",P.bMT(1,1,"core.info"))}function AddonModWikiIndexComponent_core_course_module_info_9_Template(i,e){if(1&i){const i=P.RV6();P.j41(0,"core-course-module-info",27),P.bIt("completionChanged",(function AddonModWikiIndexComponent_core_course_module_info_9_Template_core_course_module_info_completionChanged_0_listener(){P.eBV(i);const e=P.XpG();return P.Njj(e.onCompletionChange())})),P.k0s()}if(2&i){const i=P.XpG();P.Y8G("module",i.module)("description",i.description)("component",i.component)("componentId",i.componentId)("courseId",i.courseId)}}function AddonModWikiIndexComponent_div_10_ion_card_1_span_4_Template(i,e){if(1&i&&(P.j41(0,"span"),P.EFF(1),P.nI1(2,"translate"),P.k0s()),2&i){const i=P.XpG(3);P.R7$(),P.JRh(P.i5U(2,1,"core.hasdatatosync",P.eq3(4,_c1,i.pageStr)))}}function AddonModWikiIndexComponent_div_10_ion_card_1_span_5_Template(i,e){if(1&i&&(P.j41(0,"span"),P.EFF(1),P.nI1(2,"translate"),P.k0s()),2&i){const i=P.XpG(3);P.R7$(),P.JRh(P.i5U(2,1,"core.hasdatatosync",P.eq3(4,_c1,i.moduleName)))}}function AddonModWikiIndexComponent_div_10_ion_card_1_Template(i,e){if(1&i&&(P.j41(0,"ion-card",29)(1,"ion-item",30),P.nrm(2,"ion-icon",31),P.j41(3,"ion-label"),P.DNE(4,AddonModWikiIndexComponent_div_10_ion_card_1_span_4_Template,3,6,"span",8)(5,AddonModWikiIndexComponent_div_10_ion_card_1_span_5_Template,3,6,"span",8),P.k0s()()()),2&i){const i=P.XpG(2);P.R7$(4),P.Y8G("ngIf",i.pageIsOffline),P.R7$(),P.Y8G("ngIf",!i.pageIsOffline)}}function AddonModWikiIndexComponent_div_10_ion_card_2_Template(i,e){if(1&i&&(P.j41(0,"ion-card",29)(1,"ion-item"),P.nrm(2,"ion-icon",31),P.j41(3,"ion-label"),P.EFF(4),P.k0s()()()),2&i){const i=P.XpG(2);P.R7$(4),P.JRh(i.pageWarning)}}function AddonModWikiIndexComponent_div_10_Template(i,e){if(1&i&&(P.j41(0,"div"),P.DNE(1,AddonModWikiIndexComponent_div_10_ion_card_1_Template,6,2,"ion-card",28)(2,AddonModWikiIndexComponent_div_10_ion_card_2_Template,5,1,"ion-card",28),P.k0s()),2&i){const i=P.XpG();P.R7$(),P.Y8G("ngIf",i.pageIsOffline||i.hasOffline),P.R7$(),P.Y8G("ngIf",i.pageWarning)}}function AddonModWikiIndexComponent_h2_12_Template(i,e){if(1&i&&(P.j41(0,"h2"),P.EFF(1),P.k0s()),2&i){const i=P.XpG();P.R7$(),P.JRh(i.pageTitle)}}function AddonModWikiIndexComponent_core_format_text_14_Template(i,e){if(1&i&&P.nrm(0,"core-format-text",32),2&i){const i=P.XpG();P.Y8G("component",i.component)("componentId",i.componentId)("text",i.pageContent)("contextInstanceId",i.module.id)("courseId",i.courseId)}}function AddonModWikiIndexComponent_core_empty_box_15_Template(i,e){1&i&&(P.nrm(0,"core-empty-box",33),P.nI1(1,"translate")),2&i&&P.Y8G("message",P.bMT(1,1,"addon.mod_wiki.nocontent"))}function AddonModWikiIndexComponent_div_16_Template(i,e){if(1&i&&(P.j41(0,"div",34)(1,"strong"),P.EFF(2),P.nI1(3,"translate"),P.k0s(),P.nrm(4,"core-tag-list",35),P.k0s()),2&i){const i=P.XpG();P.R7$(2),P.SpI("",P.bMT(3,2,"core.tag.tags"),":"),P.R7$(2),P.Y8G("tags",i.tags)}}function AddonModWikiIndexComponent_core_course_module_navigation_17_Template(i,e){if(1&i&&P.nrm(0,"core-course-module-navigation",36),2&i){const i=P.XpG();P.Y8G("hidden",i.showLoading)("courseId",i.courseId)("currentModuleId",i.module.id)}}function AddonModWikiIndexComponent_ion_fab_18_Template(i,e){if(1&i){const i=P.RV6();P.j41(0,"ion-fab",37)(1,"ion-fab-button",38),P.nI1(2,"translate"),P.bIt("click",(function AddonModWikiIndexComponent_ion_fab_18_Template_ion_fab_button_click_1_listener(){P.eBV(i);const e=P.XpG();return P.Njj(e.goToNewPage())})),P.nrm(3,"ion-icon",39),P.j41(4,"span",40),P.EFF(5),P.nI1(6,"translate"),P.k0s()()()}2&i&&(P.R7$(),P.BMQ("aria-label",P.bMT(2,2,"addon.mod_wiki.createpage")),P.R7$(4),P.JRh(P.bMT(6,4,"addon.mod_wiki.createpage")))}let F=(()=>{var i;class AddonModWikiIndexComponent extends d.y{constructor(i,e){super("AddonModLessonIndexComponent",i,e),this.content=i,this.component=v.Rv,this.pluginName="wiki",this.groupWiki=!1,this.isOnline=!1,this.isMainPage=!1,this.canEdit=!1,this.pageStr="",this.loadedSubwikis=[],this.pageIsOffline=!1,this.tagsEnabled=!1,this.tags=[],this.subwikiData={subwikiSelected:0,userSelected:0,groupSelected:0,subwikis:[],count:0},this.syncEventName=v.mb,this.ignoreManualSyncEvent=!1,this.isOnline=u.WE.isOnline(),this.onlineSubscription=u.WE.onChange().subscribe((()=>{w.SK.run((()=>{this.isOnline=u.WE.isOnline()}))}))}ngOnInit(){var _superprop_getNgOnInit=()=>super.ngOnInit,i=this;return(0,t.A)((function*(){_superprop_getNgOnInit().call(i),i.pageStr=w.HT.instant("addon.mod_wiki.wikipage"),i.tagsEnabled=a.CoreTag.areTagsAvailableInSite(),i.currentUserId=g.CoreSites.getCurrentSiteUserId(),i.isMainPage=!i.pageId&&!i.pageTitle,i.currentPage=i.pageId,i.currentPath=l.CoreNavigator.getCurrentPath(),i.listenEvents();try{yield i.loadContent(!1,!0)}finally{"map"==i.action&&i.openMap()}}))()}listenEvents(){this.manualSyncObserver=m.z.on(v.$9,(i=>{if(i&&this.wiki&&i.wikiId==this.wiki.id){if(this.ignoreManualSyncEvent)return this.ignoreManualSyncEvent=!1,void 0;this.currentSubwiki&&this.checkPageCreatedOrDiscarded(i.subwikis[this.currentSubwiki.id]),this.pageWarning||this.showLoadingAndFetch(!1,!1)}}),this.siteId)}checkPageCreatedOrDiscarded(i){if(this.currentPage||!i)return;const e=i.created.find((i=>i.title==this.pageTitle));if(e)this.currentPage=e.pageId,this.pageIsOffline=!1;else{const e=i.discarded.find((i=>i.title==this.pageTitle));e&&(this.pageWarning=e.warning,this.pageContent="",this.pageIsOffline=!1,this.hasOffline=!1)}}fetchContent(i,e=!1,n=!1){var d=this;return(0,t.A)((function*(){try{if(d.wiki=yield b.N.getWiki(d.courseId,d.module.id),void 0===d.pageContent&&d.dataRetrieved.emit(d.wiki),b.N.wikiPageOpened(d.wiki.id,d.currentPath),e&&(yield k.g.ignoreErrors(d.syncActivity(n))),d.pageWarning)return;d.module.id||(d.module=yield r.CoreCourse.getModule(d.wiki.coursemodule,d.wiki.course,void 0,!0)),d.description=d.wiki.intro||d.module.description,d.componentId=d.module.id,yield d.fetchSubwikis(d.wiki.id);const i=b.N.getSubwikiList(d.wiki.id);if(i)d.subwikiData.count=i.count,d.setSelectedWiki(d.subwikiId,d.userId,d.groupId),d.isAnySubwikiSelected()||d.setSelectedWiki(i.subwikiSelected,i.userSelected,i.groupSelected),d.subwikiData.subwikis=i.subwikis;else{const i=yield c.CoreGroups.getActivityGroupInfo(d.wiki.coursemodule);if(i.separateGroups&&!i.groups.length)throw new o.CoreError(w.HT.instant("addon.mod_wiki.cannotviewpage"));yield d.createSubwikiList(i.groups)}if(!d.isAnySubwikiSelected()||d.subwikiData.count<=0)throw new o.CoreError(w.HT.instant("addon.mod_wiki.errornowikiavailable"));yield d.fetchWikiPage()}catch(i){if(d.pageWarning)return;throw i}}))()}fetchPageContents(i){var e=this;return(0,t.A)((function*(){if(i)return e.pageIsOffline=!1,b.N.getPageContents(i,{cmId:e.module.id});try{var n,o,d,r,a;const i=e.pageTitle||(null===(n=e.wiki)||void 0===n?void 0:n.firstpagetitle)||"",s=yield f.W.getNewPage(i,null===(o=e.currentSubwiki)||void 0===o?void 0:o.id,null===(d=e.currentSubwiki)||void 0===d?void 0:d.wikiid,null===(r=e.currentSubwiki)||void 0===r?void 0:r.userid,null===(a=e.currentSubwiki)||void 0===a?void 0:a.groupid);return e.pageIsOffline=!0,e.newPageObserver||(e.newPageObserver=m.z.on(v.PQ,function(){var n=(0,t.A)((function*(n){var t,o;n.subwikiId==(null===(t=e.currentSubwiki)||void 0===t?void 0:t.id)&&n.pageTitle==i&&(e.currentPage=n.pageId,null===(o=e.newPageObserver)||void 0===o||o.off(),e.newPageObserver=void 0,yield e.showLoadingAndFetch(!0,!1),e.currentPage&&e.logPageViewed(e.currentPage))}));return function(i){return n.apply(this,arguments)}}(),g.CoreSites.getCurrentSiteId())),s}catch{}}))()}fetchSubwikiPages(i){var e=this;return(0,t.A)((function*(){const n=i.id<=0?[]:yield b.N.getSubwikiPages(i.wikiid,{groupId:i.groupid,userId:i.userid,cmId:e.module.id});e.setCurrentPage(n);const t=yield f.W.getSubwikiNewPages(i.id,i.wikiid,i.userid,i.groupid);if(e.subwikiPages=b.N.sortPagesByTitle(n.concat(t)),!e.currentPage&&!e.pageTitle&&e.subwikiPages.length>0)throw new o.CoreError}))()}setCurrentPage(i){var e,n;if(this.currentPage)return;if(this.pageTitle){const e=i.find((i=>i.title===this.pageTitle));return e&&(this.currentPage=e.id),void 0}const t=i.find((i=>i.firstpage));this.currentPage=null==t?void 0:t.id,this.pageTitle=null!==(e=null==t?void 0:t.title)&&void 0!==e?e:null===(n=this.wiki)||void 0===n?void 0:n.firstpagetitle}fetchSubwikis(i){var e=this;return(0,t.A)((function*(){e.loadedSubwikis=yield b.N.getSubwikis(i,{cmId:e.module.id}),e.hasOffline=yield f.W.subwikisHaveOfflineData(e.loadedSubwikis)}))()}fetchWikiPage(){var i=this;return(0,t.A)((function*(){if(i.currentSubwiki=i.loadedSubwikis.find((e=>i.isSubwikiSelected(e))),!i.currentSubwiki)throw new o.CoreError;i.setSelectedWiki(i.currentSubwiki.id,i.currentSubwiki.userid,i.currentSubwiki.groupid),yield i.fetchSubwikiPages(i.currentSubwiki),i.canEdit=i.currentSubwiki.canedit;const e=yield i.fetchPageContents(i.currentPage);e&&(i.setSelectedWiki(e.subwikiid,e.userid,e.groupid),i.pageTitle=e.title,i.pageContent=i.replaceEditLinks(e.cachedcontent),i.canEdit=!!e.caneditpage,i.currentPageObj=e,i.tags="tags"in e&&e.tags||[])}))()}logActivity(){var i=this;return(0,t.A)((function*(){var e,n;if(!i.wiki)return;if(i.pageId)return i.checkCompletionAfterLog=!1,yield i.logPageViewed(i.pageId),void 0;if(yield b.N.logView(i.wiki.id),void 0===i.groupId&&void 0===i.userId)return i.analyticsLogEvent("mod_wiki_view_wiki",{name:null===(n=i.currentPageObj)||void 0===n?void 0:n.title}),void 0;const t=i.loadedSubwikis.some((i=>i.userid>0)),o=i.loadedSubwikis.some((i=>i.groupid>0));let d=`/mod/wiki/view.php?wid=${i.wiki.id}&title=${i.wiki.firstpagetitle}`;d+=t&&o?`&groupanduser=${i.groupId}-${i.userId}`:t?`&uid=${i.userId}`:`&group=${i.groupId}`,i.analyticsLogEvent("mod_wiki_view_wiki",{name:null===(e=i.currentPageObj)||void 0===e?void 0:e.title,data:{subwiki:i.subwikiId,userid:i.userId,groupid:i.groupId},url:d})}))()}logPageViewed(i){var e=this;return(0,t.A)((function*(){var n;e.wiki&&(yield k.g.ignoreErrors(b.N.logPageView(i,e.wiki.id)),e.analyticsLogEvent("mod_wiki_view_page",{name:null===(n=e.currentPageObj)||void 0===n?void 0:n.title,data:{pageid:e.pageId},url:`/mod/wiki/view.php?page=${e.pageId}`}))}))()}storeModuleViewed(){var _superprop_getStoreModuleViewed=()=>super.storeModuleViewed,i=this;return(0,t.A)((function*(){i.pageId||(yield _superprop_getStoreModuleViewed().call(i))}))()}getWikiHomeView(){if(this.wiki)return b.N.getFirstWikiPageOpened(this.wiki.id,this.currentPath)}goToCreateFirstPage(){var i,e,n,t,o;l.CoreNavigator.navigateToSitePath(`${v.Jb}/${this.courseId}/${this.module.id}/edit`,{params:{pageTitle:null!==(i=null===(e=this.wiki)||void 0===e?void 0:e.firstpagetitle)&&void 0!==i?i:"",wikiId:null===(n=this.currentSubwiki)||void 0===n?void 0:n.wikiid,userId:null===(t=this.currentSubwiki)||void 0===t?void 0:t.userid,groupId:null===(o=this.currentSubwiki)||void 0===o?void 0:o.groupid}})}goToEditPage(){if(this.canEdit)if(this.currentPageObj){const i={pageTitle:this.currentPageObj.title,subwikiId:this.currentPageObj.subwikiid};"id"in this.currentPageObj&&(i.pageId=this.currentPageObj.id),this.currentSubwiki&&(i.wikiId=this.currentSubwiki.wikiid,i.userId=this.currentSubwiki.userid,i.groupId=this.currentSubwiki.groupid),l.CoreNavigator.navigateToSitePath(`${v.Jb}/${this.courseId}/${this.module.id}/edit`,{params:i})}else this.currentSubwiki&&this.goToCreateFirstPage()}goToNewPage(){if(this.canEdit)if(this.currentPageObj){const i={subwikiId:this.currentPageObj.subwikiid};this.currentSubwiki&&(i.wikiId=this.currentSubwiki.wikiid,i.userId=this.currentSubwiki.userid,i.groupId=this.currentSubwiki.groupid),l.CoreNavigator.navigateToSitePath(`${v.Jb}/${this.courseId}/${this.module.id}/edit`,{params:i})}else this.currentSubwiki&&this.goToCreateFirstPage()}goToPage(i){var e=this;return(0,t.A)((function*(){if("id"in i){if(e.currentPage!=i.id){const n=yield e.fetchPageContents(i.id);e.openPageOrSubwiki({pageTitle:n.title,pageId:n.id,subwikiId:i.subwikiid})}}else!e.currentPage&&e.pageTitle&&i.title==e.pageTitle||e.openPageOrSubwiki({pageTitle:i.title,subwikiId:i.subwikiid})}))()}openPageOrSubwiki(i){var e=this;return(0,t.A)((function*(){const n=_.VV.hashAsciiStr(JSON.stringify({...i,timestamp:Date.now()}));l.CoreNavigator.navigateToSitePath(`${v.Jb}/${e.courseId}/${e.module.id}/page/${n}`,{params:{module:e.module,...i},animated:!i.replace,replace:i.replace})}))()}openMap(){var i=this;return(0,t.A)((function*(){const{AddonModWikiMapModalComponent:e}=yield n.e(6826).then(n.bind(n,66826)),t=yield S.I.openSideModal({component:e,componentProps:{pages:i.subwikiPages,homeView:i.getWikiHomeView(),moduleId:i.module.id,courseId:i.courseId,selectedId:i.currentPage,selectedTitle:i.currentPageObj&&i.currentPageObj.title,wiki:i.wiki}});t&&(t.home?l.CoreNavigator.navigateToSitePath(t.home,{animationDirection:"back"}):t.page&&i.goToPage(t.page))}))()}goToSubwiki(i,e,n){var t,o,d;i===(null===(t=this.currentSubwiki)||void 0===t?void 0:t.id)&&e===(null===(o=this.currentSubwiki)||void 0===o?void 0:o.userid)&&n===(null===(d=this.currentSubwiki)||void 0===d?void 0:d.groupid)||this.openPageOrSubwiki({subwikiId:i,userId:e,groupId:n,replace:!0})}isAnySubwikiSelected(){return 0!==this.subwikiData.subwikiSelected||this.subwikiData.userSelected>0||this.subwikiData.groupSelected>0}isSubwikiSelected(i){return i.id>0&&this.subwikiData.subwikiSelected>0?i.id==this.subwikiData.subwikiSelected:i.userid==this.subwikiData.userSelected&&i.groupid==this.subwikiData.groupSelected}replaceEditLinks(i){if((i=i.trim()).length>0){const e=h.$.concatenatePaths(g.CoreSites.getRequiredCurrentSite().getURL(),"/mod/wiki/edit.php");i=i.replace(/href="edit\.php/g,'href="'+e)}return i}setSelectedWiki(i,e,n){this.subwikiData.subwikiSelected=null!=i?i:0,this.subwikiData.userSelected=f.W.convertToPositiveNumber(e),this.subwikiData.groupSelected=f.W.convertToPositiveNumber(n)}hasSyncSucceed(i){return!!i&&(i.updated&&this.wiki&&(this.ignoreManualSyncEvent=!0,m.z.trigger(v.$9,{...i,wikiId:this.wiki.id})),this.currentSubwiki&&this.checkPageCreatedOrDiscarded(i.subwikis[this.currentSubwiki.id]),i.updated)}ionViewDidEnter(){super.ionViewDidEnter();const i=b.N.consumeEditedPageData();if(!i)return;if(this.pageId&&i.pageId===this.pageId)return this.showLoadingAndRefresh(!0,!1),void 0;if(this.currentSubwiki&&(this.currentSubwiki.id>0&&this.currentSubwiki.id===i.subwikiId||this.currentSubwiki.userid===i.userId&&this.currentSubwiki.groupid===i.groupId)&&i.pageTitle===this.pageTitle)return this.showLoadingAndRefresh(!0,!1),void 0;this.openPageOrSubwiki({pageId:i.pageId,pageTitle:i.pageTitle,subwikiId:i.subwikiId,userId:i.wikiId,groupId:i.groupId}),!i.pageId||this.pageContent&&-1==this.pageContent.indexOf("/mod/wiki/create.php")||this.showLoadingAndRefresh(!0,!1)}invalidateContent(){var i=this;return(0,t.A)((function*(){const e=[];e.push(b.N.invalidateWikiData(i.courseId)),i.wiki&&(e.push(b.N.invalidateSubwikis(i.wiki.id)),e.push(c.CoreGroups.invalidateActivityAllowedGroups(i.wiki.coursemodule)),e.push(c.CoreGroups.invalidateActivityGroupMode(i.wiki.coursemodule))),i.currentSubwiki&&(e.push(b.N.invalidateSubwikiPages(i.currentSubwiki.wikiid)),e.push(b.N.invalidateSubwikiFiles(i.currentSubwiki.wikiid))),i.currentPage&&e.push(b.N.invalidatePage(i.currentPage)),yield Promise.all(e)}))()}isRefreshSyncNeeded(i){return this.currentSubwiki&&i.subwikiId==this.currentSubwiki.id&&i.wikiId==this.currentSubwiki.wikiid&&i.userId==this.currentSubwiki.userid&&i.groupId==this.currentSubwiki.groupid&&(this.isCurrentView&&i.warnings&&i.warnings.length&&p.CoreDomUtils.showAlert(void 0,i.warnings[0]),this.checkPageCreatedOrDiscarded(i)),!this.pageWarning}showSubwikiPicker(i){var e=this;return(0,t.A)((function*(){const{AddonModWikiSubwikiPickerComponent:t}=yield n.e(9030).then(n.bind(n,89030)),o=yield C.CorePopovers.open({component:t,componentProps:{courseId:e.courseId,subwikis:e.subwikiData.subwikis,currentSubwiki:e.currentSubwiki},event:i});o&&e.goToSubwiki(o.id,o.userid,o.groupid)}))()}sync(){var i=this;return(0,t.A)((function*(){if(!i.wiki)throw new o.CoreError("Cannot sync without a wiki.");return I.i.syncWiki(i.wiki.id,i.courseId,i.wiki.coursemodule)}))()}ngOnDestroy(){var i,e;super.ngOnDestroy(),null===(i=this.manualSyncObserver)||void 0===i||i.off(),null===(e=this.newPageObserver)||void 0===e||e.off(),this.onlineSubscription.unsubscribe(),this.wiki&&b.N.wikiPageClosed(this.wiki.id,this.currentPath)}createSubwikiList(i){var e=this;return(0,t.A)((function*(){const n=[];let o=!1,d=!1,r=!1;e.subwikiData.subwikis=[],e.setSelectedWiki(e.subwikiId,e.userId,e.groupId),e.subwikiData.count=0,yield Promise.all(e.loadedSubwikis.map(function(){var a=(0,t.A)((function*(t){let a="";if(0===t.groupid&&0===t.userid)o||(n.unshift({name:w.HT.instant("core.allparticipants"),id:t.id,userid:t.userid,groupid:t.groupid,groupLabel:"",canedit:t.canedit}),o=!0);else{if(0!==t.groupid&&i.length>0){var u;const e=i.find((i=>i.id==t.groupid));a=null!==(u=null==e?void 0:e.name)&&void 0!==u?u:""}else a=w.HT.instant("addon.mod_wiki.notingroup");if(0!==t.userid){r||0==t.groupid||(r=!0);const i=yield s.CoreUser.getProfile(t.userid,e.courseId,!0);n.push({name:i.fullname,id:t.id,userid:t.userid,groupid:t.groupid,groupLabel:a,canedit:t.canedit})}else n.push({name:a,id:t.id,userid:t.userid,groupid:t.groupid,groupLabel:a,canedit:t.canedit}),d=!0}}));return function(i){return a.apply(this,arguments)}}())),e.fillSubwikiData(n,d,r)}))()}fillSubwikiData(i,e,n){if(this.groupWiki=e,this.subwikiData.count=i.length,(!this.subwikiId||!this.userId&&!this.groupId)&&!this.isAnySubwikiSelected()&&i.length>0){let n,t,o,d;for(const d in i){const r=i[d];if(r.canedit){let i;if(r.userid>0?this.currentUserId==r.userid&&(i=r.id):r.groupid>0?e&&(i=r.id):r.id>0&&(i=r.id),void 0!==i){if(i>0){o=Number(d);break}void 0===t&&(t=Number(d))}else void 0===n&&(n=Number(d))}}d=void 0!==o?o:void 0!==t?t:void 0!==n?n:0;const r=i[d];void 0!==r&&this.setSelectedWiki(r.id,r.userid,r.groupid)}if(n){let e,n=-1;i.forEach((i=>{i.groupid!==n&&(e={label:i.groupLabel,subwikis:[]},n=i.groupid,this.subwikiData.subwikis.push(e)),e.subwikis.push(i)}))}else if(e){const e=[],n=[],t=[];i.forEach((i=>{0===i.groupid&&0===i.userid?e.push(i):i.canedit?n.push(i):t.push(i)})),n.length>0&&t.length>0?(e.length>0&&this.subwikiData.subwikis.push({label:"",subwikis:e}),n.length>0&&this.subwikiData.subwikis.push({label:w.HT.instant("core.mygroups"),subwikis:n}),t.length>0&&this.subwikiData.subwikis.push({label:w.HT.instant("core.othergroups"),subwikis:t})):this.subwikiData.subwikis.push({label:"",subwikis:i})}else this.subwikiData.subwikis.push({label:"",subwikis:i});this.wiki&&b.N.setSubwikiList(this.wiki.id,this.subwikiData.subwikis,this.subwikiData.count,this.subwikiData.subwikiSelected,this.subwikiData.userSelected,this.subwikiData.groupSelected)}}return(i=AddonModWikiIndexComponent).ɵfac=function AddonModWikiIndexComponent_Factory(e){return new(e||i)(P.rXU(y.W9),P.rXU(M.k,8))},i.ɵcmp=P.VBU({type:i,selectors:[["addon-mod-wiki-index"]],inputs:{action:"action",pageId:"pageId",pageTitle:"pageTitle",subwikiId:"subwikiId",userId:"userId",groupId:"groupId"},features:[P.Vt3],decls:19,vars:18,consts:[["slot","end"],["aria-haspopup","true",3,"ariaLabel","click",4,"ngIf"],["iconAction","fas-pen",3,"priority","content","action",4,"ngIf"],["iconAction","fas-plus",3,"priority","content","action",4,"ngIf"],["iconAction","fas-circle-info",3,"priority","content"],["fill","clear","aria-haspopup","true",3,"ariaLabel"],[3,"hideUntil"],[3,"module","description","component","componentId","courseId","completionChanged",4,"ngIf"],[4,"ngIf"],[1,"ion-padding-horizontal","addon-mod_wiki-page-content"],[3,"ngClass"],["contextLevel","module",3,"component","componentId","text","contextInstanceId","courseId",4,"ngIf"],["icon","fas-file-lines",3,"message",4,"ngIf"],["class","ion-margin-top",4,"ngIf"],["collapsible-footer","",3,"hidden","courseId","currentModuleId",4,"ngIf"],["slot","fixed","core-fab","","vertical","bottom","horizontal","end",4,"ngIf"],["aria-haspopup","true",3,"click","ariaLabel"],["name","fas-user","aria-hidden","true",4,"ngIf"],["name","fas-users","aria-hidden","true",4,"ngIf"],["name","fas-user","aria-hidden","true"],["name","fas-users","aria-hidden","true"],["name","fas-map","aria-hidden","true"],["iconAction","fas-pen",3,"action","priority","content"],["iconAction","fas-plus",3,"action","priority","content"],["iconAction","fas-circle-info",3,"action","priority","content"],["fill","clear","aria-haspopup","true",3,"click","ariaLabel"],["name","fas-circle-info","slot","icon-only","aria-hidden","true"],[3,"completionChanged","module","description","component","componentId","courseId"],["class","core-warning-card",4,"ngIf"],[1,"core-warning-card"],[1,"ion-text-wrap"],["name","fas-triangle-exclamation","slot","start","aria-hidden","true"],["contextLevel","module",3,"component","componentId","text","contextInstanceId","courseId"],["icon","fas-file-lines",3,"message"],[1,"ion-margin-top"],[3,"tags"],["collapsible-footer","",3,"hidden","courseId","currentModuleId"],["slot","fixed","core-fab","","vertical","bottom","horizontal","end"],[3,"click"],["name","fas-plus","aria-hidden","true"],[1,"sr-only"]],template:function AddonModWikiIndexComponent_Template(i,e){1&i&&(P.j41(0,"core-navbar-buttons",0),P.DNE(1,AddonModWikiIndexComponent_ion_button_1_Template,4,5,"ion-button",1)(2,AddonModWikiIndexComponent_ion_button_2_Template,3,3,"ion-button",1),P.j41(3,"core-context-menu"),P.DNE(4,AddonModWikiIndexComponent_core_context_menu_item_4_Template,2,4,"core-context-menu-item",2)(5,AddonModWikiIndexComponent_core_context_menu_item_5_Template,2,4,"core-context-menu-item",3)(6,AddonModWikiIndexComponent_Conditional_6_Template,2,4,"core-context-menu-item",4),P.k0s(),P.DNE(7,AddonModWikiIndexComponent_Conditional_7_Template,3,3,"ion-button",5),P.k0s(),P.j41(8,"core-loading",6),P.DNE(9,AddonModWikiIndexComponent_core_course_module_info_9_Template,1,5,"core-course-module-info",7)(10,AddonModWikiIndexComponent_div_10_Template,3,2,"div",8),P.j41(11,"div",9),P.DNE(12,AddonModWikiIndexComponent_h2_12_Template,2,1,"h2",8),P.j41(13,"article",10),P.DNE(14,AddonModWikiIndexComponent_core_format_text_14_Template,1,5,"core-format-text",11)(15,AddonModWikiIndexComponent_core_empty_box_15_Template,2,3,"core-empty-box",12),P.k0s(),P.DNE(16,AddonModWikiIndexComponent_div_16_Template,5,4,"div",13),P.k0s()(),P.DNE(17,AddonModWikiIndexComponent_core_course_module_navigation_17_Template,1,3,"core-course-module-navigation",14)(18,AddonModWikiIndexComponent_ion_fab_18_Template,7,6,"ion-fab",15)),2&i&&(P.R7$(),P.Y8G("ngIf",e.subwikiData.count>1),P.R7$(),P.Y8G("ngIf",!e.showLoading&&e.currentPageObj),P.R7$(2),P.Y8G("ngIf",e.canEdit&&(e.isOnline||e.pageIsOffline)),P.R7$(),P.Y8G("ngIf",e.canEdit),P.R7$(),P.vxM(6,e.courseContentsPage?6:-1),P.R7$(),P.vxM(7,e.courseContentsPage?-1:7),P.R7$(),P.Y8G("hideUntil",!e.showLoading),P.R7$(),P.Y8G("ngIf",e.isMainPage),P.R7$(),P.Y8G("ngIf",e.pageIsOffline||e.hasOffline||e.pageWarning),P.R7$(2),P.Y8G("ngIf",e.pageTitle),P.R7$(),P.Y8G("ngClass",P.eq3(16,_c0,!e.canEdit)),P.R7$(),P.Y8G("ngIf",e.pageContent),P.R7$(),P.Y8G("ngIf",!e.pageContent),P.R7$(),P.Y8G("ngIf",e.tagsEnabled&&e.tags.length>0),P.R7$(),P.Y8G("ngIf",e.isMainPage),P.R7$(),P.Y8G("ngIf",e.canEdit))},dependencies:[T.YU,T.bT,A.B,x.Q,W.h,O.R,N.c,E.A,D.t,G.B,$.i,j.T,y.Jm,y.b_,y.Q8,y.YW,y.iq,y.uz,y.he,R.Y,L.Q,Y.v,V.D9],styles:["[_nghost-%COMP%]{--addon-mod-wiki-newentry-link-color: var(--danger);--addon-mod-wiki-toc-border-color: var(--gray-500);--addon-mod-wiki-toc-background-color: var(--gray-200);background-color:var(--ion-item-background)}[_nghost-%COMP%]   .addon-mod_wiki-page-content[_ngcontent-%COMP%]{background-color:var(--ion-item-background);padding-bottom:10px}[_nghost-%COMP%]   .addon-mod_wiki-page-content[_ngcontent-%COMP%]   core-format-text[_ngcontent-%COMP%]     .wiki-toc{margin:16px;padding:8px;border:1px solid var(--addon-mod-wiki-toc-border-color);background:var(--addon-mod-wiki-toc-background-color)}[_nghost-%COMP%]   .addon-mod_wiki-page-content[_ngcontent-%COMP%]   core-format-text[_ngcontent-%COMP%]     .wiki-toc p{color:var(--ion-text-color)}[_nghost-%COMP%]   .addon-mod_wiki-page-content[_ngcontent-%COMP%]   core-format-text[_ngcontent-%COMP%]     .wiki-toc-title{font-size:1.1em;font-variant:small-caps;text-align:center}[_nghost-%COMP%]   .addon-mod_wiki-page-content[_ngcontent-%COMP%]   core-format-text[_ngcontent-%COMP%]     .wiki-toc-section{padding:0;margin:2px 8px}[_nghost-%COMP%]   .addon-mod_wiki-page-content[_ngcontent-%COMP%]   core-format-text[_ngcontent-%COMP%]     .wiki-toc-section-2{padding-inline-start:12px}[_nghost-%COMP%]   .addon-mod_wiki-page-content[_ngcontent-%COMP%]   core-format-text[_ngcontent-%COMP%]     .wiki-toc-section-3{padding-inline-start:24px}[_nghost-%COMP%]   .addon-mod_wiki-page-content[_ngcontent-%COMP%]   core-format-text[_ngcontent-%COMP%]     .wiki_newentry{color:var(--addon-mod-wiki-newentry-link-color);font-style:italic}[_nghost-%COMP%]   .addon-mod_wiki-page-content[_ngcontent-%COMP%]   core-format-text[_ngcontent-%COMP%]     .addon-mod_wiki-noedit a.wiki_edit_section{display:none}:root.dark[_nghost-%COMP%], :root.dark   [_nghost-%COMP%]{--addon-mod-wiki-newentry-link-color: var(--danger-tint);--addon-mod-wiki-toc-background-color: var(--medium)}"]}),AddonModWikiIndexComponent})()},22357:(i,e,n)=>{n.d(e,{i:()=>f});var t=n(10467),o=n(42008),d=n(49446),r=n(97254),a=n(94455),s=n(15221),u=n(52749),c=n(48966),l=n(43411),g=n(79555),p=n(49882),k=n(67981),w=n(59379),m=n(51069),h=n(55554),_=n(54438);let b=(()=>{var i;class AddonModWikiSyncProvider extends o.l{constructor(){super("AddonModWikiSyncProvider"),this.componentTranslatableString="wiki"}getSubwikiBlockId(i,e,n,t){return(i=w.W.convertToPositiveNumber(i))&&i>0?String(i):`${e=w.W.convertToPositiveNumber(e)}:${n=w.W.convertToPositiveNumber(n)}:${t=w.W.convertToPositiveNumber(t)}`}syncAllWikis(i,e){return this.syncOnSites("all wikis",(i=>this.syncAllWikisFunc(!!e,i)),i)}syncAllWikisFunc(i,e){var n=this;return(0,t.A)((function*(){const o=yield w.W.getAllNewPages(e),d={};yield Promise.all(o.map(function(){var o=(0,t.A)((function*(t){const o=n.getSubwikiBlockId(t.subwikiid,t.wikiid,t.userid,t.groupid);if(d[o])return;d[o]=!0;const r=i?yield n.syncSubwiki(t.subwikiid,t.wikiid,t.userid,t.groupid,e):yield n.syncSubwikiIfNeeded(t.subwikiid,t.wikiid,t.userid,t.groupid,e);null!=r&&r.updated&&p.z.trigger(m.mb,{siteId:e,subwikiId:t.subwikiid,wikiId:t.wikiid,userId:t.userid,groupId:t.groupid,created:r.created,discarded:r.discarded,warnings:r.warnings})}));return function(i){return o.apply(this,arguments)}}()))}))()}syncSubwikiIfNeeded(i,e,n,o,d){var r=this;return(0,t.A)((function*(){const t=r.getSubwikiBlockId(i,e,n,o);if(yield r.isSyncNeeded(t,d))return r.syncSubwiki(i,e,n,o,d)}))()}syncSubwiki(i,e,n,t,d){d=d||u.CoreSites.getCurrentSiteId();const r=this.getSubwikiBlockId(i,e,n,t),a=this.getOngoingSync(r,d);if(a)return a;if(c.CoreSync.isBlocked(m.Rv,r,d))throw this.logger.debug(`Cannot sync subwiki ${r} because it is blocked.`),new o.D(g.HT.instant("core.errorsyncblocked",{$a:this.componentTranslate}));return this.logger.debug(`Try to sync subwiki ${r}`),this.addOngoingSync(r,this.performSyncSubwiki(i,e,n,t,d),d)}performSyncSubwiki(i,e,n,o,r){var s=this;return(0,t.A)((function*(){const u={warnings:[],updated:!1,created:[],discarded:[]},c=s.getSubwikiBlockId(i,e,n,o),g=yield h.g.ignoreErrors(w.W.getSubwikiNewPages(i,e,n,o,r),[]);if(!g||!g.length)return yield h.g.ignoreErrors(s.setSyncTime(c,r)),u;if(!a.WE.isOnline())throw new d.CoreNetworkError;return yield Promise.all(g.map(function(){var d=(0,t.A)((function*(t){try{const d=yield k.N.newPageOnline(t.title,t.cachedcontent,{subwikiId:i,wikiId:e,userId:n,groupId:o,siteId:r});u.updated=!0,u.created.push({pageId:d,title:t.title}),yield w.W.deleteNewPage(t.title,i,e,n,o,r)}catch(d){if(!l.CoreWSError.isWebServiceError(d))throw d;yield w.W.deleteNewPage(t.title,i,e,n,o,r),u.updated=!0;const a=s.getOfflineDataDeletedWarning(t.title,d);u.discarded.push({title:t.title,warning:a}),u.warnings.push(a)}}));return function(i){return d.apply(this,arguments)}}())),yield h.g.ignoreErrors(s.setSyncTime(c,r)),u}))()}syncWiki(i,e,n,o){var d=this;return(0,t.A)((function*(){o=o||u.CoreSites.getCurrentSiteId(),yield h.g.ignoreErrors(r.CoreCourseLogHelper.syncActivity(m.Rv,i,o));const a=yield k.N.getSubwikis(i,{cmId:n,siteId:o}),c={warnings:[],updated:!1,subwikis:{},siteId:o};if(yield Promise.all(a.map(function(){var i=(0,t.A)((function*(i){const e=yield d.syncSubwiki(i.id,i.wikiid,i.userid,i.groupid,o);e&&e.updated&&(c.warnings=c.warnings.concat(e.warnings),c.updated=!0,c.subwikis[i.id]={created:e.created,discarded:e.discarded})}));return function(e){return i.apply(this,arguments)}}())),c.updated){const t=[];i&&(t.push(k.N.invalidateSubwikis(i)),t.push(k.N.invalidateSubwikiPages(i)),t.push(k.N.invalidateSubwikiFiles(i))),e&&t.push(k.N.invalidateWikiData(e)),n&&(t.push(s.CoreGroups.invalidateActivityAllowedGroups(n)),t.push(s.CoreGroups.invalidateActivityGroupMode(n))),yield h.g.ignoreErrors(Promise.all(t))}return c}))()}}return(i=AddonModWikiSyncProvider).ɵfac=function AddonModWikiSyncProvider_Factory(e){return new(e||i)},i.ɵprov=_.jDH({token:i,factory:i.ɵfac,providedIn:"root"}),AddonModWikiSyncProvider})();const f=(0,g.Qd)(b)}}]);