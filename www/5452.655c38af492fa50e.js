"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[5452],{65452:(e,i,t)=>{t.r(i),t.d(i,{default:()=>U});var o=t(21182),n=t(3353),d=t(31249),r=t(8444),a=t(84078),s=t(54438);let l=(()=>{var e;class AddonModWikiComponentsModule{}return(e=AddonModWikiComponentsModule).ɵfac=function AddonModWikiComponentsModule_Factory(i){return new(i||e)},e.ɵmod=s.$C({type:e}),e.ɵinj=s.G2t({imports:[n.n,d.r,r.O]}),AddonModWikiComponentsModule})();void(("undefined"==typeof ngJitMode||ngJitMode)&&s.Obh(l,{declarations:[a.AddonModWikiIndexComponent],imports:[n.n,d.r,r.O],exports:[a.AddonModWikiIndexComponent]}));var c=t(49072),g=t(98833),u=t(6007),I=t(10467),m=t(75629),p=t(44682),k=t(15324),w=t(52749),f=t(48966),h=t(89911),b=t(75383),v=t(55554),C=t(79555),_=t(49882),P=t(63153),T=t(67981),y=t(59379),E=t(22357),M=t(22693),A=t(51069),N=t(23780),x=t(88436),F=t(89417),W=t(60177),D=t(64422),R=t(58197),$=t(88246),L=t(43570),S=t(73465),G=t(41450),O=t(73955);const B=["editPageForm"];function AddonModWikiEditPage_form_14_ion_item_2_Template(e,i){1&e&&(s.j41(0,"ion-item",13),s.nrm(1,"ion-input",14),s.nI1(2,"translate"),s.nI1(3,"translate"),s.k0s()),2&e&&(s.R7$(),s.Y8G("label",s.bMT(2,2,"addon.mod_wiki.newpagetitle"))("placeholder",s.bMT(3,4,"addon.mod_wiki.newpagetitle")))}function AddonModWikiEditPage_form_14_ion_item_9_Template(e,i){1&e&&(s.j41(0,"ion-item",15)(1,"ion-label")(2,"ion-badge",16),s.EFF(3),s.nI1(4,"translate"),s.k0s()()()),2&e&&(s.R7$(3),s.JRh(s.bMT(4,1,"addon.mod_wiki.wrongversionlock")))}function AddonModWikiEditPage_form_14_Template(e,i){if(1&e&&(s.j41(0,"form",8,0),s.DNE(2,AddonModWikiEditPage_form_14_ion_item_2_Template,4,6,"ion-item",9),s.j41(3,"ion-item")(4,"ion-label",10),s.EFF(5),s.nI1(6,"translate"),s.k0s(),s.nrm(7,"core-rich-text-editor",11),s.nI1(8,"translate"),s.k0s(),s.DNE(9,AddonModWikiEditPage_form_14_ion_item_9_Template,5,3,"ion-item",12),s.k0s()),2&e){const e=s.XpG();s.Y8G("formGroup",e.pageForm),s.R7$(2),s.Y8G("ngIf",e.canEditTitle),s.R7$(3),s.JRh(s.bMT(6,11,"core.content")),s.R7$(2),s.Y8G("control",e.contentControl)("placeholder",s.bMT(8,13,"core.content"))("component",e.component)("componentId",e.cmId)("autoSave",!0)("contextInstanceId",e.cmId)("draftExtraParams",e.editorExtraParams),s.R7$(2),s.Y8G("ngIf",e.wrongVersionLock)}}let H=(()=>{var e;class AddonModWikiEditPage{constructor(e){this.formBuilder=e,this.canEditTitle=!1,this.loaded=!1,this.component=A.Rv,this.wrongVersionLock=!1,this.editorExtraParams={},this.editing=!1,this.editOffline=!1,this.subwikiFiles=[],this.forceLeave=!1,this.isDestroyed=!1,this.contentControl=this.formBuilder.control("",{nonNullable:!0}),this.pageForm=this.formBuilder.group({})}ngOnInit(){var e=this;return(0,I.A)((function*(){e.cmId=k.CoreNavigator.getRouteNumberParam("cmId")||void 0,e.courseId=k.CoreNavigator.getRouteNumberParam("courseId")||void 0,e.subwikiId=k.CoreNavigator.getRouteNumberParam("subwikiId"),e.wikiId=k.CoreNavigator.getRouteNumberParam("wikiId"),e.pageId=k.CoreNavigator.getRouteNumberParam("pageId"),e.section=k.CoreNavigator.getRouteParam("section"),e.groupId=k.CoreNavigator.getRouteNumberParam("groupId"),e.userId=k.CoreNavigator.getRouteNumberParam("userId");const i=k.CoreNavigator.getRouteParam("pageTitle");e.originalTitle=i?b.Ni.cleanTags(i.replace(/\+/g," "),{singleLine:!0}):"",e.canEditTitle=!e.originalTitle,e.title=e.originalTitle?C.HT.instant("addon.mod_wiki.editingpage",{$a:e.originalTitle}):C.HT.instant("addon.mod_wiki.newpagehdr"),e.blockId=E.i.getSubwikiBlockId(e.subwikiId,e.wikiId,e.userId,e.groupId),e.pageForm.addControl("title",e.formBuilder.control(e.originalTitle)),e.pageForm.addControl("text",e.contentControl),f.CoreSync.blockOperation(e.component,e.blockId),e.pageId?(e.editorExtraParams.pageid=e.pageId,e.section&&(e.editorExtraParams.section=e.section)):e.originalTitle&&(e.editorExtraParams.pagetitle=e.originalTitle);try{if((yield e.fetchWikiPageData())&&!e.isDestroyed){const i=E.i.getSubwikiBlockId(e.subwikiId,e.wikiId,e.userId,e.groupId);i!==e.blockId&&(f.CoreSync.unblockOperation(e.component,e.blockId),e.blockId=i,f.CoreSync.blockOperation(e.component,e.blockId)),e.logView()}}finally{e.loaded=!0}}))()}fetchWikiPageData(){var e=this;return(0,I.A)((function*(){let i=!1,t=!1;try{const t=e.blockId?yield E.i.waitForSync(e.blockId):void 0;if(e.pageId){e.canEditTitle=!1,e.editing=!0,e.editOffline=!1;const t=yield T.N.getPageContents(e.pageId,{cmId:e.cmId});e.pageForm.controls.title.setValue(t.title),e.wikiId=t.wikiid,e.subwikiId=t.subwikiid,e.title=C.HT.instant("addon.mod_wiki.editingpage",{$a:t.title}),e.originalTitle=t.title,e.groupId=t.groupid,e.userId=t.userid,i=t.caneditpage,yield e.fetchModuleAndCourseId(),e.subwikiFiles=yield T.N.getSubwikiFiles(e.wikiId,{groupId:e.groupId,userId:e.userId,cmId:e.cmId});const o=yield T.N.getPageForEditing(e.pageId,e.section),n=x.CoreFileHelper.replacePluginfileUrls(o.content||"",e.subwikiFiles);e.contentControl.setValue(n),e.originalContent=n,e.version=o.version,i&&(e.renewLockInterval=window.setInterval((()=>{e.renewLock()}),A.hD))}else{const o=e.pageForm.controls.title.value;if(e.editing=!1,i=!!e.blockId,yield e.fetchModuleAndCourseId(),!e.wikiId&&e.cmId&&e.courseId){const i=yield p.CoreCourse.getModule(e.cmId,e.courseId,void 0,!0);e.wikiId=i.instance}if(o){if(t){const i=t.created.find((e=>e.title==o));if(i&&i.pageId>0)return e.pageId=i.pageId,e.fetchWikiPageData()}const i=yield v.g.ignoreErrors(y.W.getNewPage(o,e.subwikiId,e.wikiId,e.userId,e.groupId));i?(e.contentControl.setValue(i.cachedcontent),e.originalContent=i.cachedcontent,e.editOffline=!0):e.editOffline=!1}else e.editOffline=!1}return!0}catch(i){return h.CoreDomUtils.showErrorModalDefault(i,"Error getting wiki data."),t=!0,e.forceLeavePage(),!1}finally{i||t||(h.CoreDomUtils.showAlert(C.HT.instant("core.notice"),C.HT.instant("addon.mod_wiki.cannoteditpage")),e.forceLeavePage())}}))()}fetchModuleAndCourseId(){var e=this;return(0,I.A)((function*(){if(!e.wikiId||e.cmId&&e.courseId)return;const i=yield p.CoreCourse.getModuleBasicInfoByInstance(e.wikiId,"wiki",{readingStrategy:1});e.cmId=i.id,e.courseId=i.course}))()}forceLeavePage(){this.forceLeave=!0,k.CoreNavigator.back()}goToPage(e){this.wikiId&&(T.N.setEditedPageData({cmId:this.cmId,courseId:this.courseId,pageId:this.pageId,pageTitle:e,wikiId:this.wikiId,subwikiId:this.subwikiId,userId:this.userId,groupId:this.groupId}),this.forceLeavePage())}hasDataChanged(){const e=this.pageForm.value;return!(this.originalContent==e.text||!this.editing&&!e.text&&!e.title)}canLeave(){var e=this;return(0,I.A)((function*(){return e.forceLeave||(e.hasDataChanged()&&(yield h.CoreDomUtils.showConfirm(C.HT.instant("core.confirmcanceledit"))),P.R.triggerFormCancelledEvent(e.formElement,w.CoreSites.getCurrentSiteId())),!0}))()}ionViewDidLeave(){setTimeout((()=>{T.N.consumeEditedPageData()}),200)}save(){var e=this;return(0,I.A)((function*(){var i;const t=e.pageForm.value,o=t.title;let n=null!==(i=t.text)&&void 0!==i?i:"";const d=yield N.CoreLoadings.show("core.sending",!0);n=x.CoreFileHelper.restorePluginfileUrls(n,e.subwikiFiles),n=b.Ni.formatHtmlLines(n);try{if(e.editing&&e.pageId)return yield T.N.editPage(e.pageId,n,e.section),P.R.triggerFormSubmittedEvent(e.formElement,!0,w.CoreSites.getCurrentSiteId()),yield T.N.invalidatePage(e.pageId),e.goToPage(o);if(!o)return d.dismiss(),h.CoreDomUtils.showAlert(C.HT.instant("core.notice"),C.HT.instant("addon.mod_wiki.titleshouldnotbeempty")),void 0;if(!e.editOffline){if(yield v.g.ignoreErrors(y.W.getNewPage(o,e.subwikiId,e.wikiId,e.userId,e.groupId)))throw new m.CoreError(C.HT.instant("addon.mod_wiki.pageexists"))}const i=yield T.N.newPage(o,n,{subwikiId:e.subwikiId,wikiId:e.wikiId,userId:e.userId,groupId:e.groupId,cmId:e.cmId});if(P.R.triggerFormSubmittedEvent(e.formElement,i>0,w.CoreSites.getCurrentSiteId()),i<=0)return e.goToPage(o);_.z.trigger(_.z.ACTIVITY_DATA_SENT,{module:"wiki"}),e.pageId=i;const t=yield T.N.getPageContents(e.pageId,{cmId:e.cmId}),r=[];e.wikiId=t.wikiid,r.push(T.N.invalidateSubwikiPages(e.wikiId)),e.subwikiId||r.push(T.N.invalidateSubwikis(e.wikiId)),e.subwikiId=t.subwikiid,e.userId=t.userid,e.groupId=t.groupid,yield v.g.ignoreErrors(Promise.all(r)),_.z.trigger(A.PQ,{pageId:e.pageId,subwikiId:e.subwikiId,pageTitle:o},w.CoreSites.getCurrentSiteId()),e.goToPage(o)}catch(e){h.CoreDomUtils.showErrorModalDefault(e,"Error saving wiki data.")}finally{d.dismiss()}}))()}renewLock(){var e=this;return(0,I.A)((function*(){if(!e.pageId)return;const i=yield T.N.getPageForEditing(e.pageId,e.section,!0);i.version&&e.version!=i.version&&(e.wrongVersionLock=!0)}))()}logView(){var e;let i;if(this.pageId)i=`/mod/wiki/edit.php?pageid=${this.pageId}`+(this.section?`&section=${this.section.replace(/ /g,"+")}`:"");else if(this.originalTitle){const e=this.originalTitle.replace(/ /g,"+");var t,o;if(this.subwikiId)i=`/mod/wiki/create.php?swid=${this.subwikiId}&title=${e}&action=new`;else i=`/mod/wiki/create.php?wid=${this.wikiId}&group=${null!==(t=this.groupId)&&void 0!==t?t:0}&uid=${null!==(o=this.userId)&&void 0!==o?o:0}&title=${e}`}else i=`/mod/wiki/create.php?action=new&wid=${this.wikiId}&swid=${this.subwikiId}`;M.OF.logEvent({type:M.qr.VIEW_ITEM,ws:this.pageId?"mod_wiki_edit_page":"mod_wiki_new_page",name:null!==(e=this.originalTitle)&&void 0!==e?e:C.HT.instant("addon.mod_wiki.newpagehdr"),data:{id:this.wikiId,subwiki:this.subwikiId,category:"wiki"},url:i})}ngOnDestroy(){this.isDestroyed=!0,clearInterval(this.renewLockInterval),this.blockId&&f.CoreSync.unblockOperation(this.component,this.blockId)}}return(e=AddonModWikiEditPage).ɵfac=function AddonModWikiEditPage_Factory(i){return new(i||e)(s.rXU(F.ok))},e.ɵcmp=s.VBU({type:e,selectors:[["page-addon-mod-wiki-edit"]],viewQuery:function AddonModWikiEditPage_Query(e,i){if(1&e&&s.GBs(B,5),2&e){let e;s.mGM(e=s.lsd())&&(i.formElement=e.first)}},decls:15,vars:11,consts:[["editPageForm",""],["slot","start"],[3,"text"],["contextLevel","module",3,"text","contextInstanceId","courseId"],["slot","end"],["fill","clear",3,"click"],[3,"hideUntil"],[3,"formGroup",4,"ngIf"],[3,"formGroup"],["class","ion-text-wrap",4,"ngIf"],["position","stacked","for","wiki_page_content"],["name","wiki_page_content","contextLevel","module","elementId","newcontent_editor",3,"control","placeholder","component","componentId","autoSave","contextInstanceId","draftExtraParams"],["class","ion-text-center addon-mod_wiki-wrongversionlock",4,"ngIf"],[1,"ion-text-wrap"],["labelPlacement","stacked","name","title","type","text","formControlName","title",3,"label","placeholder"],[1,"ion-text-center","addon-mod_wiki-wrongversionlock"],["color","danger",1,"ion-padding"]],template:function AddonModWikiEditPage_Template(e,i){1&e&&(s.j41(0,"ion-header")(1,"ion-toolbar")(2,"ion-buttons",1),s.nrm(3,"ion-back-button",2),s.nI1(4,"translate"),s.k0s(),s.j41(5,"ion-title")(6,"h1"),s.nrm(7,"core-format-text",3),s.k0s()(),s.j41(8,"ion-buttons",4)(9,"ion-button",5),s.bIt("click",(function AddonModWikiEditPage_Template_ion_button_click_9_listener(){return i.save()})),s.EFF(10),s.nI1(11,"translate"),s.k0s()()()(),s.j41(12,"ion-content")(13,"core-loading",6),s.DNE(14,AddonModWikiEditPage_form_14_Template,10,15,"form",7),s.k0s()()),2&e&&(s.R7$(3),s.Y8G("text",s.bMT(4,7,"core.back")),s.R7$(4),s.Y8G("text",i.title)("contextInstanceId",i.cmId)("courseId",i.courseId),s.R7$(3),s.SpI(" ",s.bMT(11,9,"core.save")," "),s.R7$(3),s.Y8G("hideUntil",i.loaded),s.R7$(),s.Y8G("ngIf",i.loaded))},dependencies:[W.bT,D.R,R.B,$.i,L.T,F.qT,F.BC,F.cb,S.In,S.Jm,S.QW,S.W9,S.eU,S.$w,S.uz,S.he,S.BC,S.ai,S.Gw,S.el,F.j4,F.JD,G.u,O.D9],encapsulation:2}),AddonModWikiEditPage})();const V=[{path:":courseId/:cmId",redirectTo:":courseId/:cmId/page/root"},{path:":courseId/:cmId/page/:hash",component:c.AddonModWikiIndexPage},{path:":courseId/:cmId/edit",component:H,canDeactivate:[u.V]}];let U=(()=>{var e;class AddonModWikiLazyModule{}return(e=AddonModWikiLazyModule).ɵfac=function AddonModWikiLazyModule_Factory(i){return new(i||e)},e.ɵmod=s.$C({type:e}),e.ɵinj=s.G2t({imports:[o.iI.forChild(V),n.n,l,g.d]}),AddonModWikiLazyModule})();void(("undefined"==typeof ngJitMode||ngJitMode)&&s.Obh(U,{declarations:[c.AddonModWikiIndexPage,H],imports:[o.iI,n.n,l,g.d]}))}}]);