"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[520],{90520:(e,n,s)=>{s.r(n),s.d(n,{default:()=>Me});var t=s(94114),o=s(3353),a=s(10467),i=s(52749),r=s(20728),c=s(89911),d=s(49882),l=s(79555),g=s(93417),_=s(15324),m=s(29492),u=s(44426),h=s(40152),f=s(54438),p=s(21182),M=s(60177),v=s(69502),C=s(16986),b=s(64422),P=s(16658),I=s(88246),O=s(73465),y=s(75357),T=s(73955);function AddonMessagesContacts35Page_core_empty_box_19_Template(e,n){1&e&&(f.nrm(0,"core-empty-box",9),f.nI1(1,"translate")),2&e&&f.Y8G("message",f.bMT(1,1,"addon.messages.contactlistempty"))}function AddonMessagesContacts35Page_core_empty_box_20_Template(e,n){1&e&&(f.nrm(0,"core-empty-box",9),f.nI1(1,"translate")),2&e&&f.Y8G("message",f.bMT(1,1,"addon.messages.nousersfound"))}function AddonMessagesContacts35Page_ion_list_21_ng_container_1_ng_container_9_ion_item_1_Template(e,n){if(1&e){const e=f.RV6();f.j41(0,"ion-item",16),f.bIt("click",(function AddonMessagesContacts35Page_ion_list_21_ng_container_1_ng_container_9_ion_item_1_Template_ion_item_click_0_listener(){f.eBV(e);const n=f.XpG().$implicit,s=f.XpG(3);return f.Njj(s.gotoDiscussion(n.id))})),f.nrm(1,"core-user-avatar",17),f.j41(2,"ion-label")(3,"p",12),f.EFF(4),f.k0s()()()}if(2&e){const e=f.XpG().$implicit,n=f.XpG(3);f.Y8G("detail",!0),f.BMQ("aria-label",e.fullname)("aria-current",e.id===n.discussionUserId?"page":"false"),f.R7$(),f.Y8G("user",e)("checkOnline",e.showonlinestatus),f.R7$(3),f.JRh(e.fullname)}}function AddonMessagesContacts35Page_ion_list_21_ng_container_1_ng_container_9_Template(e,n){if(1&e&&(f.qex(0),f.DNE(1,AddonMessagesContacts35Page_ion_list_21_ng_container_1_ng_container_9_ion_item_1_Template,5,6,"ion-item",15),f.bVm()),2&e){const e=n.$implicit;f.R7$(),f.Y8G("ngIf",e.profileimageurl||e.profileimageurlsmall)}}function AddonMessagesContacts35Page_ion_list_21_ng_container_1_Template(e,n){if(1&e&&(f.qex(0),f.j41(1,"ion-item-divider")(2,"ion-label")(3,"p",12),f.EFF(4),f.nI1(5,"translate"),f.k0s()(),f.j41(6,"ion-note",13)(7,"ion-badge"),f.EFF(8),f.k0s()()(),f.DNE(9,AddonMessagesContacts35Page_ion_list_21_ng_container_1_ng_container_9_Template,2,1,"ng-container",14),f.bVm()),2&e){const e=f.XpG().$implicit,n=f.XpG();f.R7$(4),f.JRh(f.bMT(5,3,"addon.messages.type_"+e)),f.R7$(4),f.JRh(n.contacts[e].length),f.R7$(),f.Y8G("ngForOf",n.contacts[e])}}function AddonMessagesContacts35Page_ion_list_21_Template(e,n){if(1&e&&(f.j41(0,"ion-list",10),f.DNE(1,AddonMessagesContacts35Page_ion_list_21_ng_container_1_Template,10,5,"ng-container",11),f.k0s()),2&e){const e=n.$implicit,s=f.XpG();f.R7$(),f.Y8G("ngIf",s.contacts[e]&&(s.contacts[e].length>0||e===s.searchType))}}let A=(()=>{var e;class AddonMessagesContacts35Page{constructor(e){this.route=e,this.noSearchTypes=["online","offline","blocked","strangers"],this.loaded=!1,this.contactTypes=["online","offline","blocked","strangers"],this.searchType="search",this.loadingMessage="",this.hasContacts=!1,this.contacts={online:[],offline:[],strangers:[],search:[]},this.searchString="",this.siteId=i.CoreSites.getCurrentSiteId(),this.searchingMessages=l.HT.instant("core.searching"),this.loadingMessages=l.HT.instant("core.loading"),this.loadingMessage=this.loadingMessages,this.memberInfoObserver=d.z.on(h.Ie,(e=>{e.contactRequestConfirmed&&this.refreshData()}),i.CoreSites.getCurrentSiteId())}ngOnInit(){var e=this;return(0,a.A)((function*(){const n=_.CoreNavigator.getRouteNumberParam("discussionUserId")||_.CoreNavigator.getRouteNumberParam("userId")||void 0;if(!e.loaded||e.discussionUserId!=n){e.discussionUserId=n,e.discussionUserId&&e.gotoDiscussion(e.discussionUserId);try{if(yield e.fetchData(),!e.discussionUserId&&e.hasContacts&&g.CoreScreen.isTablet){let n;for(const s in e.contacts)if(e.contacts[s].length>0){n=e.contacts[s][0];break}n&&e.gotoDiscussion(n.id)}}finally{e.loaded=!0}}}))()}refreshData(e){var n=this;return(0,a.A)((function*(){try{n.searchString?yield n.performSearch(n.searchString):(yield r.AddonMessages.invalidateAllContactsCache(),yield n.fetchData())}finally{null==e||e.complete()}}))()}fetchData(){var e=this;return(0,a.A)((function*(){e.loadingMessage=e.loadingMessages;try{const n=yield r.AddonMessages.getAllContacts();for(const s in n)e.contacts[s]=n[s].length>0?e.sortUsers(n[s]):[];e.clearSearch()}catch(e){c.CoreDomUtils.showErrorModalDefault(e,"addon.messages.errorwhileretrievingcontacts",!0)}}))()}sortUsers(e){return e.sort(((e,n)=>{const s=e.fullname.toLowerCase(),t=n.fullname.toLowerCase();return s.localeCompare(t)}))}clearSearch(){this.searchString="",this.contactTypes=this.noSearchTypes,this.hasContacts=!1;for(const e in this.contacts)if(this.contacts[e].length>0)return this.hasContacts=!0,void 0}search(e){var n=this;return(0,a.A)((function*(){u.p.close(),n.loaded=!1,n.loadingMessage=n.searchingMessages;try{yield n.performSearch(e)}finally{n.loaded=!0}}))()}performSearch(e){var n=this;return(0,a.A)((function*(){try{const s=yield r.AddonMessages.searchContacts(e);n.hasContacts=s.length>0,n.searchString=e,n.contactTypes=["search"],n.contacts.search=n.sortUsers(s)}catch(e){c.CoreDomUtils.showErrorModalDefault(e,"addon.messages.errorwhileretrievingcontacts",!0)}}))()}gotoDiscussion(e){this.discussionUserId=e;const n=_.CoreNavigator.getRelativePathToParent("/messages/contacts-35")+`discussion/user/${e}`;_.CoreNavigator.navigate(n,{reset:g.CoreScreen.isTablet&&!!this.splitView&&!this.splitView.isNested})}ngOnDestroy(){var e;null===(e=this.memberInfoObserver)||void 0===e||e.off()}}return(e=AddonMessagesContacts35Page).ɵfac=function AddonMessagesContacts35Page_Factory(n){return new(n||e)(f.rXU(p.nX))},e.ɵcmp=f.VBU({type:e,selectors:[["addon-messages-contacts"]],viewQuery:function AddonMessagesContacts35Page_Query(e,n){if(1&e&&f.GBs(m.M,5),2&e){let e;f.mGM(e=f.lsd())&&(n.splitView=e.first)}},decls:22,vars:19,consts:[["slot","start"],[3,"text"],["slot","end"],["slot","fixed",3,"ionRefresh","disabled"],[3,"pullingText"],["autocorrect","off","spellcheck","false","lengthCheck","2","searchArea","AddonMessagesContacts",3,"onSubmit","onClear","placeholder","disabled"],[3,"hideUntil","message"],["icon","fas-address-book",3,"message",4,"ngIf"],["class","ion-no-margin",4,"ngFor","ngForOf"],["icon","fas-address-book",3,"message"],[1,"ion-no-margin"],[4,"ngIf"],[1,"item-heading"],["slot","end",1,"ion-padding-end"],[4,"ngFor","ngForOf"],["class","ion-text-wrap addon-messages-conversation-item","button","",3,"detail","click",4,"ngIf"],["button","",1,"ion-text-wrap","addon-messages-conversation-item",3,"click","detail"],["slot","start",3,"user","checkOnline"]],template:function AddonMessagesContacts35Page_Template(e,n){1&e&&(f.j41(0,"ion-header")(1,"ion-toolbar")(2,"ion-buttons",0),f.nrm(3,"ion-back-button",1),f.nI1(4,"translate"),f.k0s(),f.j41(5,"ion-title")(6,"h1"),f.EFF(7),f.nI1(8,"translate"),f.k0s()(),f.j41(9,"ion-buttons",2),f.nrm(10,"core-context-menu"),f.k0s()()(),f.j41(11,"ion-content")(12,"core-split-view")(13,"ion-refresher",3),f.bIt("ionRefresh",(function AddonMessagesContacts35Page_Template_ion_refresher_ionRefresh_13_listener(e){return n.refreshData(e.target)})),f.nrm(14,"ion-refresher-content",4),f.nI1(15,"translate"),f.k0s(),f.j41(16,"core-search-box",5),f.nI1(17,"translate"),f.bIt("onSubmit",(function AddonMessagesContacts35Page_Template_core_search_box_onSubmit_16_listener(e){return n.search(e)}))("onClear",(function AddonMessagesContacts35Page_Template_core_search_box_onClear_16_listener(){return n.clearSearch()})),f.k0s(),f.j41(18,"core-loading",6),f.DNE(19,AddonMessagesContacts35Page_core_empty_box_19_Template,2,3,"core-empty-box",7)(20,AddonMessagesContacts35Page_core_empty_box_20_Template,2,3,"core-empty-box",7)(21,AddonMessagesContacts35Page_ion_list_21_Template,2,1,"ion-list",8),f.k0s()()()),2&e&&(f.R7$(3),f.Y8G("text",f.bMT(4,11,"core.back")),f.R7$(4),f.JRh(f.bMT(8,13,"addon.messages.contacts")),f.R7$(6),f.Y8G("disabled",!n.loaded),f.R7$(),f.FS9("pullingText",f.bMT(15,15,"core.pulltorefresh")),f.R7$(2),f.Y8G("placeholder",f.bMT(17,17,"addon.messages.contactname"))("disabled",!n.loaded),f.R7$(2),f.Y8G("hideUntil",n.loaded)("message",n.loadingMessage),f.R7$(),f.Y8G("ngIf",!n.hasContacts&&""===n.searchString),f.R7$(),f.Y8G("ngIf",!n.hasContacts&&""!==n.searchString),f.R7$(),f.Y8G("ngForOf",n.contactTypes))},dependencies:[M.Sq,M.bT,v.B,C.h,b.R,m.M,P.T,I.i,O.In,O.QW,O.W9,O.eU,O.uz,O.Dg,O.he,O.nf,O.JI,O.To,O.Ki,O.BC,O.ai,O.el,y.M,T.D9],styles:["[_nghost-%COMP%]   .addon-messages-conversation-item[_ngcontent-%COMP%]   ion-label[_ngcontent-%COMP%], [_nghost-%COMP%]   .addon-message-discussion[_ngcontent-%COMP%]   ion-label[_ngcontent-%COMP%]{margin-right:0;margin-left:0}[_nghost-%COMP%]   .addon-messages-conversation-item[_ngcontent-%COMP%]   .item-heading[_ngcontent-%COMP%]   core-format-text[_ngcontent-%COMP%], [_nghost-%COMP%]   .addon-message-discussion[_ngcontent-%COMP%]   .item-heading[_ngcontent-%COMP%]   core-format-text[_ngcontent-%COMP%]{font-weight:700}[_nghost-%COMP%]   .addon-messages-conversation-item[_ngcontent-%COMP%]   .item-heading[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%], [_nghost-%COMP%]   .addon-message-discussion[_ngcontent-%COMP%]   .item-heading[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{margin-inline-start:2px}[_nghost-%COMP%]   .addon-messages-conversation-item[_ngcontent-%COMP%]   ion-note[_ngcontent-%COMP%], [_nghost-%COMP%]   .addon-message-discussion[_ngcontent-%COMP%]   ion-note[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-self:flex-start;margin-inline-start:2px}[_nghost-%COMP%]   .addon-messages-conversation-item[_ngcontent-%COMP%]   ion-note[_ngcontent-%COMP%]   ion-badge[_ngcontent-%COMP%], [_nghost-%COMP%]   .addon-messages-conversation-item[_ngcontent-%COMP%]   ion-note[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%], [_nghost-%COMP%]   .addon-message-discussion[_ngcontent-%COMP%]   ion-note[_ngcontent-%COMP%]   ion-badge[_ngcontent-%COMP%], [_nghost-%COMP%]   .addon-message-discussion[_ngcontent-%COMP%]   ion-note[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{margin-top:3px;align-self:flex-end}[_nghost-%COMP%]   .addon-messages-conversation-item[_ngcontent-%COMP%]   ion-note[_ngcontent-%COMP%]   .addon-message-last-message-date[_ngcontent-%COMP%], [_nghost-%COMP%]   .addon-message-discussion[_ngcontent-%COMP%]   ion-note[_ngcontent-%COMP%]   .addon-message-last-message-date[_ngcontent-%COMP%]{white-space:nowrap;font-size:.6875rem}[_nghost-%COMP%]   .addon-messages-conversation-item[_ngcontent-%COMP%]   .addon-message-last-message[_ngcontent-%COMP%], [_nghost-%COMP%]   .addon-message-discussion[_ngcontent-%COMP%]   .addon-message-last-message[_ngcontent-%COMP%]{display:flex;justify-content:flex-start}[_nghost-%COMP%]   .addon-messages-conversation-item[_ngcontent-%COMP%]   .addon-message-last-message-user[_ngcontent-%COMP%], [_nghost-%COMP%]   .addon-message-discussion[_ngcontent-%COMP%]   .addon-message-last-message-user[_ngcontent-%COMP%]{white-space:nowrap;color:var(--ion-text-color);margin-inline-end:2px}[_nghost-%COMP%]   .addon-messages-conversation-item[_ngcontent-%COMP%]   .addon-message-last-message-text[_ngcontent-%COMP%], [_nghost-%COMP%]   .addon-message-discussion[_ngcontent-%COMP%]   .addon-message-last-message-text[_ngcontent-%COMP%]{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex-shrink:1}[_nghost-%COMP%]   .addon-message-discussion[_ngcontent-%COMP%]   .item-heading[_ngcontent-%COMP%]{margin-top:10px}[_nghost-%COMP%]   ion-item-divider[_ngcontent-%COMP%]   ion-badge[_ngcontent-%COMP%]{margin-left:16px;margin-right:16px}"]}),AddonMessagesContacts35Page})();var k=s(66198),R=s(72597),G=s(73564),x=s(86198),D=s(58197),w=s(43570);function AddonMessagesContactsPage_ng_template_19_ion_list_4_ion_item_1_ion_icon_5_Template(e,n){1&e&&(f.nrm(0,"ion-icon",20),f.nI1(1,"translate")),2&e&&f.BMQ("aria-label",f.bMT(1,1,"addon.messages.contactblocked"))}function AddonMessagesContactsPage_ng_template_19_ion_list_4_ion_item_1_Template(e,n){if(1&e){const e=f.RV6();f.j41(0,"ion-item",15),f.bIt("click",(function AddonMessagesContactsPage_ng_template_19_ion_list_4_ion_item_1_Template_ion_item_click_0_listener(){const n=f.eBV(e).$implicit,s=f.XpG(3);return f.Njj(s.selectUser(n.id))})),f.nrm(1,"core-user-avatar",16),f.j41(2,"ion-label")(3,"p",17),f.nrm(4,"core-format-text",18),f.DNE(5,AddonMessagesContactsPage_ng_template_19_ion_list_4_ion_item_1_ion_icon_5_Template,2,3,"ion-icon",19),f.k0s()()()}if(2&e){const e=n.$implicit,s=f.XpG(3);f.Y8G("detail",!0),f.BMQ("aria-label",e.fullname)("aria-current",e.id===s.selectedUserId?"page":"false"),f.R7$(),f.Y8G("user",e)("checkOnline",e.showonlinestatus)("linkProfile",!1),f.R7$(3),f.Y8G("text",e.fullname)("contextInstanceId",0),f.R7$(),f.Y8G("ngIf",e.isblocked)}}function AddonMessagesContactsPage_ng_template_19_ion_list_4_Template(e,n){if(1&e&&(f.j41(0,"ion-list",13),f.DNE(1,AddonMessagesContactsPage_ng_template_19_ion_list_4_ion_item_1_Template,6,9,"ion-item",14),f.k0s()),2&e){const e=f.XpG(2);f.R7$(),f.Y8G("ngForOf",e.confirmedContacts)}}function AddonMessagesContactsPage_ng_template_19_core_empty_box_5_Template(e,n){1&e&&(f.nrm(0,"core-empty-box",21),f.nI1(1,"translate")),2&e&&f.Y8G("message",f.bMT(1,1,"addon.messages.nocontactsgetstarted"))}function AddonMessagesContactsPage_ng_template_19_Template(e,n){if(1&e){const e=f.RV6();f.j41(0,"ion-refresher",8),f.bIt("ionRefresh",(function AddonMessagesContactsPage_ng_template_19_Template_ion_refresher_ionRefresh_0_listener(n){f.eBV(e);const s=f.XpG();return f.Njj(s.refreshData(n.target))})),f.nrm(1,"ion-refresher-content",9),f.nI1(2,"translate"),f.k0s(),f.j41(3,"core-loading",5),f.DNE(4,AddonMessagesContactsPage_ng_template_19_ion_list_4_Template,2,1,"ion-list",10)(5,AddonMessagesContactsPage_ng_template_19_core_empty_box_5_Template,2,3,"core-empty-box",11),f.j41(6,"core-infinite-loading",12),f.bIt("action",(function AddonMessagesContactsPage_ng_template_19_Template_core_infinite_loading_action_6_listener(n){f.eBV(e);const s=f.XpG();return f.Njj(s.loadMore(n))})),f.k0s()()}if(2&e){const e=f.XpG();f.Y8G("disabled",!e.confirmedLoaded),f.R7$(),f.FS9("pullingText",f.bMT(2,7,"core.pulltorefresh")),f.R7$(2),f.Y8G("hideUntil",e.confirmedLoaded),f.R7$(),f.Y8G("ngIf",e.confirmedContacts.length),f.R7$(),f.Y8G("ngIf",!e.confirmedContacts.length),f.R7$(),f.Y8G("enabled",e.confirmedCanLoadMore)("error",e.confirmedLoadMoreError)}}function AddonMessagesContactsPage_ng_template_22_ion_list_4_ion_item_1_p_4_Template(e,n){1&e&&(f.j41(0,"p"),f.EFF(1),f.nI1(2,"translate"),f.k0s()),2&e&&(f.R7$(),f.SpI(" ",f.bMT(2,1,"addon.messages.wouldliketocontactyou")," "))}function AddonMessagesContactsPage_ng_template_22_ion_list_4_ion_item_1_Template(e,n){if(1&e){const e=f.RV6();f.j41(0,"ion-item",15),f.bIt("click",(function AddonMessagesContactsPage_ng_template_22_ion_list_4_ion_item_1_Template_ion_item_click_0_listener(){const n=f.eBV(e).$implicit,s=f.XpG(3);return f.Njj(s.selectUser(n.id))})),f.nrm(1,"core-user-avatar",22),f.j41(2,"ion-label"),f.nrm(3,"core-format-text",18),f.DNE(4,AddonMessagesContactsPage_ng_template_22_ion_list_4_ion_item_1_p_4_Template,3,3,"p",23),f.k0s()()}if(2&e){const e=n.$implicit,s=f.XpG(3);f.Y8G("detail",!0),f.BMQ("aria-label",e.fullname)("aria-current",e.id===s.selectedUserId?"page":"false"),f.R7$(),f.Y8G("user",e)("linkProfile",!1),f.R7$(2),f.Y8G("text",e.fullname)("contextInstanceId",0),f.R7$(),f.Y8G("ngIf",!e.iscontact)}}function AddonMessagesContactsPage_ng_template_22_ion_list_4_Template(e,n){if(1&e&&(f.j41(0,"ion-list",13),f.DNE(1,AddonMessagesContactsPage_ng_template_22_ion_list_4_ion_item_1_Template,5,8,"ion-item",14),f.k0s()),2&e){const e=f.XpG(2);f.R7$(),f.Y8G("ngForOf",e.requests)}}function AddonMessagesContactsPage_ng_template_22_core_empty_box_5_Template(e,n){1&e&&(f.nrm(0,"core-empty-box",21),f.nI1(1,"translate")),2&e&&f.Y8G("message",f.bMT(1,1,"addon.messages.nocontactrequests"))}function AddonMessagesContactsPage_ng_template_22_Template(e,n){if(1&e){const e=f.RV6();f.j41(0,"ion-refresher",8),f.bIt("ionRefresh",(function AddonMessagesContactsPage_ng_template_22_Template_ion_refresher_ionRefresh_0_listener(n){f.eBV(e);const s=f.XpG();return f.Njj(s.refreshData(n.target))})),f.nrm(1,"ion-refresher-content",9),f.nI1(2,"translate"),f.k0s(),f.j41(3,"core-loading",5),f.DNE(4,AddonMessagesContactsPage_ng_template_22_ion_list_4_Template,2,1,"ion-list",10)(5,AddonMessagesContactsPage_ng_template_22_core_empty_box_5_Template,2,3,"core-empty-box",11),f.j41(6,"core-infinite-loading",12),f.bIt("action",(function AddonMessagesContactsPage_ng_template_22_Template_core_infinite_loading_action_6_listener(n){f.eBV(e);const s=f.XpG();return f.Njj(s.loadMore(n))})),f.k0s()()}if(2&e){const e=f.XpG();f.Y8G("disabled",!e.requestsLoaded),f.R7$(),f.FS9("pullingText",f.bMT(2,7,"core.pulltorefresh")),f.R7$(2),f.Y8G("hideUntil",e.requestsLoaded),f.R7$(),f.Y8G("ngIf",e.requests.length),f.R7$(),f.Y8G("ngIf",!e.requests.length),f.R7$(),f.Y8G("enabled",e.requestsCanLoadMore)("error",e.requestsLoadMoreError)}}let $=(()=>{var e;class AddonMessagesContactsPage{constructor(){this.selected="confirmed",this.requestsBadge="",this.confirmedLoaded=!1,this.confirmedInitialising=!1,this.confirmedCanLoadMore=!1,this.confirmedLoadMoreError=!1,this.confirmedContacts=[],this.requestsLoaded=!1,this.requestsInitialising=!1,this.requestsCanLoadMore=!1,this.requestsLoadMoreError=!1,this.requests=[],this.siteId=i.CoreSites.getCurrentSiteId(),this.contactRequestsCountObserver=d.z.on(h.l3,(e=>{this.requestsBadge=e.count>0?String(e.count):""}),this.siteId),this.memberInfoObserver=d.z.on(h.Ie,(e=>{if(e.userBlocked||e.userUnblocked){const n=this.confirmedContacts.find((n=>n.id==e.userId));n&&(n.isblocked=!!e.userBlocked)}else if(e.contactRemoved){const n=this.confirmedContacts.findIndex((n=>n.id==e.userId));n>=0&&this.confirmedContacts.splice(n,1)}else e.contactRequestConfirmed&&this.confirmedFetchData(!0);if(e.contactRequestConfirmed||e.contactRequestDeclined){const n=this.requests.findIndex((n=>n.id==e.userId));n>=0&&this.requests.splice(n,1)}}),i.CoreSites.getCurrentSiteId())}ngOnInit(){var e=this;return(0,a.A)((function*(){r.AddonMessages.getContactRequestsCount(e.siteId),"confirmed"===e.selected?yield e.initConfirmed():yield e.initRequests()}))()}initConfirmed(){var e=this;return(0,a.A)((function*(){if(!e.confirmedInitialising)try{e.confirmedInitialising=!0,yield e.confirmedFetchData(),e.confirmedContacts.length&&g.CoreScreen.isTablet&&e.selectUser(e.confirmedContacts[0].id,!0)}finally{e.confirmedInitialising=!1,e.confirmedLoaded=!0}}))()}initRequests(){var e=this;return(0,a.A)((function*(){if(!e.requestsInitialising)try{e.requestsInitialising=!0,yield e.requestsFetchData(),e.requests.length&&g.CoreScreen.isTablet&&e.selectUser(e.requests[0].id,!0)}finally{e.requestsInitialising=!1,e.requestsLoaded=!0}}))()}confirmedFetchData(e=!1){var n=this;return(0,a.A)((function*(){n.confirmedLoadMoreError=!1;const s=e?0:n.confirmedContacts.length;0===s&&(yield r.AddonMessages.invalidateUserContacts());try{const t=yield r.AddonMessages.getUserContacts(s);n.confirmedContacts=e?t.contacts:n.confirmedContacts.concat(t.contacts),n.confirmedCanLoadMore=t.canLoadMore}catch(e){n.confirmedLoadMoreError=!0,c.CoreDomUtils.showErrorModalDefault(e,"addon.messages.errorwhileretrievingcontacts",!0)}}))()}requestsFetchData(e=!1){var n=this;return(0,a.A)((function*(){n.requestsLoadMoreError=!1;const s=e?0:n.requests.length;0===s&&(yield r.AddonMessages.invalidateContactRequestsCache());try{const t=yield r.AddonMessages.getContactRequests(s);n.requests=e?t.requests:n.requests.concat(t.requests),n.requestsCanLoadMore=t.canLoadMore}catch(e){n.requestsLoadMoreError=!0,c.CoreDomUtils.showErrorModalDefault(e,"addon.messages.errorwhileretrievingcontacts",!0)}}))()}refreshData(e){var n=this;return(0,a.A)((function*(){try{"confirmed"==n.selected?yield n.confirmedFetchData(!0):(r.AddonMessages.refreshContactRequestsCount(),yield n.requestsFetchData(!0))}finally{null==e||e.complete()}}))()}loadMore(e){var n=this;return(0,a.A)((function*(){try{"confirmed"==n.selected?yield n.confirmedFetchData():yield n.requestsFetchData()}finally{e&&e()}}))()}gotoSearch(){_.CoreNavigator.navigateToSitePath("search")}selectTab(e){"confirmed"!==e&&"requests"!==e||(this.selected=e,"confirmed"!=this.selected||this.confirmedLoaded||this.initConfirmed(),"requests"!=this.selected||this.requestsLoaded||this.initRequests())}selectUser(e,n=!1){if(e==this.selectedUserId&&g.CoreScreen.isTablet)return;if(n&&g.CoreScreen.isMobile)return;this.selectedUserId=e;const s=_.CoreNavigator.getRelativePathToParent("/messages/contacts")+`discussion/user/${e}`;_.CoreNavigator.navigate(s,{reset:g.CoreScreen.isTablet&&!!this.splitView&&!this.splitView.isNested})}ngOnDestroy(){var e;null===(e=this.contactRequestsCountObserver)||void 0===e||e.off()}}return(e=AddonMessagesContactsPage).ɵfac=function AddonMessagesContactsPage_Factory(n){return new(n||e)},e.ɵcmp=f.VBU({type:e,selectors:[["page-addon-messages-contacts"]],viewQuery:function AddonMessagesContactsPage_Query(e,n){if(1&e&&f.GBs(m.M,5),2&e){let e;f.mGM(e=f.lsd())&&(n.splitView=e.first)}},decls:23,vars:17,consts:[["slot","start"],[3,"text"],["slot","end"],["fill","clear",3,"click","ariaLabel"],["name","fas-magnifying-glass","slot","icon-only","aria-hidden","true"],[3,"hideUntil"],[3,"ionSelect","title"],["badgeA11yText","addon.messages.pendingcontactrequests",3,"ionSelect","title","badge"],["slot","fixed",3,"ionRefresh","disabled"],[3,"pullingText"],["class","ion-no-margin",4,"ngIf"],["icon","far-address-book",3,"message",4,"ngIf"],["position","bottom",3,"action","enabled","error"],[1,"ion-no-margin"],["class","ion-text-wrap addon-messages-conversation-item","button","",3,"detail","click",4,"ngFor","ngForOf"],["button","",1,"ion-text-wrap","addon-messages-conversation-item",3,"click","detail"],["slot","start",3,"user","checkOnline","linkProfile"],[1,"item-heading"],["contextLevel","system",3,"text","contextInstanceId"],["name","fas-user-slash","slot","end",4,"ngIf"],["name","fas-user-slash","slot","end"],["icon","far-address-book",3,"message"],["slot","start",3,"user","linkProfile"],[4,"ngIf"]],template:function AddonMessagesContactsPage_Template(e,n){1&e&&(f.j41(0,"ion-header")(1,"ion-toolbar")(2,"ion-buttons",0),f.nrm(3,"ion-back-button",1),f.nI1(4,"translate"),f.k0s(),f.j41(5,"ion-title")(6,"h1"),f.EFF(7),f.nI1(8,"translate"),f.k0s()(),f.j41(9,"ion-buttons",2)(10,"ion-button",3),f.nI1(11,"translate"),f.bIt("click",(function AddonMessagesContactsPage_Template_ion_button_click_10_listener(){return n.gotoSearch()})),f.nrm(12,"ion-icon",4),f.k0s(),f.nrm(13,"core-context-menu"),f.k0s()()(),f.j41(14,"ion-content")(15,"core-split-view")(16,"core-tabs",5)(17,"core-tab",6),f.nI1(18,"translate"),f.bIt("ionSelect",(function AddonMessagesContactsPage_Template_core_tab_ionSelect_17_listener(){return n.selectTab("confirmed")})),f.DNE(19,AddonMessagesContactsPage_ng_template_19_Template,7,9,"ng-template"),f.k0s(),f.j41(20,"core-tab",7),f.nI1(21,"translate"),f.bIt("ionSelect",(function AddonMessagesContactsPage_Template_core_tab_ionSelect_20_listener(){return n.selectTab("requests")})),f.DNE(22,AddonMessagesContactsPage_ng_template_22_Template,7,9,"ng-template"),f.k0s()()()()),2&e&&(f.R7$(3),f.Y8G("text",f.bMT(4,7,"core.back")),f.R7$(4),f.JRh(f.bMT(8,9,"addon.messages.contacts")),f.R7$(3),f.Y8G("ariaLabel",f.bMT(11,11,"addon.messages.searchcombined")),f.R7$(6),f.Y8G("hideUntil",!0),f.R7$(),f.Y8G("title",f.bMT(18,13,"addon.messages.contacts")),f.R7$(3),f.Y8G("title",f.bMT(21,15,"addon.messages.requests"))("badge",n.requestsBadge))},dependencies:[M.Sq,M.bT,v.B,C.h,k.b,b.R,m.M,R.K,G.h,P.T,x.t,D.B,I.i,w.T,O.Jm,O.QW,O.W9,O.eU,O.iq,O.uz,O.he,O.nf,O.To,O.Ki,O.BC,O.ai,O.el,T.D9],styles:["[_nghost-%COMP%]   .addon-messages-conversation-item[_ngcontent-%COMP%]   ion-label[_ngcontent-%COMP%], [_nghost-%COMP%]   .addon-message-discussion[_ngcontent-%COMP%]   ion-label[_ngcontent-%COMP%]{margin-right:0;margin-left:0}[_nghost-%COMP%]   .addon-messages-conversation-item[_ngcontent-%COMP%]   .item-heading[_ngcontent-%COMP%]   core-format-text[_ngcontent-%COMP%], [_nghost-%COMP%]   .addon-message-discussion[_ngcontent-%COMP%]   .item-heading[_ngcontent-%COMP%]   core-format-text[_ngcontent-%COMP%]{font-weight:700}[_nghost-%COMP%]   .addon-messages-conversation-item[_ngcontent-%COMP%]   .item-heading[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%], [_nghost-%COMP%]   .addon-message-discussion[_ngcontent-%COMP%]   .item-heading[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{margin-inline-start:2px}[_nghost-%COMP%]   .addon-messages-conversation-item[_ngcontent-%COMP%]   ion-note[_ngcontent-%COMP%], [_nghost-%COMP%]   .addon-message-discussion[_ngcontent-%COMP%]   ion-note[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-self:flex-start;margin-inline-start:2px}[_nghost-%COMP%]   .addon-messages-conversation-item[_ngcontent-%COMP%]   ion-note[_ngcontent-%COMP%]   ion-badge[_ngcontent-%COMP%], [_nghost-%COMP%]   .addon-messages-conversation-item[_ngcontent-%COMP%]   ion-note[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%], [_nghost-%COMP%]   .addon-message-discussion[_ngcontent-%COMP%]   ion-note[_ngcontent-%COMP%]   ion-badge[_ngcontent-%COMP%], [_nghost-%COMP%]   .addon-message-discussion[_ngcontent-%COMP%]   ion-note[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{margin-top:3px;align-self:flex-end}[_nghost-%COMP%]   .addon-messages-conversation-item[_ngcontent-%COMP%]   ion-note[_ngcontent-%COMP%]   .addon-message-last-message-date[_ngcontent-%COMP%], [_nghost-%COMP%]   .addon-message-discussion[_ngcontent-%COMP%]   ion-note[_ngcontent-%COMP%]   .addon-message-last-message-date[_ngcontent-%COMP%]{white-space:nowrap;font-size:.6875rem}[_nghost-%COMP%]   .addon-messages-conversation-item[_ngcontent-%COMP%]   .addon-message-last-message[_ngcontent-%COMP%], [_nghost-%COMP%]   .addon-message-discussion[_ngcontent-%COMP%]   .addon-message-last-message[_ngcontent-%COMP%]{display:flex;justify-content:flex-start}[_nghost-%COMP%]   .addon-messages-conversation-item[_ngcontent-%COMP%]   .addon-message-last-message-user[_ngcontent-%COMP%], [_nghost-%COMP%]   .addon-message-discussion[_ngcontent-%COMP%]   .addon-message-last-message-user[_ngcontent-%COMP%]{white-space:nowrap;color:var(--ion-text-color);margin-inline-end:2px}[_nghost-%COMP%]   .addon-messages-conversation-item[_ngcontent-%COMP%]   .addon-message-last-message-text[_ngcontent-%COMP%], [_nghost-%COMP%]   .addon-message-discussion[_ngcontent-%COMP%]   .addon-message-last-message-text[_ngcontent-%COMP%]{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex-shrink:1}[_nghost-%COMP%]   .addon-message-discussion[_ngcontent-%COMP%]   .item-heading[_ngcontent-%COMP%]{margin-top:10px}[_nghost-%COMP%]   ion-item-divider[_ngcontent-%COMP%]   ion-badge[_ngcontent-%COMP%]{margin-left:16px;margin-right:16px}"]}),AddonMessagesContactsPage})();var S=s(47050),E=s(59534),j=s(98870),F=s(55554),N=s(6787),Y=s(89377),U=s(96508),q=s.n(U),B=s(75629),L=s(74431),V=s(82907),X=s(75383),z=s(53794),Q=s(6319),J=s(23780),H=s(17388),W=s(28042),K=s(13988),Z=s(85122),ee=s(10892),ne=s(19858),se=s(59528);const _c0=e=>({$a:e});function AddonMessagesDiscussionPage_img_7_Template(e,n){if(1&e&&f.nrm(0,"img",25),2&e){const e=f.XpG();f.Y8G("url",e.conversationImage)("siteId",e.siteId)}}function AddonMessagesDiscussionPage_core_user_avatar_8_Template(e,n){if(1&e&&f.nrm(0,"core-user-avatar",26),2&e){const e=f.XpG();f.Y8G("user",e.otherMember)("linkProfile",!1)("checkOnline",e.otherMember.showonlinestatus)}}function AddonMessagesDiscussionPage_ion_icon_10_Template(e,n){1&e&&(f.nrm(0,"ion-icon",27),f.nI1(1,"translate")),2&e&&f.BMQ("aria-label",f.bMT(1,1,"core.favourites"))}function AddonMessagesDiscussionPage_ion_icon_11_Template(e,n){1&e&&(f.nrm(0,"ion-icon",28),f.nI1(1,"translate")),2&e&&f.BMQ("aria-label",f.bMT(1,1,"addon.messages.mutedconversation"))}function AddonMessagesDiscussionPage_ng_container_43_Template(e,n){1&e&&(f.qex(0),f.j41(1,"p",29),f.EFF(2),f.nI1(3,"translate"),f.k0s(),f.j41(4,"p",29)(5,"em"),f.EFF(6),f.nI1(7,"translate"),f.k0s()(),f.bVm()),2&e&&(f.R7$(2),f.JRh(f.bMT(3,2,"addon.messages.selfconversation")),f.R7$(4),f.JRh(f.bMT(7,4,"addon.messages.selfconversationdefaultmessage")))}function AddonMessagesDiscussionPage_ng_container_47_h3_1_Template(e,n){if(1&e&&(f.j41(0,"h3",33),f.EFF(1),f.nI1(2,"coreFormatDate"),f.k0s()),2&e){const e=f.XpG().$implicit;f.R7$(),f.SpI(" ",f.i5U(2,1,e.timecreated,"strftimedayshort")," ")}}function AddonMessagesDiscussionPage_ng_container_47_ion_chip_2_Template(e,n){1&e&&(f.j41(0,"ion-chip",34)(1,"ion-label"),f.EFF(2),f.nI1(3,"translate"),f.k0s(),f.nrm(4,"ion-icon",35),f.k0s()),2&e&&(f.R7$(2),f.JRh(f.bMT(3,1,"addon.messages.newmessages")))}function AddonMessagesDiscussionPage_ng_container_47_Template(e,n){if(1&e){const e=f.RV6();f.qex(0),f.DNE(1,AddonMessagesDiscussionPage_ng_container_47_h3_1_Template,3,4,"h3",30)(2,AddonMessagesDiscussionPage_ng_container_47_ion_chip_2_Template,5,3,"ion-chip",31),f.j41(3,"core-message",32),f.bIt("afterRender",(function AddonMessagesDiscussionPage_ng_container_47_Template_core_message_afterRender_3_listener(){const n=f.eBV(e).last,s=f.XpG();return f.Njj(n&&s.scrollToBottom())}))("onDeleteMessage",(function AddonMessagesDiscussionPage_ng_container_47_Template_core_message_onDeleteMessage_3_listener(){const n=f.eBV(e),s=n.$implicit,t=n.index,o=f.XpG();return f.Njj(o.deleteMessage(s,t))})),f.k0s(),f.bVm()}if(2&e){const e=n.$implicit,s=f.XpG();f.R7$(),f.Y8G("ngIf",e.showDate),f.R7$(),f.Y8G("ngIf",s.unreadMessageFrom>0&&e.id===s.unreadMessageFrom),f.R7$(),f.Y8G("message",e)("user",s.members[e.useridfrom])("text",e.text)("showDelete",s.showDelete)("time",e.timecreated)}}function AddonMessagesDiscussionPage_core_empty_box_48_Template(e,n){1&e&&(f.nrm(0,"core-empty-box",36),f.nI1(1,"translate")),2&e&&f.Y8G("message",f.bMT(1,1,"addon.messages.nomessagesfound"))}function AddonMessagesDiscussionPage_ion_fab_49_Template(e,n){if(1&e){const e=f.RV6();f.j41(0,"ion-fab",37)(1,"ion-fab-button",38),f.nI1(2,"translate"),f.bIt("click",(function AddonMessagesDiscussionPage_ion_fab_49_Template_ion_fab_button_click_1_listener(){f.eBV(e);const n=f.XpG();return f.Njj(n.scrollToFirstUnreadMessage())})),f.nrm(3,"ion-icon",35),f.j41(4,"span",19),f.EFF(5),f.nI1(6,"translate"),f.k0s()(),f.j41(7,"ion-badge",39),f.EFF(8),f.k0s()()}if(2&e){const e=f.XpG();f.R7$(),f.BMQ("aria-label",f.bMT(2,3,"addon.messages.newmessages")),f.R7$(4),f.JRh(f.bMT(6,5,"addon.messages.newmessages")),f.R7$(3),f.JRh(e.newMessages)}}function AddonMessagesDiscussionPage_ion_footer_50_p_2_Template(e,n){1&e&&(f.j41(0,"p",45),f.EFF(1),f.nI1(2,"translate"),f.k0s()),2&e&&(f.R7$(),f.SpI(" ",f.bMT(2,1,"addon.messages.unabletomessage")," "))}function AddonMessagesDiscussionPage_ion_footer_50_div_3_Template(e,n){if(1&e){const e=f.RV6();f.j41(0,"div",46)(1,"p",29),f.EFF(2),f.nI1(3,"translate"),f.k0s(),f.j41(4,"ion-button",47),f.bIt("click",(function AddonMessagesDiscussionPage_ion_footer_50_div_3_Template_ion_button_click_4_listener(){f.eBV(e);const n=f.XpG(2);return f.Njj(n.unblockUser())})),f.EFF(5),f.nI1(6,"translate"),f.k0s()()}2&e&&(f.R7$(2),f.JRh(f.bMT(3,2,"addon.messages.youhaveblockeduser")),f.R7$(3),f.SpI(" ",f.bMT(6,4,"addon.messages.unblockuser")," "))}function AddonMessagesDiscussionPage_ion_footer_50_div_4_Template(e,n){if(1&e){const e=f.RV6();f.j41(0,"div",46)(1,"p",29)(2,"strong"),f.EFF(3),f.nI1(4,"translate"),f.k0s()(),f.j41(5,"p",29),f.EFF(6),f.nI1(7,"translate"),f.k0s(),f.j41(8,"ion-button",47),f.bIt("click",(function AddonMessagesDiscussionPage_ion_footer_50_div_4_Template_ion_button_click_8_listener(){f.eBV(e);const n=f.XpG(2);return f.Njj(n.createContactRequest())})),f.EFF(9),f.nI1(10,"translate"),f.k0s()()}if(2&e){const e=f.XpG(2);f.R7$(3),f.JRh(f.i5U(4,3,"addon.messages.isnotinyourcontacts",f.eq3(11,_c0,e.otherMember.fullname))),f.R7$(3),f.JRh(f.i5U(7,6,"addon.messages.requirecontacttomessage",f.eq3(13,_c0,e.otherMember.fullname))),f.R7$(3),f.SpI(" ",f.bMT(10,9,"addon.messages.sendcontactrequest")," ")}}function AddonMessagesDiscussionPage_ion_footer_50_div_5_Template(e,n){if(1&e){const e=f.RV6();f.j41(0,"div",46)(1,"p",29),f.EFF(2),f.nI1(3,"translate"),f.k0s(),f.j41(4,"ion-button",47),f.bIt("click",(function AddonMessagesDiscussionPage_ion_footer_50_div_5_Template_ion_button_click_4_listener(){f.eBV(e);const n=f.XpG(2);return f.Njj(n.confirmContactRequest())})),f.EFF(5),f.nI1(6,"translate"),f.k0s(),f.j41(7,"ion-button",48),f.bIt("click",(function AddonMessagesDiscussionPage_ion_footer_50_div_5_Template_ion_button_click_7_listener(){f.eBV(e);const n=f.XpG(2);return f.Njj(n.declineContactRequest())})),f.EFF(8),f.nI1(9,"translate"),f.k0s()()}if(2&e){const e=f.XpG(2);f.R7$(2),f.JRh(f.i5U(3,3,"addon.messages.userwouldliketocontactyou",f.eq3(10,_c0,e.otherMember.fullname))),f.R7$(3),f.SpI(" ",f.bMT(6,6,"addon.messages.acceptandaddcontact")," "),f.R7$(3),f.SpI(" ",f.bMT(9,8,"addon.messages.decline")," ")}}function AddonMessagesDiscussionPage_ion_footer_50_div_6_p_5_Template(e,n){if(1&e&&(f.j41(0,"p",29),f.EFF(1),f.nI1(2,"translate"),f.k0s()),2&e){const e=f.XpG(3);f.R7$(),f.SpI(" ",f.i5U(2,1,"addon.messages.yourcontactrequestpending",f.eq3(4,_c0,e.otherMember.fullname))," ")}}function AddonMessagesDiscussionPage_ion_footer_50_div_6_Template(e,n){if(1&e&&(f.j41(0,"div",46)(1,"p",29)(2,"strong"),f.EFF(3),f.nI1(4,"translate"),f.k0s()(),f.DNE(5,AddonMessagesDiscussionPage_ion_footer_50_div_6_p_5_Template,3,6,"p",49),f.k0s()),2&e){const e=f.XpG(2);f.R7$(3),f.JRh(f.bMT(4,2,"addon.messages.contactrequestsent")),f.R7$(2),f.Y8G("ngIf",e.otherMember)}}function AddonMessagesDiscussionPage_ion_footer_50_core_send_message_form_7_Template(e,n){if(1&e){const e=f.RV6();f.j41(0,"core-send-message-form",50),f.nI1(1,"translate"),f.bIt("onSubmit",(function AddonMessagesDiscussionPage_ion_footer_50_core_send_message_form_7_Template_core_send_message_form_onSubmit_0_listener(n){f.eBV(e);const s=f.XpG(2);return f.Njj(s.sendMessage(n))})),f.k0s()}if(2&e){const e=f.XpG(2);f.Y8G("showKeyboard",e.showKeyboard)("placeholder",f.bMT(1,2,"addon.messages.newmessage"))}}function AddonMessagesDiscussionPage_ion_footer_50_Template(e,n){if(1&e&&(f.j41(0,"ion-footer",40)(1,"ion-toolbar",41),f.DNE(2,AddonMessagesDiscussionPage_ion_footer_50_p_2_Template,3,3,"p",42)(3,AddonMessagesDiscussionPage_ion_footer_50_div_3_Template,7,6,"div",43)(4,AddonMessagesDiscussionPage_ion_footer_50_div_4_Template,11,15,"div",43)(5,AddonMessagesDiscussionPage_ion_footer_50_div_5_Template,10,12,"div",43)(6,AddonMessagesDiscussionPage_ion_footer_50_div_6_Template,6,4,"div",43)(7,AddonMessagesDiscussionPage_ion_footer_50_core_send_message_form_7_Template,2,4,"core-send-message-form",44),f.k0s()()),2&e){const e=f.XpG();f.R7$(),f.Y8G("color","message"===e.footerType?null:"light"),f.R7$(),f.Y8G("ngIf","unable"===e.footerType),f.R7$(),f.Y8G("ngIf","blocked"===e.footerType),f.R7$(),f.Y8G("ngIf","requiresContact"===e.footerType&&e.otherMember),f.R7$(),f.Y8G("ngIf","requestReceived"===e.footerType&&e.otherMember),f.R7$(),f.Y8G("ngIf","requestSent"===e.footerType||"message"===e.footerType&&e.requestContactSent),f.R7$(),f.Y8G("ngIf","message"===e.footerType)}}let te=(()=>{var e;class AddonMessagesDiscussionPage{constructor(e,n){this.route=e,this.elementRef=n,this.fetching=!1,this.messagesBeingSent=0,this.pagesLoaded=1,this.keepMessageMap={},this.oldContentHeight=0,this.scrollBottom=!0,this.viewDestroyed=!1,this.showLoadingModal=!1,this.showInfo=!1,this.loaded=!1,this.showKeyboard=!1,this.canLoadMore=!1,this.loadMoreError=!1,this.messages=[],this.showDelete=!1,this.canDelete=!1,this.isGroup=!1,this.members={},this.favouriteIcon="fas-star",this.deleteIcon="fas-trash",this.blockIcon="fas-user-lock",this.addRemoveIcon="fas-user-plus",this.muteIcon="fas-bell-slash",this.muteEnabled=!1,this.footerType="unable",this.requestContactSent=!1,this.requestContactReceived=!1,this.isSelf=!1,this.newMessages=0,this.unreadMessageFrom=0,this.initialized=!1,this.hostElement=n.nativeElement,this.siteId=i.CoreSites.getCurrentSiteId(),this.currentUserId=i.CoreSites.getCurrentSiteUserId(),this.groupMessagingEnabled=r.AddonMessages.isGroupMessagingEnabled(),this.muteEnabled=r.AddonMessages.isMuteConversationEnabled(),this.logger=N.CoreLogger.getInstance("AddonMessagesDiscussionPage"),this.syncObserver=d.z.on(h.HA,(e=>{(e.userId&&e.userId==this.userId||e.conversationId&&e.conversationId==this.conversationId)&&(this.fetchMessages(),e.warnings&&e.warnings[0]&&c.CoreDomUtils.showAlert(void 0,e.warnings[0]))}),this.siteId),this.memberInfoObserver=d.z.on(h.Ie,(e=>{e.userId&&(this.members[e.userId]||this.otherMember&&e.userId==this.otherMember.id)&&this.fetchData()}),this.siteId)}ngOnInit(){var e=this;return(0,a.A)((function*(){e.conversationId=_.CoreNavigator.getRouteNumberParam("conversationId"),e.userId=_.CoreNavigator.getRouteNumberParam("userId"),e.showInfo=!_.CoreNavigator.getRouteBooleanParam("hideInfo"),e.showKeyboard=!!_.CoreNavigator.getRouteBooleanParam("showKeyboard"),yield e.fetchData(),e.scrollToBottom(!0)}))()}ngAfterViewInit(){var e=this;return(0,a.A)((function*(){var n;e.scrollElement=yield null===(n=e.content)||void 0===n?void 0:n.getScrollElement()}))()}addMessage(e,n=!0){e.hash=Y.V.hashAsciiStr(String(("id"in e?e.id:"")||e.text||""))+"#"+e.timecreated+"#"+e.useridfrom;let s=!1;return void 0===this.keepMessageMap[e.hash]&&(this.messages.push(e),s=e.useridfrom!=this.currentUserId),this.keepMessageMap[e.hash]=n,s}removeMessage(e){if(this.keepMessageMap[e])return this.keepMessageMap[e]=!1,void 0;delete this.keepMessageMap[e];const n=this.messages.findIndex((n=>n.hash==e));n>=0&&this.messages.splice(n,1)}fetchData(){var e=this;return(0,a.A)((function*(){let n;e.showLoadingModal&&(n=yield J.CoreLoadings.show()),!e.groupMessagingEnabled&&e.userId&&j.CoreUser.getProfile(e.userId,void 0,!0).then((n=>{e.title||(e.title=n.fullname),e.conversationImage=n.profileimageurl,e.members[n.id]=n})).catch((()=>{}));try{const n=yield E.AddonMessagesSync.syncDiscussion(e.conversationId,e.userId);n.warnings&&n.warnings[0]&&c.CoreDomUtils.showAlert(void 0,n.warnings[0])}catch{}try{const n=[];if(e.groupMessagingEnabled){const s=yield e.getConversation(e.conversationId,e.userId);if(s&&n.push(e.fetchMessages()),e.userId){const t=e.userId;n.push(r.AddonMessages.invalidateMemberInfo(e.userId).then((0,a.A)((function*(){e.otherMember=yield r.AddonMessages.getMemberInfo(t),!s&&e.otherMember&&(e.conversationImage=e.otherMember.profileimageurl,e.title=e.otherMember.fullname),e.blockIcon=e.otherMember.isblocked?"fas-user-check":"fas-user-lock"}))))}else e.otherMember=void 0}else{if(e.userId){const s=e.userId;n.push(j.CoreUser.getProfile(e.userId).then(function(){var n=(0,a.A)((function*(n){e.otherMember={id:n.id,fullname:n.fullname,profileurl:"",profileimageurl:n.profileimageurl||"",profileimageurlsmall:n.profileimageurlsmall||"",isonline:!1,showonlinestatus:!1,isblocked:!1,iscontact:!1,isdeleted:!1,canmessageevenifblocked:!0,canmessage:!0,requirescontact:!1},e.otherMember.isblocked=yield r.AddonMessages.isBlocked(s),e.otherMember.iscontact=yield r.AddonMessages.isContact(s),e.blockIcon=e.otherMember.isblocked?"fas-user-check":"fas-user-lock"}));return function(e){return n.apply(this,arguments)}}()))}n.push(e.fetchMessages().then((()=>{if(!e.title&&e.messages.length){const n=e.messages[0];"usertofullname"in n&&(e.title=n.useridto!=e.currentUserId?n.usertofullname||"":n.userfromfullname||"")}})))}yield Promise.all(n)}catch(e){c.CoreDomUtils.showErrorModalDefault(e,"addon.messages.errorwhileretrievingmessages",!0)}finally{e.checkCanDelete(),e.loaded=!0,e.setPolling(),e.setContactRequestInfo(),e.setFooterType(),n&&n.dismiss()}}))()}ionViewDidEnter(){this.setPolling()}ionViewWillLeave(){this.unsetPolling()}fetchMessages(e=!0){var n=this;return(0,a.A)((function*(){if(n.loadMoreError=!1,!(n.messagesBeingSent>0||n.fetching)){if(n.groupMessagingEnabled&&!n.conversationId)throw new B.CoreError("No enough data provided to fetch messages");if(n.conversationId)n.logger.debug(`Polling new messages for conversation '${n.conversationId}'`);else{if(!n.userId)throw new B.CoreError("No enough data provided to fetch messages");n.logger.debug(`Polling new messages for discussion with user '${n.userId}'`)}n.fetching=!0;try{yield E.AddonMessagesSync.waitForSyncConversation(n.conversationId,n.userId);let s=[];n.groupMessagingEnabled?(yield r.AddonMessages.invalidateConversationMessages(n.conversationId),s=yield n.getConversationMessages(n.pagesLoaded)):(yield r.AddonMessages.invalidateDiscussionCache(n.userId),s=yield n.getDiscussionMessages(n.pagesLoaded)),n.loadMessages(s,e)}finally{n.fetching=!1}}}))()}loadMessages(e,n=!0){if(this.viewDestroyed)return;if(this.scrollBottom=V.y.scrollIsBottom(this.scrollElement,5),this.messagesBeingSent>0)return;const s=e.reduce(((e,n)=>e+(this.addMessage(n)?1:0)),0);n&&this.setNewMessagesBadge(this.newMessages+s);for(const e in this.keepMessageMap)this.removeMessage(e);r.AddonMessages.sortMessages(this.messages),this.messages.forEach(((e,n)=>{e.showDate=this.showDate(e,this.messages[n-1]),e.showUserData=this.showUserData(e,this.messages[n-1]),e.showTail=this.showTail(e,this.messages[n+1])}));const t=this.messages[this.messages.length-1],o=this.groupMessagingEnabled&&t&&t.useridfrom!==this.currentUserId&&!!this.lastMessage&&(t.text!==this.lastMessage.text||t.timecreated!==this.lastMessage.timecreated);this.notifyNewMessage(),this.markMessagesAsRead(o)}setNewMessagesBadge(e){0==this.newMessages&&e>0&&this.scrollFunction(),this.newMessages=e}scrollFunction(){var e;if(0==this.newMessages)return;if(V.y.scrollIsBottom(this.scrollElement,40))return this.setNewMessagesBadge(0),void 0;const n=null===(e=this.scrollElement)||void 0===e?void 0:e.getBoundingClientRect(),s=n&&n.bottom||0;if(0==s)return;const t=Array.from(this.hostElement.querySelectorAll("core-message:not(.is-mine)")).slice(-this.newMessages).reverse().findIndex((e=>{const n=e.getBoundingClientRect();return!!n&&n.bottom<=s}));t>0&&t<this.newMessages&&this.setNewMessagesBadge(t)}getConversation(e,n){var s=this;return(0,a.A)((function*(){let t;if(!e&&n)try{t=n===s.currentUserId&&r.AddonMessages.isSelfConversationEnabled()?yield r.AddonMessages.getSelfConversation():yield r.AddonMessages.getConversationBetweenUsers(n,void 0,!0),e=t.id}catch(e){s.isSelf=n===s.currentUserId;const t=yield S.AddonMessagesOffline.getMessages(n);if(t&&t.length)t.forEach((e=>{e.pending=!0,e.text=e.smallmessage})),s.loadMessages(t);else if("errorconversationdoesnotexist"!=e.errorcode)throw e;return!1}if(!e)return!1;yield r.AddonMessages.invalidateConversation(e);try{s.conversation=yield r.AddonMessages.getConversation(e,void 0,!0)}catch(e){if(!t)throw e;s.conversation=t}return!!s.conversation&&(s.conversationId=s.conversation.id,s.title=s.conversation.name,s.conversationImage=s.conversation.imageurl,s.isGroup=2===s.conversation.type,s.favouriteIcon="fas-star",s.muteIcon=s.conversation.ismuted?"fas-bell":"fas-bell-slash",s.isGroup||(s.userId=s.conversation.userid),s.isSelf=3===s.conversation.type,!0)}))()}getConversationMessages(e,n=0){var s=this;return(0,a.A)((function*(){if(!s.conversationId)return[];const t=n>0,o=yield r.AddonMessages.getConversationMessages(s.conversationId,{excludePending:t,limitFrom:n});e--,o.members&&o.members.forEach((e=>{s.members[e.id]=e}));const a=o.messages;if(e>0&&o.canLoadMore){n+=h.nq;const t=yield s.getConversationMessages(e,n);return a.concat(t)}return s.canLoadMore=!!o.canLoadMore,a}))()}getDiscussionMessages(e,n=0,s=0,t=0,o=0){var i=this;return(0,a.A)((function*(){const a=n>0||s>0||t>0||o>0,c=yield r.AddonMessages.getDiscussion(i.userId,a,n,s,t,o);if(--e>0&&c.canLoadMore){c.messages.forEach((e=>{!e.pending&&"read"in e&&(e.useridfrom==i.userId?e.read?s++:n++:e.read?o++:t++)}));const a=yield i.getDiscussionMessages(e,n,s,t,o);return c.messages.concat(a)}return i.canLoadMore=c.canLoadMore,c.messages}))()}markMessagesAsRead(e){var n=this;return(0,a.A)((function*(){let s=!1,t=!1;if(e)t=!0;else if(n.groupMessagingEnabled){var o,a;t=!!(null!==(o=n.conversation)&&void 0!==o&&o.unreadcount&&(null===(a=n.conversation)||void 0===a?void 0:a.unreadcount)>0&&n.conversationId&&n.conversationId>0)}else t=n.messages.some((e=>e.useridfrom!=n.currentUserId&&"read"in e&&!e.read));t&&(n.setUnreadLabelPosition(),n.groupMessagingEnabled?yield r.AddonMessages.markAllConversationMessagesRead(n.conversationId):(yield r.AddonMessages.markAllMessagesRead(n.userId),n.messages.forEach((e=>{"read"in e&&(e.read=!0)}))),s=!0),s&&d.z.trigger(h.j_,{conversationId:n.conversationId,userId:n.userId},n.siteId)}))()}notifyNewMessage(){var e,n;const s=this.messages[this.messages.length-1];let t=!1;if(s?s.text===(null===(e=this.lastMessage)||void 0===e?void 0:e.text)&&s.timecreated===(null===(n=this.lastMessage)||void 0===n?void 0:n.timecreated)||(this.lastMessage={text:s.text||"",timecreated:s.timecreated},t=!0):(this.lastMessage=void 0,t=!0),t){var o,a,i,r,c;d.z.trigger(h.cj,{conversationId:this.conversationId,userId:this.userId,message:null===(o=this.lastMessage)||void 0===o?void 0:o.text,timecreated:null!==(a=null===(i=this.lastMessage)||void 0===i?void 0:i.timecreated)&&void 0!==a?a:0,userFrom:null!=s&&s.useridfrom?this.members[s.useridfrom]:void 0,isfavourite:!(null===(r=this.conversation)||void 0===r||!r.isfavourite),type:null===(c=this.conversation)||void 0===c?void 0:c.type},this.siteId);this.canDelete!=(s&&"id"in s&&s.id&&1==this.messages.length||this.messages.length>1)&&this.checkCanDelete()}}setUnreadLabelPosition(){if(0==this.unreadMessageFrom){if(this.groupMessagingEnabled){var e,n;if(this.conversation&&null!==(e=this.conversation)&&void 0!==e&&e.unreadcount&&(null===(n=this.conversation)||void 0===n?void 0:n.unreadcount)>0&&this.messages){let e=0;for(let n=this.messages.length-1;n>=0;n--){const s=this.messages[n];if(!s.pending&&s.useridfrom!=this.currentUserId&&"id"in s&&(e++,e==this.conversation.unreadcount)){this.unreadMessageFrom=Number(s.id);break}}}}else{let e=!1;for(const n in this.messages){const s=this.messages[n];if(s.useridfrom!=this.currentUserId&&"read"in s){if(!s.read&&e){this.unreadMessageFrom=Number(s.id);break}e=!!s.read}}}0==this.unreadMessageFrom&&(this.unreadMessageFrom=-1)}}checkCanDelete(){const e=this.messages[0];this.canDelete=e&&!e.sending}hideUnreadLabel(){this.unreadMessageFrom>0&&(this.unreadMessageFrom=-1)}waitForFetch(){var e=this;return(0,a.A)((function*(){e.fetching&&(yield z.H.wait(400),yield F.g.ignoreErrors(e.waitForFetch()))}))()}setPolling(){this.groupMessagingEnabled&&!this.conversationId||this.polling||(this.polling=window.setInterval((()=>{this.fetchMessages().catch((()=>{}))}),h.ib))}unsetPolling(){this.polling&&(this.logger.debug(`Cancelling polling for conversation with user '${this.userId}'`),clearInterval(this.polling),this.polling=void 0)}copyMessage(e){X.Ni.copyToClipboard(X.Ni.decodeHTMLEntities("smallmessage"in e?e.smallmessage||e.text||"":e.text||""))}deleteMessage(e,n){var s=this;return(0,a.A)((function*(){const t=s.conversation&&s.conversation.candeletemessagesforallusers,o=e.pending||t||s.isSelf?"core.areyousure":"addon.messages.deletemessageconfirmation",a={};t&&!e.pending&&(a.inputs=[{type:"checkbox",name:"deleteforall",checked:!1,value:!0,label:l.HT.instant("addon.messages.deleteforeveryone")}]);try{const t=yield c.CoreDomUtils.showConfirm(l.HT.instant(o),void 0,void 0,void 0,a),i=yield J.CoreLoadings.show("core.deleting",!0);try{yield r.AddonMessages.deleteMessage(e,t&&t[0]),s.messages.splice(n,1),s.removeMessage(e.hash),s.notifyNewMessage(),s.fetchMessages()}finally{i.dismiss()}}catch(e){c.CoreDomUtils.showErrorModalDefault(e,"addon.messages.errordeletemessage",!0)}}))()}loadPrevious(e){var n=this;return(0,a.A)((function*(){var s,t;if(!n.initialized)return e&&e(),void 0;let o=(null===(s=n.infinite)||void 0===s?void 0:s.hostElement.getBoundingClientRect().height)||0;const a=(null===(t=n.scrollElement)||void 0===t?void 0:t.scrollHeight)||0;try{yield n.waitForFetch()}finally{n.pagesLoaded++;try{var i,r;yield n.fetchMessages(!1);const e=a-((null===(i=n.scrollElement)||void 0===i?void 0:i.scrollTop)||0),s=(null===(r=n.infinite)||void 0===r?void 0:r.hostElement.getBoundingClientRect().height)||0;n.canLoadMore&&o&&n.infinite?o-=s:n.canLoadMore||(o=o||s),n.keepScroll(a,e,o)}catch(e){n.loadMoreError=!0,n.pagesLoaded--,c.CoreDomUtils.showErrorModalDefault(e,"addon.messages.errorwhileretrievingmessages",!0)}finally{e&&e()}}}))()}keepScroll(e,n,s,t=0){setTimeout((()=>{var o;if(((null===(o=this.scrollElement)||void 0===o?void 0:o.scrollHeight)||0)==e)return t<=10&&this.keepScroll(e,n,s,t+1),void 0;setTimeout((()=>{var e;const t=(null===(e=this.scrollElement)||void 0===e?void 0:e.scrollHeight)||0;this.content.scrollToPoint(0,t-n+s,0)}),30)}),30)}scrollToBottom(e=!1){var n=this;return(0,a.A)((function*(){(n.scrollBottom||e)&&(n.scrollBottom=!1,n.setNewMessagesBadge(0),yield z.H.nextTicks(5),!n.viewDestroyed&&n.content&&n.content.scrollToBottom(0),e&&(n.initialized=!0))}))()}scrollToFirstUnreadMessage(){if(this.newMessages>0){const e=Array.from(this.hostElement.querySelectorAll("core-message:not(.is-mine)"));V.y.scrollToElement(e[e.length-this.newMessages])}}sendMessage(e){var n=this;return(0,a.A)((function*(){n.hideUnreadLabel(),n.showDelete=!1,n.scrollBottom=!0,n.setNewMessagesBadge(0);const s={id:-1,pending:!0,sending:!0,useridfrom:n.currentUserId,smallmessage:e,text:e,timecreated:Date.now()};s.showDate=n.showDate(s,n.messages[n.messages.length-1]),n.addMessage(s,!1),n.messagesBeingSent++;try{yield n.waitForFetch()}finally{try{let t;t=n.conversationId?yield r.AddonMessages.sendMessageToConversation(n.conversation,e):yield r.AddonMessages.sendMessage(n.userId,e),n.messagesBeingSent--;let o=!1;if(t.sent)try{if(!n.conversationId&&t.message&&"conversationid"in t.message){yield n.getConversation(t.message.conversationid,n.userId);try{yield n.fetchMessages()}finally{n.setPolling()}}else yield n.fetchMessages()}catch{o=!0}!o&&t.sent||(s.sending=!1,t.sent?s.pending=!1:t.message&&(s.timecreated=t.message.timecreated||0),n.notifyNewMessage())}catch(e){n.messagesBeingSent--,u.p.close(),c.CoreDomUtils.showErrorModalDefault(e,"addon.messages.messagenotsent",!0),n.removeMessage(s.hash)}}}))()}showDate(e,n){return!n||!q()(e.timecreated).isSame(n.timecreated,"day")}showUserData(e,n){return this.isGroup&&e.useridfrom!=this.currentUserId&&this.members[e.useridfrom||0]&&(!n||n.useridfrom!=e.useridfrom||!!e.showDate)}showTail(e,n){return!n||n.useridfrom!=e.useridfrom||!!n.showDate}viewInfo(){var e=this;return(0,a.A)((function*(){if(e.isGroup){const{AddonMessagesConversationInfoComponent:n}=yield s.e(8995).then(s.bind(s,78995)),t=yield Q.I.openSideModal({component:n,componentProps:{conversationId:e.conversationId}});if(void 0!==t){_.CoreNavigator.isCurrentPathInTablet("**/messages/**/discussion/**")?d.z.trigger(h.mO,{userId:t},e.siteId):_.CoreNavigator.navigateToSitePath(`/messages/discussion/user/${t}`)}}else _.CoreNavigator.navigateToSitePath("/user/profile",{params:{userId:e.userId}})}))()}changeFavourite(e){var n=this;return(0,a.A)((function*(){if(n.conversation){n.favouriteIcon=L.CoreConstants.ICON_LOADING;try{yield r.AddonMessages.setFavouriteConversation(n.conversation.id,!n.conversation.isfavourite),n.conversation.isfavourite=!n.conversation.isfavourite,r.AddonMessages.getConversation(n.conversation.id,void 0,!0),d.z.trigger(h.I2,{conversationId:n.conversation.id,action:"favourite",value:n.conversation.isfavourite},n.siteId)}catch(e){c.CoreDomUtils.showErrorModalDefault(e,"Error changing favourite state.")}finally{n.favouriteIcon="fas-star",e&&e()}}}))()}changeMute(e){var n=this;return(0,a.A)((function*(){if(n.conversation){n.muteIcon=L.CoreConstants.ICON_LOADING;try{yield r.AddonMessages.muteConversation(n.conversation.id,!n.conversation.ismuted),n.conversation.ismuted=!n.conversation.ismuted,r.AddonMessages.getConversation(n.conversation.id,void 0,!0),d.z.trigger(h.I2,{conversationId:n.conversation.id,action:"mute",value:n.conversation.ismuted},n.siteId)}catch(e){c.CoreDomUtils.showErrorModalDefault(e,"Error changing muted state.")}finally{n.muteIcon=n.conversation.ismuted?"fas-bell":"fas-bell-slash",e&&e()}}}))()}setContactRequestInfo(){var e,n;(this.requestContactSent=!1,this.requestContactReceived=!1,this.otherMember&&!this.otherMember.iscontact)&&(this.requestContactSent=!(null===(e=this.otherMember.contactrequests)||void 0===e||!e.some((e=>e.userid==this.currentUserId&&e.requesteduserid==this.otherMember.id))),this.requestContactReceived=!(null===(n=this.otherMember.contactrequests)||void 0===n||!n.some((e=>e.userid==this.otherMember.id&&e.requesteduserid==this.currentUserId))))}setFooterType(){this.footerType=this.otherMember?this.otherMember.isblocked?"blocked":this.requestContactReceived?"requestReceived":this.otherMember.canmessage?"message":this.requestContactSent?"requestSent":this.otherMember.requirescontact?"requiresContact":"unable":"message"}blockUser(){var e=this;return(0,a.A)((function*(){if(!e.otherMember)throw new B.CoreError("No member selected to be blocked.");if(e.otherMember.canmessageevenifblocked)return c.CoreDomUtils.showErrorModal(l.HT.instant("addon.messages.cantblockuser",{$a:e.otherMember.fullname})),void 0;const n=l.HT.instant("addon.messages.blockuserconfirm",{$a:e.otherMember.fullname}),s=l.HT.instant("addon.messages.blockuser");try{yield c.CoreDomUtils.showConfirm(n,void 0,s),e.blockIcon=L.CoreConstants.ICON_LOADING;const t=yield J.CoreLoadings.show("core.sending",!0);e.showLoadingModal=!0;try{try{yield r.AddonMessages.blockContact(e.otherMember.id)}finally{t.dismiss(),e.showLoadingModal=!1}}catch(e){c.CoreDomUtils.showErrorModalDefault(e,"core.error",!0)}finally{e.blockIcon=e.otherMember.isblocked?"fas-user-check":"fas-user-lock"}}catch{}}))()}deleteConversation(e){var n=this;return(0,a.A)((function*(){if(!n.conversation)return;const s="addon.messages."+(n.isSelf?"deleteallselfconfirm":"deleteallconfirm");try{yield c.CoreDomUtils.showDeleteConfirm(s),n.deleteIcon=L.CoreConstants.ICON_LOADING;try{try{yield r.AddonMessages.deleteConversation(n.conversation.id),d.z.trigger(h.I2,{conversationId:n.conversation.id,action:"delete"},n.siteId),n.messages=[]}finally{e&&e()}}catch(e){c.CoreDomUtils.showErrorModalDefault(e,"Error deleting conversation.")}finally{n.deleteIcon="fas-trash"}}catch{}}))()}unblockUser(){var e=this;return(0,a.A)((function*(){if(!e.otherMember)throw new B.CoreError("No member selected to be unblocked.");const n=l.HT.instant("addon.messages.unblockuserconfirm",{$a:e.otherMember.fullname}),s=l.HT.instant("addon.messages.unblockuser");try{yield c.CoreDomUtils.showConfirm(n,void 0,s),e.blockIcon=L.CoreConstants.ICON_LOADING;const t=yield J.CoreLoadings.show("core.sending",!0);e.showLoadingModal=!0;try{try{yield r.AddonMessages.unblockContact(e.otherMember.id)}finally{t.dismiss(),e.showLoadingModal=!1}}catch(e){c.CoreDomUtils.showErrorModalDefault(e,"core.error",!0)}finally{e.blockIcon=e.otherMember.isblocked?"fas-user-check":"fas-user-lock"}}catch{}}))()}createContactRequest(){var e=this;return(0,a.A)((function*(){if(!e.otherMember)throw new B.CoreError("No member selected to be requested.");const n=l.HT.instant("addon.messages.addcontactconfirm",{$a:e.otherMember.fullname}),s=l.HT.instant("core.add");try{yield c.CoreDomUtils.showConfirm(n,void 0,s),e.addRemoveIcon=L.CoreConstants.ICON_LOADING;const t=yield J.CoreLoadings.show("core.sending",!0);e.showLoadingModal=!0;try{try{yield r.AddonMessages.createContactRequest(e.otherMember.id)}finally{t.dismiss(),e.showLoadingModal=!1}}catch(e){c.CoreDomUtils.showErrorModalDefault(e,"core.error",!0)}finally{e.addRemoveIcon="fas-user-plus"}}catch{}}))()}confirmContactRequest(){var e=this;return(0,a.A)((function*(){if(!e.otherMember)throw new B.CoreError("No member selected to be confirmed.");const n=yield J.CoreLoadings.show("core.sending",!0);e.showLoadingModal=!0;try{try{yield r.AddonMessages.confirmContactRequest(e.otherMember.id)}finally{n.dismiss(),e.showLoadingModal=!1}}catch(e){c.CoreDomUtils.showErrorModalDefault(e,"core.error",!0)}}))()}declineContactRequest(){var e=this;return(0,a.A)((function*(){if(!e.otherMember)throw new B.CoreError("No member selected to be declined.");const n=yield J.CoreLoadings.show("core.sending",!0);e.showLoadingModal=!0;try{try{yield r.AddonMessages.declineContactRequest(e.otherMember.id)}finally{n.dismiss(),e.showLoadingModal=!1}}catch(e){c.CoreDomUtils.showErrorModalDefault(e,"core.error",!0)}}))()}removeContact(){var e=this;return(0,a.A)((function*(){if(!e.otherMember)throw new B.CoreError("No member selected to be removed.");const n=l.HT.instant("addon.messages.removecontactconfirm",{$a:e.otherMember.fullname}),s=l.HT.instant("core.remove");try{yield c.CoreDomUtils.showConfirm(n,void 0,s),e.addRemoveIcon=L.CoreConstants.ICON_LOADING;const t=yield J.CoreLoadings.show("core.sending",!0);e.showLoadingModal=!0;try{try{yield r.AddonMessages.removeContact(e.otherMember.id)}finally{t.dismiss(),e.showLoadingModal=!1}}catch(e){c.CoreDomUtils.showErrorModalDefault(e,"core.error",!0)}finally{e.addRemoveIcon="fas-user-plus"}}catch{}}))()}ngOnDestroy(){var e,n;this.unsetPolling(),null===(e=this.syncObserver)||void 0===e||e.off(),null===(n=this.memberInfoObserver)||void 0===n||n.off(),this.viewDestroyed=!0}}return(e=AddonMessagesDiscussionPage).ɵfac=function AddonMessagesDiscussionPage_Factory(n){return new(n||e)(f.rXU(p.nX),f.rXU(f.aKT))},e.ɵcmp=f.VBU({type:e,selectors:[["page-addon-messages-discussion"]],viewQuery:function AddonMessagesDiscussionPage_Query(e,n){if(1&e&&(f.GBs(O.W9,5),f.GBs(k.b,5)),2&e){let e;f.mGM(e=f.lsd())&&(n.content=e.first),f.mGM(e=f.lsd())&&(n.infinite=e.first)}},decls:51,vars:102,consts:[["slot","start"],[3,"text"],["class","core-bar-button-image","alt","","onError","this.src='assets/img/group-avatar.svg'","core-external-content","","role","presentation",3,"url","siteId",4,"ngIf"],["class","core-bar-button-image",3,"user","linkProfile","checkOnline",4,"ngIf"],["contextLevel","system",3,"text","contextInstanceId","wsNotFiltered"],["name","fas-star",4,"ngIf"],["name","fas-bell-slash",4,"ngIf"],["slot","end"],["iconAction","fas-circle-info",3,"action","hidden","priority","content"],[3,"action","hidden","priority","closeOnClick","content","iconAction"],[3,"action","hidden","priority","closeOnClick","content","iconAction","iconSlash"],[3,"action","hidden","priority","content","iconAction"],["iconAction","toggle",3,"toggleChange","hidden","priority","content","toggle"],[3,"action","hidden","priority","content","closeOnClick","iconAction"],[3,"action","hidden","priority","content","iconAction","iconSlash"],[3,"ionScroll"],[3,"hideUntil"],["position","top",3,"action","enabled","error"],[4,"ngIf"],[1,"sr-only"],[1,"addon-messages-discussion-container"],[4,"ngFor","ngForOf"],["icon","far-comments",3,"message",4,"ngIf"],["slot","fixed","core-fab","","vertical","bottom","horizontal","end",4,"ngIf"],["class","footer-adjustable",4,"ngIf"],["alt","","onError","this.src='assets/img/group-avatar.svg'","core-external-content","","role","presentation",1,"core-bar-button-image",3,"url","siteId"],[1,"core-bar-button-image",3,"user","linkProfile","checkOnline"],["name","fas-star"],["name","fas-bell-slash"],[1,"ion-text-center"],["class","ion-text-center addon-messages-date",4,"ngIf"],["class","addon-messages-unreadfrom",4,"ngIf"],[3,"afterRender","onDeleteMessage","message","user","text","showDelete","time"],[1,"ion-text-center","addon-messages-date"],[1,"addon-messages-unreadfrom"],["name","fas-arrow-down","aria-hidden","true"],["icon","far-comments",3,"message"],["slot","fixed","core-fab","","vertical","bottom","horizontal","end"],["size","small","color","light",3,"click"],[1,"core-discussion-messages-badge"],[1,"footer-adjustable"],[3,"color"],["class","ion-text-center ion-margin-horizontal",4,"ngIf"],["class","ion-padding-horizontal",4,"ngIf"],[3,"showKeyboard","placeholder","onSubmit",4,"ngIf"],[1,"ion-text-center","ion-margin-horizontal"],[1,"ion-padding-horizontal"],["expand","block",1,"ion-text-wrap","ion-margin-bottom",3,"click"],["expand","block","fill","outline",1,"ion-text-wrap","ion-margin-bottom",3,"click"],["class","ion-text-center",4,"ngIf"],[3,"onSubmit","showKeyboard","placeholder"]],template:function AddonMessagesDiscussionPage_Template(e,n){1&e&&(f.j41(0,"ion-header")(1,"ion-toolbar")(2,"ion-buttons",0),f.nrm(3,"ion-back-button",1),f.nI1(4,"translate"),f.k0s(),f.j41(5,"ion-title")(6,"h1"),f.DNE(7,AddonMessagesDiscussionPage_img_7_Template,1,2,"img",2)(8,AddonMessagesDiscussionPage_core_user_avatar_8_Template,1,3,"core-user-avatar",3),f.nrm(9,"core-format-text",4),f.DNE(10,AddonMessagesDiscussionPage_ion_icon_10_Template,2,3,"ion-icon",5)(11,AddonMessagesDiscussionPage_ion_icon_11_Template,2,3,"ion-icon",6),f.k0s()(),f.nrm(12,"ion-buttons",7),f.k0s(),f.j41(13,"core-navbar-buttons",7)(14,"core-context-menu"),f.nI1(15,"translate"),f.j41(16,"core-context-menu-item",8),f.nI1(17,"translate"),f.bIt("action",(function AddonMessagesDiscussionPage_Template_core_context_menu_item_action_16_listener(){return n.viewInfo()})),f.k0s(),f.j41(18,"core-context-menu-item",8),f.nI1(19,"translate"),f.bIt("action",(function AddonMessagesDiscussionPage_Template_core_context_menu_item_action_18_listener(){return n.viewInfo()})),f.k0s(),f.j41(20,"core-context-menu-item",9),f.nI1(21,"translate"),f.bIt("action",(function AddonMessagesDiscussionPage_Template_core_context_menu_item_action_20_listener(e){return n.changeFavourite(e)})),f.k0s(),f.j41(22,"core-context-menu-item",10),f.nI1(23,"translate"),f.bIt("action",(function AddonMessagesDiscussionPage_Template_core_context_menu_item_action_22_listener(e){return n.changeFavourite(e)})),f.k0s(),f.j41(24,"core-context-menu-item",11),f.nI1(25,"translate"),f.bIt("action",(function AddonMessagesDiscussionPage_Template_core_context_menu_item_action_24_listener(){return n.blockUser()})),f.k0s(),f.j41(26,"core-context-menu-item",11),f.nI1(27,"translate"),f.bIt("action",(function AddonMessagesDiscussionPage_Template_core_context_menu_item_action_26_listener(){return n.unblockUser()})),f.k0s(),f.j41(28,"core-context-menu-item",9),f.nI1(29,"translate"),f.bIt("action",(function AddonMessagesDiscussionPage_Template_core_context_menu_item_action_28_listener(e){return n.changeMute(e)})),f.k0s(),f.j41(30,"core-context-menu-item",9),f.nI1(31,"translate"),f.bIt("action",(function AddonMessagesDiscussionPage_Template_core_context_menu_item_action_30_listener(e){return n.changeMute(e)})),f.k0s(),f.j41(32,"core-context-menu-item",12),f.nI1(33,"translate"),f.mxI("toggleChange",(function AddonMessagesDiscussionPage_Template_core_context_menu_item_toggleChange_32_listener(e){return f.DH7(n.showDelete,e)||(n.showDelete=e),e})),f.k0s(),f.j41(34,"core-context-menu-item",13),f.nI1(35,"translate"),f.bIt("action",(function AddonMessagesDiscussionPage_Template_core_context_menu_item_action_34_listener(e){return n.deleteConversation(e)})),f.k0s(),f.j41(36,"core-context-menu-item",11),f.nI1(37,"translate"),f.bIt("action",(function AddonMessagesDiscussionPage_Template_core_context_menu_item_action_36_listener(){return n.createContactRequest()})),f.k0s(),f.j41(38,"core-context-menu-item",14),f.nI1(39,"translate"),f.bIt("action",(function AddonMessagesDiscussionPage_Template_core_context_menu_item_action_38_listener(){return n.removeContact()})),f.k0s()()()(),f.j41(40,"ion-content",15),f.bIt("ionScroll",(function AddonMessagesDiscussionPage_Template_ion_content_ionScroll_40_listener(){return n.scrollFunction()})),f.j41(41,"core-loading",16)(42,"core-infinite-loading",17),f.bIt("action",(function AddonMessagesDiscussionPage_Template_core_infinite_loading_action_42_listener(e){return n.loadPrevious(e)})),f.k0s(),f.DNE(43,AddonMessagesDiscussionPage_ng_container_43_Template,8,6,"ng-container",18),f.j41(44,"h2",19),f.EFF(45),f.k0s(),f.j41(46,"ion-list",20),f.DNE(47,AddonMessagesDiscussionPage_ng_container_47_Template,4,7,"ng-container",21),f.k0s(),f.DNE(48,AddonMessagesDiscussionPage_core_empty_box_48_Template,2,3,"core-empty-box",22),f.k0s(),f.DNE(49,AddonMessagesDiscussionPage_ion_fab_49_Template,9,7,"ion-fab",23),f.k0s(),f.DNE(50,AddonMessagesDiscussionPage_ion_footer_50_Template,8,7,"ion-footer",24)),2&e&&(f.R7$(3),f.Y8G("text",f.bMT(4,74,"core.back")),f.R7$(4),f.Y8G("ngIf",n.loaded&&!n.otherMember&&n.conversationImage),f.R7$(),f.Y8G("ngIf",n.loaded&&n.otherMember),f.R7$(),f.Y8G("text",n.title)("contextInstanceId",0)("wsNotFiltered",!0),f.R7$(),f.Y8G("ngIf",n.conversation&&n.conversation.isfavourite),f.R7$(),f.Y8G("ngIf",n.conversation&&n.conversation.ismuted),f.R7$(3),f.BMQ("aria-label",f.bMT(15,76,"addon.messages.conversationactions")),f.R7$(2),f.Y8G("hidden",n.isSelf||!n.showInfo||n.isGroup)("priority",1e3)("content",f.bMT(17,78,"addon.messages.info")),f.R7$(2),f.Y8G("hidden",n.isSelf||!n.showInfo||!n.isGroup)("priority",1e3)("content",f.bMT(19,80,"addon.messages.groupinfo")),f.R7$(2),f.Y8G("hidden",!n.groupMessagingEnabled||!n.conversation||n.conversation.isfavourite)("priority",800)("closeOnClick",!1)("content",f.bMT(21,82,"addon.messages.addtofavourites"))("iconAction",n.favouriteIcon),f.R7$(2),f.Y8G("hidden",!n.groupMessagingEnabled||!n.conversation||!n.conversation.isfavourite)("priority",800)("closeOnClick",!1)("content",f.bMT(23,84,"addon.messages.removefromfavourites"))("iconAction",n.favouriteIcon)("iconSlash",!0),f.R7$(2),f.Y8G("hidden",n.isSelf||!n.otherMember||n.otherMember.isblocked)("priority",700)("content",f.bMT(25,86,"addon.messages.blockuser"))("iconAction",n.blockIcon),f.R7$(2),f.Y8G("hidden",n.isSelf||!n.otherMember||!n.otherMember.isblocked)("priority",700)("content",f.bMT(27,88,"addon.messages.unblockuser"))("iconAction",n.blockIcon),f.R7$(2),f.Y8G("hidden",n.isSelf||!n.muteEnabled||!n.conversation||n.conversation.ismuted)("priority",600)("closeOnClick",!1)("content",f.bMT(29,90,"addon.messages.muteconversation"))("iconAction",n.muteIcon),f.R7$(2),f.Y8G("hidden",n.isSelf||!n.muteEnabled||!n.conversation||!n.conversation.ismuted)("priority",600)("closeOnClick",!1)("content",f.bMT(31,92,"addon.messages.unmuteconversation"))("iconAction",n.muteIcon),f.R7$(2),f.Y8G("hidden",!n.canDelete||!n.messages||!n.messages.length)("priority",400)("content",f.bMT(33,94,"addon.messages.showdeletemessages")),f.R50("toggle",n.showDelete),f.R7$(2),f.Y8G("hidden",!n.groupMessagingEnabled||!n.conversationId||n.isGroup||!n.messages||!n.messages.length)("priority",200)("content",f.bMT(35,96,"addon.messages.deleteconversation"))("closeOnClick",!1)("iconAction",n.deleteIcon),f.R7$(2),f.Y8G("hidden",n.isSelf||!n.otherMember||n.otherMember.iscontact||n.requestContactSent||n.requestContactReceived)("priority",100)("content",f.bMT(37,98,"addon.messages.addtoyourcontacts"))("iconAction",n.addRemoveIcon),f.R7$(2),f.Y8G("hidden",n.isSelf||!n.otherMember||!n.otherMember.iscontact)("priority",100)("content",f.bMT(39,100,"addon.messages.removefromyourcontacts"))("iconAction",n.addRemoveIcon)("iconSlash",!0),f.R7$(3),f.Y8G("hideUntil",n.loaded),f.R7$(),f.Y8G("enabled",n.canLoadMore)("error",n.loadMoreError),f.R7$(),f.Y8G("ngIf",n.isSelf&&!n.canLoadMore),f.R7$(2),f.JRh(n.title),f.R7$(),f.AVh("addon-messages-discussion-group",n.isGroup),f.BMQ("aria-live","polite"),f.R7$(),f.Y8G("ngForOf",n.messages),f.R7$(),f.Y8G("ngIf",!n.messages||n.messages.length<=0),f.R7$(),f.Y8G("ngIf",n.loaded&&n.newMessages>0),f.R7$(),f.Y8G("ngIf",n.loaded&&(!n.conversationId||n.conversation)))},dependencies:[M.Sq,M.bT,v.B,H.Q,C.h,k.b,b.R,W.A,K.c,Z.u,P.T,ee.l,ne.A,x.t,D.B,I.i,w.T,O.In,O.Jm,O.QW,O.ZB,O.W9,O.Q8,O.YW,O.M0,O.eU,O.iq,O.he,O.nf,O.BC,O.ai,O.el,se.f,T.D9],styles:[".ios[_nghost-%COMP%]   ion-footer[_ngcontent-%COMP%]   .toolbar[_ngcontent-%COMP%]:last-child, .ios   [_nghost-%COMP%]   ion-footer[_ngcontent-%COMP%]   .toolbar[_ngcontent-%COMP%]:last-child{padding-bottom:4px;min-height:0px}ion-content[_ngcontent-%COMP%]{--content-background: var(--background-alternative);--background: var(--content-background)}ion-content[_ngcontent-%COMP%]::part(scroll){padding-bottom:0!important}ion-content[_ngcontent-%COMP%]   core-empty-box[_ngcontent-%COMP%]{--core-empty-box-icon-color: var(--dark)}.addon-messages-discussion-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;padding-bottom:16px!important;background:var(--content-background)}.addon-messages-date[_ngcontent-%COMP%]{font-weight:400;font-size:.9rem}","[_nghost-%COMP%]   .addon-messages-unreadfrom[_ngcontent-%COMP%]{color:var(--primary);background-color:transparent;margin-top:6px;margin-left:auto;margin-right:auto}[_nghost-%COMP%]   .addon-messages-unreadfrom[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{color:var(--primary);background-color:transparent}[_nghost-%COMP%]   .has-fab[_ngcontent-%COMP%]   .scroll-content[_ngcontent-%COMP%]{padding-bottom:0}[_nghost-%COMP%]   ion-fab[_ngcontent-%COMP%]   .core-discussion-messages-badge[_ngcontent-%COMP%]{position:absolute;color:var(--addon-messages-discussion-badge-text);background-color:var(--addon-messages-discussion-badge);display:block;top:0}@supports (inset-inline-start: 0){[_nghost-%COMP%]   ion-fab[_ngcontent-%COMP%]   .core-discussion-messages-badge[_ngcontent-%COMP%]{inset-inline-end:0px}}@supports not (inset-inline-start: 0){[_nghost-%COMP%]   ion-fab[_ngcontent-%COMP%]   .core-discussion-messages-badge[_ngcontent-%COMP%]{right:0}[dir=rtl][_nghost-%COMP%]   ion-fab[_ngcontent-%COMP%]   .core-discussion-messages-badge[_ngcontent-%COMP%], [dir=rtl]   [_nghost-%COMP%]   ion-fab[_ngcontent-%COMP%]   .core-discussion-messages-badge[_ngcontent-%COMP%]{left:unset;right:unset;left:0}@supports selector(:dir(rtl)){[_nghost-%COMP%]:dir(rtl)   ion-fab[_ngcontent-%COMP%]   .core-discussion-messages-badge[_ngcontent-%COMP%]{left:unset;right:unset;left:0}}}[_nghost-%COMP%]   ion-header[_ngcontent-%COMP%]   ion-toolbar[_ngcontent-%COMP%]   ion-title[_ngcontent-%COMP%]{padding:0}[_nghost-%COMP%]   ion-header[_ngcontent-%COMP%]   ion-toolbar[_ngcontent-%COMP%]   ion-title[_ngcontent-%COMP%]   h1[_ngcontent-%COMP%]{display:flex;align-items:center;padding:0}[_nghost-%COMP%]   ion-header[_ngcontent-%COMP%]   ion-toolbar[_ngcontent-%COMP%]   ion-title[_ngcontent-%COMP%]   h1[_ngcontent-%COMP%]   .core-bar-button-image[_ngcontent-%COMP%]{--userpicture-padding: 4px;margin-inline-end:6px}[_nghost-%COMP%]   ion-header[_ngcontent-%COMP%]   ion-toolbar[_ngcontent-%COMP%]   ion-title[_ngcontent-%COMP%]   h1[_ngcontent-%COMP%]   img.core-bar-button-image[_ngcontent-%COMP%]{padding:var(--userpicture-padding);width:var(--core-header-toolbar-button-image-size);height:var(--core-header-toolbar-button-image-size);max-width:var(--core-header-toolbar-button-image-size);max-height:var(--core-header-toolbar-button-image-size);border-radius:var(--core-avatar-radius);display:block}[_nghost-%COMP%]   ion-header[_ngcontent-%COMP%]   ion-toolbar[_ngcontent-%COMP%]   ion-title[_ngcontent-%COMP%]   h1[_ngcontent-%COMP%]   core-format-text[_ngcontent-%COMP%]{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex-shrink:1;display:block}[_nghost-%COMP%]   ion-header[_ngcontent-%COMP%]   ion-toolbar[_ngcontent-%COMP%]   ion-title[_ngcontent-%COMP%]   h1[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{margin-inline-start:6px}.ios[_nghost-%COMP%]   ion-header[_ngcontent-%COMP%]   ion-toolbar[_ngcontent-%COMP%]   h1[_ngcontent-%COMP%], .ios   [_nghost-%COMP%]   ion-header[_ngcontent-%COMP%]   ion-toolbar[_ngcontent-%COMP%]   h1[_ngcontent-%COMP%]{justify-content:center}"]}),AddonMessagesDiscussionPage})();var oe=s(81690),ae=s(71758),ie=s(18022),re=s(19547),ce=s(2423);function AddonMessagesDiscussions35Page_ng_container_28_ion_item_9_Template(e,n){if(1&e){const e=f.RV6();f.j41(0,"ion-item",16),f.bIt("click",(function AddonMessagesDiscussions35Page_ng_container_28_ion_item_9_Template_ion_item_click_0_listener(){const n=f.eBV(e).$implicit,s=f.XpG(2);return f.Njj(s.gotoDiscussion(n.userid,n.messageid))})),f.nrm(1,"core-user-avatar",17),f.j41(2,"ion-label")(3,"p",10),f.EFF(4),f.k0s(),f.j41(5,"p"),f.nrm(6,"core-format-text",18),f.k0s()()()}if(2&e){const e=n.$implicit,s=f.XpG(2);f.Y8G("detail",!1),f.BMQ("aria-label",e.fullname)("aria-current",e.userid===s.discussionUserId?"page":"false"),f.R7$(),f.Y8G("user",e)("checkOnline",e.showonlinestatus),f.R7$(3),f.JRh(e.fullname),f.R7$(2),f.Y8G("text",e.lastmessage)("contextInstanceId",0)}}function AddonMessagesDiscussions35Page_ng_container_28_Template(e,n){if(1&e&&(f.qex(0),f.j41(1,"ion-item-divider")(2,"ion-label")(3,"h2"),f.EFF(4),f.nI1(5,"translate"),f.k0s()(),f.j41(6,"ion-note",14)(7,"ion-badge"),f.EFF(8),f.k0s()()(),f.DNE(9,AddonMessagesDiscussions35Page_ng_container_28_ion_item_9_Template,7,8,"ion-item",15),f.bVm()),2&e){const e=f.XpG();f.R7$(4),f.JRh(f.bMT(5,3,"core.searchresults")),f.R7$(4),f.JRh(e.search.results.length),f.R7$(),f.Y8G("ngForOf",e.search.results)}}function AddonMessagesDiscussions35Page_ng_container_29_ion_item_1_ion_note_6_span_1_Template(e,n){if(1&e&&(f.j41(0,"span",24),f.EFF(1),f.nI1(2,"coreDateDayOrTime"),f.k0s()),2&e){const e=f.XpG(2).$implicit;f.R7$(),f.SpI(" ",f.bMT(2,1,e.message.timecreated/1e3)," ")}}function AddonMessagesDiscussions35Page_ng_container_29_ion_item_1_ion_note_6_ion_icon_2_Template(e,n){1&e&&f.nrm(0,"ion-icon",25)}function AddonMessagesDiscussions35Page_ng_container_29_ion_item_1_ion_note_6_span_3_Template(e,n){1&e&&(f.j41(0,"span",26),f.EFF(1),f.nI1(2,"translate"),f.k0s()),2&e&&(f.R7$(),f.SpI(" ",f.bMT(2,1,"addon.messages.unreadmessages")," "))}function AddonMessagesDiscussions35Page_ng_container_29_ion_item_1_ion_note_6_Template(e,n){if(1&e&&(f.j41(0,"ion-note"),f.DNE(1,AddonMessagesDiscussions35Page_ng_container_29_ion_item_1_ion_note_6_span_1_Template,3,3,"span",21)(2,AddonMessagesDiscussions35Page_ng_container_29_ion_item_1_ion_note_6_ion_icon_2_Template,1,0,"ion-icon",22)(3,AddonMessagesDiscussions35Page_ng_container_29_ion_item_1_ion_note_6_span_3_Template,3,3,"span",23),f.k0s()),2&e){const e=f.XpG().$implicit;f.R7$(),f.Y8G("ngIf",e.message.timecreated>0),f.R7$(),f.Y8G("ngIf",e.unread),f.R7$(),f.Y8G("ngIf",e.unread)}}function AddonMessagesDiscussions35Page_ng_container_29_ion_item_1_Template(e,n){if(1&e){const e=f.RV6();f.j41(0,"ion-item",16),f.bIt("click",(function AddonMessagesDiscussions35Page_ng_container_29_ion_item_1_Template_ion_item_click_0_listener(){const n=f.eBV(e).$implicit,s=f.XpG(2);return f.Njj(s.gotoDiscussion(n.message.user))})),f.nrm(1,"core-user-avatar",19),f.j41(2,"ion-label")(3,"div",20)(4,"p",10),f.EFF(5),f.k0s(),f.DNE(6,AddonMessagesDiscussions35Page_ng_container_29_ion_item_1_ion_note_6_Template,4,3,"ion-note",11),f.k0s(),f.j41(7,"p"),f.nrm(8,"core-format-text",18),f.k0s()()()}if(2&e){const e=n.$implicit,s=f.XpG(2);f.Y8G("detail",!1),f.BMQ("aria-label",e.fullname)("aria-current",e.message.user===s.discussionUserId?"page":"false"),f.R7$(),f.Y8G("user",e),f.R7$(4),f.JRh(e.fullname),f.R7$(),f.Y8G("ngIf",e.message.timecreated>0||e.unread),f.R7$(2),f.Y8G("text",e.message.message)("contextInstanceId",0)}}function AddonMessagesDiscussions35Page_ng_container_29_Template(e,n){if(1&e&&(f.qex(0),f.DNE(1,AddonMessagesDiscussions35Page_ng_container_29_ion_item_1_Template,9,8,"ion-item",15),f.bVm()),2&e){const e=f.XpG();f.R7$(),f.Y8G("ngForOf",e.discussions)}}function AddonMessagesDiscussions35Page_core_empty_box_30_Template(e,n){1&e&&(f.nrm(0,"core-empty-box",27),f.nI1(1,"translate")),2&e&&f.Y8G("message",f.bMT(1,1,"addon.messages.nomessagesfound"))}function AddonMessagesDiscussions35Page_core_empty_box_31_Template(e,n){1&e&&(f.nrm(0,"core-empty-box",28),f.nI1(1,"translate")),2&e&&f.Y8G("message",f.bMT(1,1,"core.noresults"))}let de=(()=>{var e;class AddonMessagesDiscussions35Page{constructor(e){this.route=e,this.loaded=!1,this.loadingMessage="",this.discussions=[],this.search={showResults:!1,results:[],loading:"",text:""},this.search.loading=l.HT.instant("core.searching"),this.loadingMessages=l.HT.instant("core.loading"),this.siteId=i.CoreSites.getCurrentSiteId(),this.newMessagesObserver=d.z.on(h.cj,(e=>{if(e.userId&&this.discussions){const s=this.discussions.find((n=>{var s;return(null===(s=n.message)||void 0===s?void 0:s.user)===e.userId}));if(void 0===s)this.loaded=!1,this.refreshData().finally((()=>{this.loaded=!0}));else if(s.message){var n;s.message.message=null!==(n=e.message)&&void 0!==n?n:"",s.message.timecreated=e.timecreated}}}),this.siteId),this.readChangedObserver=d.z.on(h.j_,(e=>{if(e.userId&&this.discussions){const n=this.discussions.find((n=>{var s;return(null===(s=n.message)||void 0===s?void 0:s.user)===e.userId}));void 0!==n&&(n.unread=!1,r.AddonMessages.invalidateConversations(this.siteId),r.AddonMessages.refreshUnreadConversationCounts(this.siteId))}}),this.siteId),this.appResumeSubscription=ie.CorePlatform.resume.subscribe((()=>{this.loaded&&(this.loaded=!1,this.refreshData())})),this.pushObserver=ae.CorePushNotificationsDelegate.on("receive").subscribe((e=>{oe.j.isFalseOrZero(e.notif)&&e.site==this.siteId&&this.refreshData(void 0,!1)}))}ngOnInit(){var e=this;return(0,a.A)((function*(){e.route.queryParams.subscribe(function(){var n=(0,a.A)((function*(n){var s;e.discussionUserId=null!==(s=_.CoreNavigator.getRouteNumberParam("userId",{params:n}))&&void 0!==s?s:e.discussionUserId}));return function(e){return n.apply(this,arguments)}}()),yield e.fetchData(),!e.discussionUserId&&e.discussions.length>0&&g.CoreScreen.isTablet&&e.discussions[0].message&&(yield e.gotoDiscussion(e.discussions[0].message.user)),i.CoreSites.loginNavigationFinished()}))()}refreshData(e,n=!0){var s=this;return(0,a.A)((function*(){const t=[];t.push(r.AddonMessages.invalidateDiscussionsCache(s.siteId)),n&&t.push(r.AddonMessages.invalidateUnreadConversationCounts(s.siteId)),yield F.g.allPromises(t).finally((()=>s.fetchData().finally((()=>{e&&(null==e||e.complete())}))))}))()}fetchData(){var e=this;return(0,a.A)((function*(){e.loadingMessage=e.loadingMessages;const n=[];n.push(r.AddonMessages.getDiscussions(e.siteId).then((n=>{const s=[];for(const e in n)n[e].unread=!!n[e].unread,s.push(n[e]);e.discussions=s.sort(((e,n)=>{var s,t;return((null===(s=n.message)||void 0===s?void 0:s.timecreated)||0)-((null===(t=e.message)||void 0===t?void 0:t.timecreated)||0)}))}))),n.push(r.AddonMessages.getUnreadConversationCounts(e.siteId));try{yield Promise.all(n)}catch(e){c.CoreDomUtils.showErrorModalDefault(e,"addon.messages.errorwhileretrievingdiscussions",!0)}e.loaded=!0}))()}clearSearch(){this.loaded=!1,this.search.showResults=!1,this.search.text="",this.fetchData().finally((()=>{this.loaded=!0}))}searchMessage(e){var n=this;return(0,a.A)((function*(){u.p.close(),n.loaded=!1,n.loadingMessage=n.search.loading;try{const s=yield r.AddonMessages.searchMessages(e,void 0,void 0,void 0,n.siteId);n.search.showResults=!0,n.search.results=s.messages}catch(e){c.CoreDomUtils.showErrorModalDefault(e,"addon.messages.errorwhileretrievingmessages",!0)}n.loaded=!0}))()}gotoDiscussion(e,n){var s=this;return(0,a.A)((function*(){s.discussionUserId=e;const t={};n&&(t.message=n);const o=_.CoreNavigator.getRelativePathToParent("/messages/index")+`discussion/user/${e}`;yield _.CoreNavigator.navigate(o,{params:t,reset:g.CoreScreen.isTablet&&!!s.splitView&&!s.splitView.isNested})}))()}gotoContacts(){const e={};g.CoreScreen.isTablet&&this.discussionUserId&&(e.discussionUserId=this.discussionUserId),_.CoreNavigator.navigateToSitePath("contacts-35",{params:e})}ngOnDestroy(){var e,n,s,t;null===(e=this.newMessagesObserver)||void 0===e||e.off(),null===(n=this.readChangedObserver)||void 0===n||n.off(),null===(s=this.appResumeSubscription)||void 0===s||s.unsubscribe(),null===(t=this.pushObserver)||void 0===t||t.unsubscribe()}}return(e=AddonMessagesDiscussions35Page).ɵfac=function AddonMessagesDiscussions35Page_Factory(n){return new(n||e)(f.rXU(p.nX))},e.ɵcmp=f.VBU({type:e,selectors:[["addon-messages-discussions"]],viewQuery:function AddonMessagesDiscussions35Page_Query(e,n){if(1&e&&f.GBs(m.M,5),2&e){let e;f.mGM(e=f.lsd())&&(n.splitView=e.first)}},decls:32,vars:28,consts:[["slot","start"],[3,"text"],["slot","end"],["slot","fixed",3,"ionRefresh","disabled"],[3,"pullingText"],["autocorrect","off","spellcheck","false","lengthCheck","2","searchArea","AddonMessagesDiscussions",3,"onSubmit","onClear","placeholder","disabled","autoFocus"],[3,"hideUntil","message"],[1,"ion-no-margin"],["button","",1,"ion-text-wrap",3,"click","detail"],["name","fas-address-book","slot","start","aria-hidden","true"],[1,"item-heading"],[4,"ngIf"],["icon","far-comments",3,"message",4,"ngIf"],["icon","fas-magnifying-glass",3,"message",4,"ngIf"],["slot","end",1,"ion-padding-end"],["class","ion-text-wrap addon-message-discussion","button","",3,"detail","click",4,"ngFor","ngForOf"],["button","",1,"ion-text-wrap","addon-message-discussion",3,"click","detail"],["slot","start",3,"user","checkOnline"],["clean","true","singleLine","true","contextLevel","system",3,"text","contextInstanceId"],["slot","start","checkOnline","false",3,"user"],[1,"flex-row","ion-justify-content-between"],["class","addon-message-last-message-date",4,"ngIf"],["name","fas-circle","color","primary","aria-hidden","true",4,"ngIf"],["class","sr-only",4,"ngIf"],[1,"addon-message-last-message-date"],["name","fas-circle","color","primary","aria-hidden","true"],[1,"sr-only"],["icon","far-comments",3,"message"],["icon","fas-magnifying-glass",3,"message"]],template:function AddonMessagesDiscussions35Page_Template(e,n){1&e&&(f.j41(0,"ion-header")(1,"ion-toolbar")(2,"ion-buttons",0),f.nrm(3,"ion-back-button",1),f.nI1(4,"translate"),f.k0s(),f.j41(5,"ion-title")(6,"h1"),f.EFF(7),f.nI1(8,"translate"),f.k0s()(),f.j41(9,"ion-buttons",2),f.nrm(10,"core-context-menu")(11,"core-user-menu-button"),f.k0s()()(),f.j41(12,"ion-content")(13,"core-split-view")(14,"ion-refresher",3),f.bIt("ionRefresh",(function AddonMessagesDiscussions35Page_Template_ion_refresher_ionRefresh_14_listener(e){return n.refreshData(e.target)})),f.nrm(15,"ion-refresher-content",4),f.nI1(16,"translate"),f.k0s(),f.j41(17,"core-search-box",5),f.nI1(18,"translate"),f.bIt("onSubmit",(function AddonMessagesDiscussions35Page_Template_core_search_box_onSubmit_17_listener(e){return n.searchMessage(e)}))("onClear",(function AddonMessagesDiscussions35Page_Template_core_search_box_onClear_17_listener(){return n.clearSearch()})),f.k0s(),f.j41(19,"core-loading",6)(20,"ion-list",7)(21,"ion-item",8),f.nI1(22,"translate"),f.bIt("click",(function AddonMessagesDiscussions35Page_Template_ion_item_click_21_listener(){return n.gotoContacts()})),f.nrm(23,"ion-icon",9),f.j41(24,"ion-label")(25,"p",10),f.EFF(26),f.nI1(27,"translate"),f.k0s()()(),f.DNE(28,AddonMessagesDiscussions35Page_ng_container_28_Template,10,5,"ng-container",11)(29,AddonMessagesDiscussions35Page_ng_container_29_Template,2,1,"ng-container",11),f.k0s(),f.DNE(30,AddonMessagesDiscussions35Page_core_empty_box_30_Template,2,3,"core-empty-box",12)(31,AddonMessagesDiscussions35Page_core_empty_box_31_Template,2,3,"core-empty-box",13),f.k0s()()()),2&e&&(f.R7$(3),f.Y8G("text",f.bMT(4,16,"core.back")),f.R7$(4),f.JRh(f.bMT(8,18,"addon.messages.messages")),f.R7$(7),f.Y8G("disabled",!n.loaded),f.R7$(),f.FS9("pullingText",f.bMT(16,20,"core.pulltorefresh")),f.R7$(2),f.Y8G("placeholder",f.bMT(18,22,"addon.messages.message"))("disabled",!n.loaded)("autoFocus",!1),f.R7$(2),f.Y8G("hideUntil",n.loaded)("message",n.loadingMessage),f.R7$(2),f.Y8G("detail",!0),f.BMQ("aria-label",f.bMT(22,24,"addon.messages.contacts")),f.R7$(5),f.JRh(f.bMT(27,26,"addon.messages.contacts")),f.R7$(2),f.Y8G("ngIf",n.search.showResults),f.R7$(),f.Y8G("ngIf",!n.search.showResults),f.R7$(),f.Y8G("ngIf",(!n.discussions||n.discussions.length<=0)&&!n.search.showResults),f.R7$(),f.Y8G("ngIf",(!n.search.results||n.search.results.length<=0)&&n.search.showResults))},dependencies:[M.Sq,M.bT,v.B,C.h,b.R,m.M,P.T,x.t,D.B,I.i,O.In,O.QW,O.W9,O.eU,O.iq,O.uz,O.Dg,O.he,O.nf,O.JI,O.To,O.Ki,O.BC,O.ai,O.el,y.M,re.U,ce.Y,T.D9],styles:["[_nghost-%COMP%]   .addon-messages-conversation-item[_ngcontent-%COMP%]   ion-label[_ngcontent-%COMP%], [_nghost-%COMP%]   .addon-message-discussion[_ngcontent-%COMP%]   ion-label[_ngcontent-%COMP%]{margin-right:0;margin-left:0}[_nghost-%COMP%]   .addon-messages-conversation-item[_ngcontent-%COMP%]   .item-heading[_ngcontent-%COMP%]   core-format-text[_ngcontent-%COMP%], [_nghost-%COMP%]   .addon-message-discussion[_ngcontent-%COMP%]   .item-heading[_ngcontent-%COMP%]   core-format-text[_ngcontent-%COMP%]{font-weight:700}[_nghost-%COMP%]   .addon-messages-conversation-item[_ngcontent-%COMP%]   .item-heading[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%], [_nghost-%COMP%]   .addon-message-discussion[_ngcontent-%COMP%]   .item-heading[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{margin-inline-start:2px}[_nghost-%COMP%]   .addon-messages-conversation-item[_ngcontent-%COMP%]   ion-note[_ngcontent-%COMP%], [_nghost-%COMP%]   .addon-message-discussion[_ngcontent-%COMP%]   ion-note[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-self:flex-start;margin-inline-start:2px}[_nghost-%COMP%]   .addon-messages-conversation-item[_ngcontent-%COMP%]   ion-note[_ngcontent-%COMP%]   ion-badge[_ngcontent-%COMP%], [_nghost-%COMP%]   .addon-messages-conversation-item[_ngcontent-%COMP%]   ion-note[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%], [_nghost-%COMP%]   .addon-message-discussion[_ngcontent-%COMP%]   ion-note[_ngcontent-%COMP%]   ion-badge[_ngcontent-%COMP%], [_nghost-%COMP%]   .addon-message-discussion[_ngcontent-%COMP%]   ion-note[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{margin-top:3px;align-self:flex-end}[_nghost-%COMP%]   .addon-messages-conversation-item[_ngcontent-%COMP%]   ion-note[_ngcontent-%COMP%]   .addon-message-last-message-date[_ngcontent-%COMP%], [_nghost-%COMP%]   .addon-message-discussion[_ngcontent-%COMP%]   ion-note[_ngcontent-%COMP%]   .addon-message-last-message-date[_ngcontent-%COMP%]{white-space:nowrap;font-size:.6875rem}[_nghost-%COMP%]   .addon-messages-conversation-item[_ngcontent-%COMP%]   .addon-message-last-message[_ngcontent-%COMP%], [_nghost-%COMP%]   .addon-message-discussion[_ngcontent-%COMP%]   .addon-message-last-message[_ngcontent-%COMP%]{display:flex;justify-content:flex-start}[_nghost-%COMP%]   .addon-messages-conversation-item[_ngcontent-%COMP%]   .addon-message-last-message-user[_ngcontent-%COMP%], [_nghost-%COMP%]   .addon-message-discussion[_ngcontent-%COMP%]   .addon-message-last-message-user[_ngcontent-%COMP%]{white-space:nowrap;color:var(--ion-text-color);margin-inline-end:2px}[_nghost-%COMP%]   .addon-messages-conversation-item[_ngcontent-%COMP%]   .addon-message-last-message-text[_ngcontent-%COMP%], [_nghost-%COMP%]   .addon-message-discussion[_ngcontent-%COMP%]   .addon-message-last-message-text[_ngcontent-%COMP%]{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex-shrink:1}[_nghost-%COMP%]   .addon-message-discussion[_ngcontent-%COMP%]   .item-heading[_ngcontent-%COMP%]{margin-top:10px}[_nghost-%COMP%]   ion-item-divider[_ngcontent-%COMP%]   ion-badge[_ngcontent-%COMP%]{margin-left:16px;margin-right:16px}"]}),AddonMessagesDiscussions35Page})();const le=["accordionGroup"],_c1=e=>({$a:e}),_c2=e=>({conversations:e});function AddonMessagesGroupConversationsPage_ion_badge_31_Template(e,n){if(1&e&&(f.j41(0,"ion-badge",4),f.nI1(1,"translate"),f.EFF(2),f.k0s()),2&e){const e=f.XpG();f.BMQ("aria-label",f.i5U(1,2,"addon.messages.pendingcontactrequests",f.eq3(5,_c1,e.contactRequestsCount))),f.R7$(2),f.SpI(" ",e.contactRequestsCount," ")}}function AddonMessagesGroupConversationsPage_ion_accordion_34_ion_badge_6_Template(e,n){if(1&e&&(f.j41(0,"ion-badge",4),f.nI1(1,"translate"),f.EFF(2),f.k0s()),2&e){const e=f.XpG().$implicit;f.BMQ("aria-label",f.i5U(1,2,"addon.messages.unreadconversations",f.eq3(5,_c1,e.unread))),f.R7$(2),f.SpI(" ",e.unread," ")}}function AddonMessagesGroupConversationsPage_ion_accordion_34_ng_container_8_ng_container_1_Template(e,n){1&e&&f.eu8(0)}function AddonMessagesGroupConversationsPage_ion_accordion_34_ng_container_8_ion_item_3_Template(e,n){if(1&e&&(f.j41(0,"ion-item",26)(1,"ion-label")(2,"p"),f.EFF(3),f.nI1(4,"translate"),f.k0s()()()),2&e){const e=f.XpG(2).$implicit;f.R7$(3),f.JRh(f.bMT(4,1,e.emptyString))}}function AddonMessagesGroupConversationsPage_ion_accordion_34_ng_container_8_Template(e,n){if(1&e){const e=f.RV6();f.qex(0),f.DNE(1,AddonMessagesGroupConversationsPage_ion_accordion_34_ng_container_8_ng_container_1_Template,1,0,"ng-container",23),f.j41(2,"core-infinite-loading",24),f.bIt("action",(function AddonMessagesGroupConversationsPage_ion_accordion_34_ng_container_8_Template_core_infinite_loading_action_2_listener(n){f.eBV(e);const s=f.XpG().$implicit,t=f.XpG();return f.Njj(t.loadMoreConversations(s,n))})),f.k0s(),f.DNE(3,AddonMessagesGroupConversationsPage_ion_accordion_34_ng_container_8_ion_item_3_Template,5,3,"ion-item",25),f.bVm()}if(2&e){const e=f.XpG().$implicit;f.XpG();const n=f.sdS(36);f.R7$(),f.Y8G("ngTemplateOutlet",n)("ngTemplateOutletContext",f.eq3(5,_c2,e.conversations)),f.R7$(),f.Y8G("enabled",e.canLoadMore)("error",e.loadMoreError),f.R7$(),f.Y8G("ngIf",e.conversations&&0===e.conversations.length)}}function AddonMessagesGroupConversationsPage_ion_accordion_34_ion_item_9_Template(e,n){1&e&&(f.j41(0,"ion-item",27)(1,"ion-label"),f.nrm(2,"ion-spinner"),f.nI1(3,"translate"),f.k0s()()),2&e&&(f.R7$(2),f.BMQ("aria-label",f.bMT(3,1,"core.loading")))}function AddonMessagesGroupConversationsPage_ion_accordion_34_Template(e,n){if(1&e&&(f.j41(0,"ion-accordion",18)(1,"ion-item",19)(2,"ion-label")(3,"h2"),f.EFF(4),f.nI1(5,"translate"),f.k0s()(),f.DNE(6,AddonMessagesGroupConversationsPage_ion_accordion_34_ion_badge_6_Template,3,7,"ion-badge",15),f.k0s(),f.j41(7,"div",20),f.DNE(8,AddonMessagesGroupConversationsPage_ion_accordion_34_ng_container_8_Template,4,7,"ng-container",21)(9,AddonMessagesGroupConversationsPage_ion_accordion_34_ion_item_9_Template,4,3,"ion-item",22),f.k0s()()),2&e){const e=n.$implicit;f.Y8G("value",e.optionName),f.R7$(4),f.Lme("",f.bMT(5,6,e.titleString)," (",e.count,")"),f.R7$(2),f.Y8G("ngIf",e.unread),f.R7$(2),f.Y8G("ngIf",!e.loading),f.R7$(),f.Y8G("ngIf",e.loading)}}function AddonMessagesGroupConversationsPage_ng_template_35_ion_item_0_ion_avatar_1_Template(e,n){if(1&e&&(f.j41(0,"ion-avatar",2),f.nrm(1,"img",37),f.k0s()),2&e){const e=f.XpG().$implicit;f.R7$(),f.Y8G("url",e.imageurl)("alt",e.name)}}function AddonMessagesGroupConversationsPage_ng_template_35_ion_item_0_core_user_avatar_2_Template(e,n){if(1&e&&f.nrm(0,"core-user-avatar",38),2&e){const e=f.XpG().$implicit;f.Y8G("user",e.otherUser)("linkProfile",!1)("checkOnline",e.showonlinestatus)}}function AddonMessagesGroupConversationsPage_ng_template_35_ion_item_0_ion_icon_7_Template(e,n){1&e&&(f.nrm(0,"ion-icon",39),f.nI1(1,"translate")),2&e&&f.BMQ("aria-label",f.bMT(1,1,"addon.messages.contactblocked"))}function AddonMessagesGroupConversationsPage_ng_template_35_ion_item_0_ion_icon_8_Template(e,n){1&e&&(f.nrm(0,"ion-icon",40),f.nI1(1,"translate")),2&e&&f.Y8G("title",f.bMT(1,1,"addon.messages.mutedconversation"))}function AddonMessagesGroupConversationsPage_ng_template_35_ion_item_0_ion_note_9_span_1_Template(e,n){if(1&e&&(f.j41(0,"span",44),f.EFF(1),f.nI1(2,"coreDateDayOrTime"),f.k0s()),2&e){const e=f.XpG(2).$implicit;f.R7$(),f.SpI(" ",f.bMT(2,1,e.lastmessagedate)," ")}}function AddonMessagesGroupConversationsPage_ng_template_35_ion_item_0_ion_note_9_ion_badge_2_Template(e,n){if(1&e&&(f.j41(0,"ion-badge",45),f.EFF(1),f.k0s()),2&e){const e=f.XpG(2).$implicit;f.R7$(),f.JRh(e.unreadcount)}}function AddonMessagesGroupConversationsPage_ng_template_35_ion_item_0_ion_note_9_span_3_Template(e,n){if(1&e&&(f.j41(0,"span",46),f.EFF(1),f.nI1(2,"translate"),f.k0s()),2&e){const e=f.XpG(2).$implicit;f.R7$(),f.SpI(" ",f.i5U(2,1,"addon.messages.unreadmessages",f.eq3(4,_c1,e.unreadcount))," ")}}function AddonMessagesGroupConversationsPage_ng_template_35_ion_item_0_ion_note_9_Template(e,n){if(1&e&&(f.j41(0,"ion-note"),f.DNE(1,AddonMessagesGroupConversationsPage_ng_template_35_ion_item_0_ion_note_9_span_1_Template,3,3,"span",41)(2,AddonMessagesGroupConversationsPage_ng_template_35_ion_item_0_ion_note_9_ion_badge_2_Template,2,1,"ion-badge",42)(3,AddonMessagesGroupConversationsPage_ng_template_35_ion_item_0_ion_note_9_span_3_Template,3,6,"span",43),f.k0s()),2&e){const e=f.XpG().$implicit;f.R7$(),f.Y8G("ngIf",e.lastmessagedate>0),f.R7$(),f.Y8G("ngIf",e.unreadcount>0),f.R7$(),f.Y8G("ngIf",e.unreadcount>0)}}function AddonMessagesGroupConversationsPage_ng_template_35_ion_item_0_p_10_Template(e,n){if(1&e&&(f.j41(0,"p"),f.nrm(1,"core-format-text",33),f.k0s()),2&e){const e=f.XpG().$implicit;f.R7$(),f.Y8G("text",e.subname)("contextInstanceId",0)}}function AddonMessagesGroupConversationsPage_ng_template_35_ion_item_0_p_11_span_1_Template(e,n){1&e&&(f.j41(0,"span",50),f.EFF(1),f.nI1(2,"translate"),f.k0s()),2&e&&(f.R7$(),f.SpI(" ",f.bMT(2,1,"addon.messages.you")," "))}function AddonMessagesGroupConversationsPage_ng_template_35_ion_item_0_p_11_span_2_Template(e,n){if(1&e&&(f.j41(0,"span",50),f.EFF(1),f.k0s()),2&e){const e=f.XpG(2).$implicit;f.R7$(),f.JRh(e.members[0].fullname+":")}}function AddonMessagesGroupConversationsPage_ng_template_35_ion_item_0_p_11_Template(e,n){if(1&e&&(f.j41(0,"p",47),f.DNE(1,AddonMessagesGroupConversationsPage_ng_template_35_ion_item_0_p_11_span_1_Template,3,3,"span",48)(2,AddonMessagesGroupConversationsPage_ng_template_35_ion_item_0_p_11_span_2_Template,2,1,"span",48),f.nrm(3,"core-format-text",49),f.k0s()),2&e){const e=f.XpG().$implicit,n=f.XpG(2);f.R7$(),f.Y8G("ngIf",e.sentfromcurrentuser),f.R7$(),f.Y8G("ngIf",!e.sentfromcurrentuser&&e.type===n.typeGroup&&e.members[0]),f.R7$(),f.Y8G("text",e.lastmessage)("contextInstanceId",0)}}function AddonMessagesGroupConversationsPage_ng_template_35_ion_item_0_Template(e,n){if(1&e){const e=f.RV6();f.j41(0,"ion-item",29),f.bIt("click",(function AddonMessagesGroupConversationsPage_ng_template_35_ion_item_0_Template_ion_item_click_0_listener(){const n=f.eBV(e).$implicit,s=f.XpG(2);return f.Njj(s.gotoConversation(n.id,n.userid))})),f.DNE(1,AddonMessagesGroupConversationsPage_ng_template_35_ion_item_0_ion_avatar_1_Template,2,2,"ion-avatar",30)(2,AddonMessagesGroupConversationsPage_ng_template_35_ion_item_0_core_user_avatar_2_Template,1,3,"core-user-avatar",31),f.j41(3,"ion-label")(4,"div",32)(5,"p",14),f.nrm(6,"core-format-text",33),f.DNE(7,AddonMessagesGroupConversationsPage_ng_template_35_ion_item_0_ion_icon_7_Template,2,3,"ion-icon",34)(8,AddonMessagesGroupConversationsPage_ng_template_35_ion_item_0_ion_icon_8_Template,2,3,"ion-icon",35),f.k0s(),f.DNE(9,AddonMessagesGroupConversationsPage_ng_template_35_ion_item_0_ion_note_9_Template,4,3,"ion-note",21),f.k0s(),f.DNE(10,AddonMessagesGroupConversationsPage_ng_template_35_ion_item_0_p_10_Template,2,2,"p",21)(11,AddonMessagesGroupConversationsPage_ng_template_35_ion_item_0_p_11_Template,4,4,"p",36),f.k0s()()}if(2&e){const e=n.$implicit,s=f.XpG(2);f.Mz_("id","addon-message-conversation-",e.id?e.id:"user-"+e.userid,""),f.Y8G("detail",!1),f.BMQ("aria-current",e.id&&e.id===s.selectedConversationId||e.userid&&e.userid===s.selectedUserId?"page":"false")("aria-label",e.name),f.R7$(),f.Y8G("ngIf",e.type===s.typeGroup),f.R7$(),f.Y8G("ngIf",e.type!==s.typeGroup),f.R7$(4),f.Y8G("text",e.name)("contextInstanceId",0),f.R7$(),f.Y8G("ngIf",e.isblocked),f.R7$(),f.Y8G("ngIf",e.ismuted),f.R7$(),f.Y8G("ngIf",e.lastmessagedate>0||e.unreadcount),f.R7$(),f.Y8G("ngIf",e.subname),f.R7$(),f.Y8G("ngIf",void 0!==e.lastmessage)}}function AddonMessagesGroupConversationsPage_ng_template_35_Template(e,n){if(1&e&&f.DNE(0,AddonMessagesGroupConversationsPage_ng_template_35_ion_item_0_Template,12,14,"ion-item",28),2&e){f.Y8G("ngForOf",n.conversations)}}let ge=(()=>{var e;class AddonMessagesGroupConversationsPage{constructor(e){this.route=e,this.loaded=!1,this.contactRequestsCount=0,this.groupConversations=[{optionName:"favourites",titleString:"core.favourites",emptyString:"addon.messages.nofavourites",type:void 0,favourites:!0,count:0,unread:0,conversations:[]},{optionName:"group",titleString:"addon.messages.groupconversations",emptyString:"addon.messages.nogroupconversations",type:2,favourites:!1,count:0,unread:0,conversations:[]},{optionName:"individual",titleString:"addon.messages.individualconversations",emptyString:"addon.messages.noindividualconversations",type:1,favourites:!1,count:0,unread:0,conversations:[]}],this.typeGroup=2,this.firstExpand=!1,this.loadingMessage=l.HT.instant("core.loading"),this.siteId=i.CoreSites.getCurrentSiteId(),this.currentUserId=i.CoreSites.getCurrentSiteUserId(),this.newMessagesObserver=d.z.on(h.cj,(e=>{const n=this.getExpandedOption(),s=this.getConversationOptionName(e);if((null==n?void 0:n.optionName)!==s)return;const t=this.findConversation(e.conversationId,e.userId,n);if(void 0===t)return this.loaded=!1,this.refreshData().finally((()=>{this.loaded=!0})),void 0;if(void 0===e.message)return t.lastmessage=void 0,t.lastmessagedate=void 0,t.sentfromcurrentuser=void 0,void 0;if(t.lastmessage!==e.message||t.lastmessagedate!==e.timecreated/1e3){const n=e.timecreated/1e3>(t.lastmessagedate||0);t.lastmessage=e.message,t.lastmessagedate=e.timecreated/1e3,e.userFrom&&(t.sentfromcurrentuser=e.userFrom.id===this.currentUserId,2===t.type&&(t.members[0]=e.userFrom));const s=this.getConversationOptionName(t),a=this.getConversationGroupByName(s);var o;if(a.conversations=r.AddonMessages.sortConversations(a.conversations),n)null===(o=this.content)||void 0===o||o.scrollToTop()}}),this.siteId),this.readChangedObserver=d.z.on(h.j_,(e=>{if(e.conversationId){const n=this.findConversation(e.conversationId);void 0!==n&&(n.unreadcount=0,r.AddonMessages.invalidateConversations(this.siteId),r.AddonMessages.refreshUnreadConversationCounts(this.siteId))}}),this.siteId),this.openConversationObserver=d.z.on(h.mO,(e=>{(e.conversationId||e.userId)&&this.gotoConversation(e.conversationId,e.userId)}),this.siteId),this.appResumeSubscription=ie.CorePlatform.resume.subscribe((()=>{this.loaded&&(this.loaded=!1,this.refreshData().finally((()=>{this.loaded=!0})))})),this.updateConversationListObserver=d.z.on(h.I2,(e=>{if("mute"!==(null==e?void 0:e.action))this.refreshData();else{const n=this.getExpandedOption();if(null!=n&&n.conversations){const s=this.findConversation(e.conversationId,void 0,n);s&&(s.ismuted=!!e.value)}}}),this.siteId),this.pushObserver=ae.CorePushNotificationsDelegate.on("receive").subscribe((e=>{oe.j.isFalseOrZero(e.notif)&&e.site===this.siteId&&this.refreshData(void 0,!1)})),this.cronObserver=d.z.on(h.SU,(e=>{this.setCounts(e,"unread")}),this.siteId),this.contactRequestsCountObserver=d.z.on(h.l3,(e=>{this.contactRequestsCount=e.count}),this.siteId),this.memberInfoObserver=d.z.on(h.Ie,(e=>{if(!e.userBlocked&&!e.userUnblocked)return;const n=this.getExpandedOption();if("group"===(null==n?void 0:n.optionName)||null==n||!n.conversations.length)return;const s=this.findConversation(void 0,e.userId,n);s&&(s.isblocked=e.userBlocked)}),this.siteId)}ngOnInit(){var e=this;return(0,a.A)((function*(){if(e.route.queryParams.subscribe(function(){var n=(0,a.A)((function*(n){const s=_.CoreNavigator.getRouteNumberParam("conversationId",{params:n}),t=_.CoreNavigator.getRouteNumberParam("userId",{params:n});(s||t)&&(e.selectedConversationId=s,e.selectedUserId=t)}));return function(e){return n.apply(this,arguments)}}()),yield e.fetchData(),!e.selectedConversationId&&!e.selectedUserId&&g.CoreScreen.isTablet){const n=e.getExpandedOption(),s=null==n?void 0:n.conversations[0];s&&(yield e.gotoConversation(s.id))}i.CoreSites.loginNavigationFinished()}))()}fetchData(e=!0){var n=this;return(0,a.A)((function*(){const s=[];s.push(n.fetchConversationCounts()),s.push(r.AddonMessages.getContactRequestsCount(n.siteId)),e&&s.push(r.AddonMessages.refreshUnreadConversationCounts(n.siteId));try{if(yield Promise.all(s),!n.firstExpand&&(n.selectedConversationId||n.selectedUserId)){const e=n.groupConversations.map((e=>n.fetchDataForOption(e,!1)));yield Promise.all(e);const s=n.findConversation(n.selectedConversationId,n.selectedUserId);if(s){const e=n.getConversationOptionName(s),t=n.getConversationGroupByName(e);return yield n.expandOption(t),n.loaded=!0,void 0}}yield n.fetchDataForExpandedOption()}catch(e){c.CoreDomUtils.showErrorModalDefault(e,"addon.messages.errorwhileretrievingdiscussions",!0)}n.loaded=!0}))()}fetchDataForExpandedOption(){var e=this;return(0,a.A)((function*(){if(!e.firstExpand){let n=e.groupConversations.find((e=>e.unread));n||(n=e.groupConversations.find((e=>e.count>0))),n||(n=e.getConversationGroupByName("individual")),e.accordionGroup.value=n.optionName,e.firstExpand=!0}const n=e.getExpandedOption();n&&(yield e.fetchDataForOption(n,!1))}))()}fetchDataForOption(e,n=!1,s=!1){var t=this;return(0,a.A)((function*(){e.loadMoreError=!1;const o=n?e.conversations.length:0,i=[];let c={conversations:[],canLoadMore:!1},d=[];i.push(r.AddonMessages.invalidateConversations(t.siteId).then((0,a.A)((function*(){c=yield r.AddonMessages.getConversations(e.type,e.favourites,o,t.siteId)})))),n||i.push(S.AddonMessagesOffline.getAllMessages().then((e=>{d=e}))),s&&(i.push(t.fetchConversationCounts()),i.push(r.AddonMessages.refreshUnreadConversationCounts(t.siteId))),yield Promise.all(i),n?(e.conversations=e.conversations.concat(c.conversations),e.canLoadMore=c.canLoadMore):(e.conversations=c.conversations,e.canLoadMore=c.canLoadMore,d&&d.length&&(yield t.loadOfflineMessages(e,d),e.conversations=r.AddonMessages.sortConversations(e.conversations)))}))()}fetchConversationCounts(){var e=this;return(0,a.A)((function*(){yield r.AddonMessages.invalidateConversationCounts(e.siteId);const n=yield r.AddonMessages.getConversationCounts(e.siteId);e.setCounts(n)}))()}setCounts(e,n="count"){this.getConversationGroupByName("favourites")[n]=e.favourites,this.getConversationGroupByName("individual")[n]=e.individual+e.self,this.getConversationGroupByName("group")[n]=e.group}getConversationGroupByName(e){const n=this.groupConversations.find((n=>n.optionName===e));return null!=n?n:this.groupConversations[0]}findConversation(e,n,s){if(e){const n=s?s.conversations:this.groupConversations.flatMap((e=>e.conversations));return n.find((n=>n.id===e))}let t=null==s?void 0:s.conversations;return t||(t=this.getConversationGroupByName("favourites").conversations.concat(this.getConversationGroupByName("individual").conversations)),t.find((e=>e.userid===n))}getExpandedOption(){if(this.accordionGroup.value)return this.getConversationGroupByName(this.accordionGroup.value)}gotoContacts(){_.CoreNavigator.navigateToSitePath("contacts")}gotoConversation(e,n,s){var t=this;return(0,a.A)((function*(){t.selectedConversationId=e,t.selectedUserId=n;const o={};s&&(o.message=s);const a=_.CoreNavigator.getRelativePathToParent("/messages/group-conversations")+"discussion/"+(e||`user/${n}`);yield _.CoreNavigator.navigate(a,{params:o,reset:g.CoreScreen.isTablet&&!!t.splitView&&!t.splitView.isNested})}))()}gotoSettings(){_.CoreNavigator.navigateToSitePath("message-settings")}loadMoreConversations(e,n){var s=this;return(0,a.A)((function*(){try{yield s.fetchDataForOption(e,!0)}catch(n){c.CoreDomUtils.showErrorModalDefault(n,"addon.messages.errorwhileretrievingdiscussions",!0),e.loadMoreError=!0}null==n||n()}))()}loadOfflineMessages(e,n){var s=this;return(0,a.A)((function*(){const t=[];n.forEach((n=>{if("conversationid"in n){let t=s.findConversation(n.conversationid,void 0,e);var o,a,i,r,c,d,l,g,_,m;if(t)(null==t.lastmessage||!t.lastmessagepending||(t.lastmessagedate||0)<=n.timecreated/1e3)&&s.addLastOfflineMessage(t,n);else t={id:n.conversationid,type:(null===(o=n.conversation)||void 0===o?void 0:o.type)||1,membercount:(null===(a=n.conversation)||void 0===a?void 0:a.membercount)||0,ismuted:(null===(i=n.conversation)||void 0===i?void 0:i.ismuted)||!1,isfavourite:(null===(r=n.conversation)||void 0===r?void 0:r.isfavourite)||!1,isread:(null===(c=n.conversation)||void 0===c?void 0:c.isread)||!1,members:(null===(d=n.conversation)||void 0===d?void 0:d.members)||[],messages:(null===(l=n.conversation)||void 0===l?void 0:l.messages)||[],candeletemessagesforallusers:(null===(g=n.conversation)||void 0===g?void 0:g.candeletemessagesforallusers)||!1,userid:0,name:null===(_=n.conversation)||void 0===_?void 0:_.name,imageurl:(null===(m=n.conversation)||void 0===m?void 0:m.imageurl)||""},s.getConversationOptionName(t)===e.optionName&&(s.addLastOfflineMessage(t,n),s.addOfflineConversation(t,e))}else if(1===e.type){const o=s.findConversation(void 0,n.touserid,e);n.text=n.smallmessage,o?(o.lastmessagedate||0)<=n.timecreated/1e3&&s.addLastOfflineMessage(o,n):t.push(j.CoreUser.getProfile(n.touserid,void 0,!0).catch((()=>{})).then((t=>{const o={id:0,type:1,membercount:0,ismuted:!1,isfavourite:!1,isread:!1,members:[],messages:[],candeletemessagesforallusers:!1,userid:n.touserid,name:t?t.fullname:String(n.touserid),imageurl:t?t.profileimageurl:""};s.addLastOfflineMessage(o,n),s.addOfflineConversation(o,e)})))}})),yield Promise.all(t)}))()}addOfflineConversation(e,n){n.conversations.unshift(e)}addLastOfflineMessage(e,n){e.lastmessage=n.text,e.lastmessagedate=n.timecreated/1e3,e.lastmessagepending=!0,e.sentfromcurrentuser=!0}getConversationOptionName(e){return e.isfavourite?"favourites":2===e.type?"group":"individual"}refreshData(e,n=!0){var s=this;return(0,a.A)((function*(){try{yield r.AddonMessages.invalidateContactRequestsCountCache(s.siteId)}finally{try{yield s.fetchData(n)}finally{null==e||e.complete()}}}))()}accordionGroupChange(e){const n=e.value;if(!n)return;const s=this.getConversationGroupByName(n);this.expandOption(s,!0).catch((e=>{c.CoreDomUtils.showErrorModalDefault(e,"addon.messages.errorwhileretrievingdiscussions",!0)}))}expandOption(e,n=!1){var s=this;return(0,a.A)((function*(){e.loading=!0,s.accordionGroup.value=e.optionName;try{yield s.fetchDataForOption(e,!1,n)}catch(e){throw s.accordionGroup.value=void 0,e}finally{e.loading=!1}}))()}gotoSearch(){_.CoreNavigator.navigateToSitePath("search")}ngOnDestroy(){var e,n,s,t,o,a,i,r,c;null===(e=this.newMessagesObserver)||void 0===e||e.off(),null===(n=this.appResumeSubscription)||void 0===n||n.unsubscribe(),null===(s=this.pushObserver)||void 0===s||s.unsubscribe(),null===(t=this.readChangedObserver)||void 0===t||t.off(),null===(o=this.cronObserver)||void 0===o||o.off(),null===(a=this.openConversationObserver)||void 0===a||a.off(),null===(i=this.updateConversationListObserver)||void 0===i||i.off(),null===(r=this.contactRequestsCountObserver)||void 0===r||r.off(),null===(c=this.memberInfoObserver)||void 0===c||c.off()}}return(e=AddonMessagesGroupConversationsPage).ɵfac=function AddonMessagesGroupConversationsPage_Factory(n){return new(n||e)(f.rXU(p.nX))},e.ɵcmp=f.VBU({type:e,selectors:[["page-addon-messages-group-conversations"]],viewQuery:function AddonMessagesGroupConversationsPage_Query(e,n){if(1&e&&(f.GBs(m.M,5),f.GBs(O.W9,5),f.GBs(le,7)),2&e){let e;f.mGM(e=f.lsd())&&(n.splitView=e.first),f.mGM(e=f.lsd())&&(n.content=e.first),f.mGM(e=f.lsd())&&(n.accordionGroup=e.first)}},decls:37,vars:24,consts:[["accordionGroup",""],["conversationsTemplate",""],["slot","start"],[3,"text"],["slot","end"],["fill","clear",3,"click","ariaLabel"],["name","fas-magnifying-glass","slot","icon-only","aria-hidden","true"],[3,"click","ariaLabel"],["name","fas-gear","slot","icon-only","aria-hidden","true"],["slot","fixed",3,"ionRefresh","disabled"],[3,"pullingText"],[3,"hideUntil","message"],["button","",1,"ion-text-wrap",3,"click","detail"],["name","fas-address-book","slot","start","aria-hidden","true"],[1,"item-heading"],["slot","end",4,"ngIf"],[3,"ionChange"],["toggleIconSlot","start",3,"value",4,"ngFor","ngForOf"],["toggleIconSlot","start",3,"value"],["slot","header",1,"ion-text-wrap","divider"],["slot","content"],[4,"ngIf"],["class","ion-text-center",4,"ngIf"],[4,"ngTemplateOutlet","ngTemplateOutletContext"],[3,"action","enabled","error"],["class","ion-text-wrap",4,"ngIf"],[1,"ion-text-wrap"],[1,"ion-text-center"],["class","ion-text-wrap addon-message-discussion","button","",3,"detail","id","click",4,"ngFor","ngForOf"],["button","",1,"ion-text-wrap","addon-message-discussion",3,"click","detail","id"],["slot","start",4,"ngIf"],["core-user-avatar","","slot","start",3,"user","linkProfile","checkOnline",4,"ngIf"],[1,"flex-row","ion-justify-content-between"],["contextLevel","system",3,"text","contextInstanceId"],["name","fas-user-slash",4,"ngIf"],["name","fas-volume-xmark",3,"title",4,"ngIf"],["class","addon-message-last-message",4,"ngIf"],["core-external-content","","onError","this.src='assets/img/group-avatar.svg'",3,"url","alt"],["core-user-avatar","","slot","start",3,"user","linkProfile","checkOnline"],["name","fas-user-slash"],["name","fas-volume-xmark",3,"title"],["class","addon-message-last-message-date",4,"ngIf"],["aria-label","true",4,"ngIf"],["class","sr-only",4,"ngIf"],[1,"addon-message-last-message-date"],["aria-label","true"],[1,"sr-only"],[1,"addon-message-last-message"],["class","addon-message-last-message-user",4,"ngIf"],["clean","true","singleLine","true","contextLevel","system",1,"addon-message-last-message-text",3,"text","contextInstanceId"],[1,"addon-message-last-message-user"]],template:function AddonMessagesGroupConversationsPage_Template(e,n){if(1&e){const e=f.RV6();f.j41(0,"ion-header")(1,"ion-toolbar")(2,"ion-buttons",2),f.nrm(3,"ion-back-button",3),f.nI1(4,"translate"),f.k0s(),f.j41(5,"ion-title")(6,"h1"),f.EFF(7),f.nI1(8,"translate"),f.k0s()(),f.j41(9,"ion-buttons",4)(10,"ion-button",5),f.nI1(11,"translate"),f.bIt("click",(function AddonMessagesGroupConversationsPage_Template_ion_button_click_10_listener(){return f.eBV(e),f.Njj(n.gotoSearch())})),f.nrm(12,"ion-icon",6),f.k0s(),f.j41(13,"ion-button",7),f.nI1(14,"translate"),f.bIt("click",(function AddonMessagesGroupConversationsPage_Template_ion_button_click_13_listener(){return f.eBV(e),f.Njj(n.gotoSettings())})),f.nrm(15,"ion-icon",8),f.k0s(),f.nrm(16,"core-context-menu")(17,"core-user-menu-button"),f.k0s()()(),f.j41(18,"ion-content")(19,"core-split-view")(20,"ion-refresher",9),f.bIt("ionRefresh",(function AddonMessagesGroupConversationsPage_Template_ion_refresher_ionRefresh_20_listener(s){return f.eBV(e),f.Njj(n.refreshData(s.target))})),f.nrm(21,"ion-refresher-content",10),f.nI1(22,"translate"),f.k0s(),f.j41(23,"core-loading",11)(24,"ion-list")(25,"ion-item",12),f.bIt("click",(function AddonMessagesGroupConversationsPage_Template_ion_item_click_25_listener(){return f.eBV(e),f.Njj(n.gotoContacts())})),f.nrm(26,"ion-icon",13),f.j41(27,"ion-label")(28,"p",14),f.EFF(29),f.nI1(30,"translate"),f.k0s()(),f.DNE(31,AddonMessagesGroupConversationsPage_ion_badge_31_Template,3,7,"ion-badge",15),f.k0s(),f.j41(32,"ion-accordion-group",16,0),f.bIt("ionChange",(function AddonMessagesGroupConversationsPage_Template_ion_accordion_group_ionChange_32_listener(s){return f.eBV(e),f.Njj(n.accordionGroupChange(s.detail))})),f.DNE(34,AddonMessagesGroupConversationsPage_ion_accordion_34_Template,10,8,"ion-accordion",17),f.k0s()()()()(),f.DNE(35,AddonMessagesGroupConversationsPage_ng_template_35_Template,1,1,"ng-template",null,1,f.C5r)}2&e&&(f.R7$(3),f.Y8G("text",f.bMT(4,12,"core.back")),f.R7$(4),f.JRh(f.bMT(8,14,"addon.messages.messages")),f.R7$(3),f.Y8G("ariaLabel",f.bMT(11,16,"addon.messages.searchcombined")),f.R7$(3),f.Y8G("ariaLabel",f.bMT(14,18,"addon.messages.messagepreferences")),f.R7$(7),f.Y8G("disabled",!n.loaded),f.R7$(),f.FS9("pullingText",f.bMT(22,20,"core.pulltorefresh")),f.R7$(2),f.Y8G("hideUntil",n.loaded)("message",n.loadingMessage),f.R7$(2),f.Y8G("detail",!0),f.R7$(4),f.JRh(f.bMT(30,22,"addon.messages.contacts")),f.R7$(2),f.Y8G("ngIf",n.contactRequestsCount>0),f.R7$(3),f.Y8G("ngForOf",n.groupConversations))},dependencies:[M.Sq,M.bT,M.T3,v.B,k.b,b.R,m.M,P.T,ee.l,x.t,D.B,I.i,w.T,O.xk,O.YH,O.mC,O.In,O.Jm,O.QW,O.W9,O.eU,O.iq,O.uz,O.he,O.nf,O.JI,O.To,O.Ki,O.w2,O.BC,O.ai,O.el,re.U,ce.Y,T.D9],styles:["[_nghost-%COMP%]   .addon-messages-conversation-item[_ngcontent-%COMP%]   ion-label[_ngcontent-%COMP%], [_nghost-%COMP%]   .addon-message-discussion[_ngcontent-%COMP%]   ion-label[_ngcontent-%COMP%]{margin-right:0;margin-left:0}[_nghost-%COMP%]   .addon-messages-conversation-item[_ngcontent-%COMP%]   .item-heading[_ngcontent-%COMP%]   core-format-text[_ngcontent-%COMP%], [_nghost-%COMP%]   .addon-message-discussion[_ngcontent-%COMP%]   .item-heading[_ngcontent-%COMP%]   core-format-text[_ngcontent-%COMP%]{font-weight:700}[_nghost-%COMP%]   .addon-messages-conversation-item[_ngcontent-%COMP%]   .item-heading[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%], [_nghost-%COMP%]   .addon-message-discussion[_ngcontent-%COMP%]   .item-heading[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{margin-inline-start:2px}[_nghost-%COMP%]   .addon-messages-conversation-item[_ngcontent-%COMP%]   ion-note[_ngcontent-%COMP%], [_nghost-%COMP%]   .addon-message-discussion[_ngcontent-%COMP%]   ion-note[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-self:flex-start;margin-inline-start:2px}[_nghost-%COMP%]   .addon-messages-conversation-item[_ngcontent-%COMP%]   ion-note[_ngcontent-%COMP%]   ion-badge[_ngcontent-%COMP%], [_nghost-%COMP%]   .addon-messages-conversation-item[_ngcontent-%COMP%]   ion-note[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%], [_nghost-%COMP%]   .addon-message-discussion[_ngcontent-%COMP%]   ion-note[_ngcontent-%COMP%]   ion-badge[_ngcontent-%COMP%], [_nghost-%COMP%]   .addon-message-discussion[_ngcontent-%COMP%]   ion-note[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{margin-top:3px;align-self:flex-end}[_nghost-%COMP%]   .addon-messages-conversation-item[_ngcontent-%COMP%]   ion-note[_ngcontent-%COMP%]   .addon-message-last-message-date[_ngcontent-%COMP%], [_nghost-%COMP%]   .addon-message-discussion[_ngcontent-%COMP%]   ion-note[_ngcontent-%COMP%]   .addon-message-last-message-date[_ngcontent-%COMP%]{white-space:nowrap;font-size:.6875rem}[_nghost-%COMP%]   .addon-messages-conversation-item[_ngcontent-%COMP%]   .addon-message-last-message[_ngcontent-%COMP%], [_nghost-%COMP%]   .addon-message-discussion[_ngcontent-%COMP%]   .addon-message-last-message[_ngcontent-%COMP%]{display:flex;justify-content:flex-start}[_nghost-%COMP%]   .addon-messages-conversation-item[_ngcontent-%COMP%]   .addon-message-last-message-user[_ngcontent-%COMP%], [_nghost-%COMP%]   .addon-message-discussion[_ngcontent-%COMP%]   .addon-message-last-message-user[_ngcontent-%COMP%]{white-space:nowrap;color:var(--ion-text-color);margin-inline-end:2px}[_nghost-%COMP%]   .addon-messages-conversation-item[_ngcontent-%COMP%]   .addon-message-last-message-text[_ngcontent-%COMP%], [_nghost-%COMP%]   .addon-message-discussion[_ngcontent-%COMP%]   .addon-message-last-message-text[_ngcontent-%COMP%]{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex-shrink:1}[_nghost-%COMP%]   .addon-message-discussion[_ngcontent-%COMP%]   .item-heading[_ngcontent-%COMP%]{margin-top:10px}[_nghost-%COMP%]   ion-item-divider[_ngcontent-%COMP%]   ion-badge[_ngcontent-%COMP%]{margin-left:16px;margin-right:16px}"]}),AddonMessagesGroupConversationsPage})();const search_c0=e=>({item:e});function AddonMessagesSearchPage_ion_list_16_ng_container_1_Template(e,n){1&e&&f.eu8(0)}function AddonMessagesSearchPage_ion_list_16_ng_container_2_Template(e,n){1&e&&f.eu8(0)}function AddonMessagesSearchPage_ion_list_16_ng_container_3_Template(e,n){1&e&&f.eu8(0)}function AddonMessagesSearchPage_ion_list_16_Template(e,n){if(1&e){const e=f.RV6();f.j41(0,"ion-list"),f.DNE(1,AddonMessagesSearchPage_ion_list_16_ng_container_1_Template,1,0,"ng-container",8)(2,AddonMessagesSearchPage_ion_list_16_ng_container_2_Template,1,0,"ng-container",8)(3,AddonMessagesSearchPage_ion_list_16_ng_container_3_Template,1,0,"ng-container",8),f.j41(4,"core-infinite-loading",9),f.bIt("action",(function AddonMessagesSearchPage_ion_list_16_Template_core_infinite_loading_action_4_listener(n){f.eBV(e);const s=f.XpG();return f.Njj(s.search(s.query,"messages",n))})),f.k0s()()}if(2&e){const e=f.XpG(),n=f.sdS(19);f.R7$(),f.Y8G("ngTemplateOutlet",n)("ngTemplateOutletContext",f.eq3(8,search_c0,e.contacts)),f.R7$(),f.Y8G("ngTemplateOutlet",n)("ngTemplateOutletContext",f.eq3(10,search_c0,e.nonContacts)),f.R7$(),f.Y8G("ngTemplateOutlet",n)("ngTemplateOutletContext",f.eq3(12,search_c0,e.messages)),f.R7$(),f.Y8G("enabled",e.messages.canLoadMore)("error",e.messages.loadMoreError)}}function AddonMessagesSearchPage_core_empty_box_17_Template(e,n){1&e&&(f.nrm(0,"core-empty-box",10),f.nI1(1,"translate")),2&e&&f.Y8G("message",f.bMT(1,1,"core.noresults"))}function AddonMessagesSearchPage_ng_template_18_ng_container_0_ion_item_6_ion_icon_5_Template(e,n){1&e&&(f.nrm(0,"ion-icon",21),f.nI1(1,"translate")),2&e&&f.BMQ("aria-label",f.bMT(1,1,"addon.messages.contactblocked"))}function AddonMessagesSearchPage_ng_template_18_ng_container_0_ion_item_6_ion_note_6_Template(e,n){if(1&e&&(f.j41(0,"ion-note"),f.EFF(1),f.nI1(2,"coreDateDayOrTime"),f.k0s()),2&e){const e=f.XpG().$implicit;f.R7$(),f.SpI(" ",f.bMT(2,1,e.lastmessagedate)," ")}}function AddonMessagesSearchPage_ng_template_18_ng_container_0_ion_item_6_span_8_Template(e,n){1&e&&(f.j41(0,"span",22),f.EFF(1),f.nI1(2,"translate"),f.k0s()),2&e&&(f.R7$(),f.SpI(" ",f.bMT(2,1,"addon.messages.you")," "))}function AddonMessagesSearchPage_ng_template_18_ng_container_0_ion_item_6_Template(e,n){if(1&e){const e=f.RV6();f.j41(0,"ion-item",13),f.bIt("click",(function AddonMessagesSearchPage_ng_template_18_ng_container_0_ion_item_6_Template_ion_item_click_0_listener(){const n=f.eBV(e).$implicit,s=f.XpG(3);return f.Njj(s.openConversation(n))})),f.nrm(1,"core-user-avatar",14),f.j41(2,"ion-label")(3,"p",15),f.nrm(4,"core-format-text",16),f.DNE(5,AddonMessagesSearchPage_ng_template_18_ng_container_0_ion_item_6_ion_icon_5_Template,2,3,"ion-icon",17),f.k0s(),f.DNE(6,AddonMessagesSearchPage_ng_template_18_ng_container_0_ion_item_6_ion_note_6_Template,3,3,"ion-note",6),f.j41(7,"p",18),f.DNE(8,AddonMessagesSearchPage_ng_template_18_ng_container_0_ion_item_6_span_8_Template,3,3,"span",19),f.nrm(9,"core-format-text",20),f.k0s()()()}if(2&e){const e=n.$implicit,s=f.XpG(3);f.Y8G("detail",!0),f.BMQ("aria-label",e.fullname)("aria-current",e===s.selectedResult?"page":"false"),f.R7$(),f.Y8G("user",e)("checkOnline",!0)("linkProfile",!1),f.R7$(3),f.Y8G("text",e.fullname)("highlight",e.highlightName)("filter",!1),f.R7$(),f.Y8G("ngIf",e.isblocked),f.R7$(),f.Y8G("ngIf",e.lastmessagedate>0),f.R7$(2),f.Y8G("ngIf",e.sentfromcurrentuser),f.R7$(),f.Y8G("text",e.lastmessage)("highlight",e.highlightMessage)("contextInstanceId",0)}}function AddonMessagesSearchPage_ng_template_18_ng_container_0_ng_container_7_div_1_Template(e,n){if(1&e){const e=f.RV6();f.j41(0,"div",25)(1,"ion-button",26),f.bIt("click",(function AddonMessagesSearchPage_ng_template_18_ng_container_0_ng_container_7_div_1_Template_ion_button_click_1_listener(){f.eBV(e);const n=f.XpG(3).item,s=f.XpG();return f.Njj(s.search(s.query,n.type))})),f.EFF(2),f.nI1(3,"translate"),f.k0s()()}2&e&&(f.R7$(2),f.SpI(" ",f.bMT(3,1,"core.loadmore")," "))}function AddonMessagesSearchPage_ng_template_18_ng_container_0_ng_container_7_div_2_Template(e,n){1&e&&(f.j41(0,"div",27),f.nrm(1,"ion-spinner"),f.nI1(2,"translate"),f.k0s()),2&e&&(f.R7$(),f.BMQ("aria-label",f.bMT(2,1,"core.loading")))}function AddonMessagesSearchPage_ng_template_18_ng_container_0_ng_container_7_Template(e,n){if(1&e&&(f.qex(0),f.DNE(1,AddonMessagesSearchPage_ng_template_18_ng_container_0_ng_container_7_div_1_Template,4,3,"div",23)(2,AddonMessagesSearchPage_ng_template_18_ng_container_0_ng_container_7_div_2_Template,3,3,"div",24),f.bVm()),2&e){const e=f.XpG(2).item;f.R7$(),f.Y8G("ngIf",e.canLoadMore&&!e.loadingMore),f.R7$(),f.Y8G("ngIf",e.loadingMore)}}function AddonMessagesSearchPage_ng_template_18_ng_container_0_Template(e,n){if(1&e&&(f.qex(0),f.j41(1,"ion-item-divider",11)(2,"ion-label")(3,"h2"),f.EFF(4),f.nI1(5,"translate"),f.k0s()()(),f.DNE(6,AddonMessagesSearchPage_ng_template_18_ng_container_0_ion_item_6_Template,10,15,"ion-item",12)(7,AddonMessagesSearchPage_ng_template_18_ng_container_0_ng_container_7_Template,3,2,"ng-container",6),f.bVm()),2&e){const e=f.XpG().item;f.R7$(4),f.JRh(f.bMT(5,3,e.titleString)),f.R7$(2),f.Y8G("ngForOf",e.results),f.R7$(),f.Y8G("ngIf","messages"!==e.type)}}function AddonMessagesSearchPage_ng_template_18_Template(e,n){if(1&e&&f.DNE(0,AddonMessagesSearchPage_ng_template_18_ng_container_0_Template,8,5,"ng-container",6),2&e){f.Y8G("ngIf",n.item.results.length>0)}}let _e=(()=>{var e;class AddonMessagesSearchPage{constructor(){this.disableSearch=!1,this.displaySearching=!1,this.displayResults=!1,this.query="",this.contacts={type:"contacts",titleString:"addon.messages.contacts",results:[],canLoadMore:!1,loadingMore:!1},this.nonContacts={type:"noncontacts",titleString:"addon.messages.noncontacts",results:[],canLoadMore:!1,loadingMore:!1},this.messages={type:"messages",titleString:"addon.messages.messages",results:[],canLoadMore:!1,loadingMore:!1,loadMoreError:!1},this.memberInfoObserver=d.z.on(h.Ie,(e=>{if(!e.userBlocked&&!e.userUnblocked)return;const n=this.contacts.results.find((n=>n.id==e.userId));if(n)n.isblocked=!!e.userBlocked;else{const n=this.nonContacts.results.find((n=>n.id==e.userId));n&&(n.isblocked=!!e.userBlocked)}this.messages.results.forEach((n=>{n.userid==e.userId&&(n.isblocked=!!e.userBlocked)}))}),i.CoreSites.getCurrentSiteId())}clearSearch(){this.query="",this.displayResults=!1;const e=_.CoreNavigator.getRelativePathToParent("/messages/search");e&&_.CoreNavigator.navigate(e)}search(e,n,s){var t=this;return(0,a.A)((function*(){u.p.close(),t.query=e,t.disableSearch=!0,t.displaySearching=!n;const o=[];let a=[],i=[],d=[],l=!1,g=!1,_=!1;if(!n||"contacts"==n||"noncontacts"==n){const s=n?h.xT:h._R;let c=0;"contacts"==n?(c=t.contacts.results.length,t.contacts.loadingMore=!0):"noncontacts"==n&&(c=t.nonContacts.results.length,t.nonContacts.loadingMore=!0),o.push(r.AddonMessages.searchUsers(e,c,s).then((e=>{n&&"contacts"!=n||(a=e.contacts,l=e.canLoadMoreContacts),n&&"noncontacts"!=n||(i=e.nonContacts,g=e.canLoadMoreNonContacts)})))}if(!n||"messages"==n){let s=0;"messages"==n&&(s=t.messages.results.length,t.messages.loadingMore=!0),o.push(r.AddonMessages.searchMessages(e,void 0,s).then((e=>{d=e.messages,_=e.canLoadMore})))}try{yield Promise.all(o),n||(t.contacts.results=[],t.nonContacts.results=[],t.messages.results=[]),t.displayResults=!0,n&&"contacts"!=n||(t.contacts.results.push(...a),t.contacts.canLoadMore=l,t.setHighlight(a,!0)),n&&"noncontacts"!=n||(t.nonContacts.results.push(...i),t.nonContacts.canLoadMore=g,t.setHighlight(i,!0)),n&&"messages"!=n||(t.messages.results.push(...d),t.messages.canLoadMore=_,t.messages.loadMoreError=!1,t.setHighlight(d,!1)),n||(t.contacts.results.length>0?t.openConversation(t.contacts.results[0],!0):t.nonContacts.results.length>0?t.openConversation(t.nonContacts.results[0],!0):t.messages.results.length>0&&t.openConversation(t.messages.results[0],!0))}catch(e){c.CoreDomUtils.showErrorModalDefault(e,"addon.messages.errorwhileretrievingusers",!0),"messages"==n&&(t.messages.loadMoreError=!0)}finally{t.disableSearch=!1,t.displaySearching=!1,"contacts"==n?t.contacts.loadingMore=!1:"noncontacts"==n?t.nonContacts.loadingMore=!1:"messages"==n&&(t.messages.loadingMore=!1),s&&s()}}))()}openConversation(e,n=!1){if(!n||g.CoreScreen.isTablet){let n,s;this.selectedResult=e,"conversationid"in e?n=e.conversationid:s=e.id;const t=_.CoreNavigator.getRelativePathToParent("/messages/search")+"discussion/"+(n||`user/${s}`);_.CoreNavigator.navigate(t,{reset:g.CoreScreen.isTablet&&!!this.splitView&&!this.splitView.isNested})}}setHighlight(e,n=!1){e.forEach((e=>{e.highlightName=n?this.query:void 0,e.highlightMessage=n?void 0:this.query}))}ngOnDestroy(){var e;null===(e=this.memberInfoObserver)||void 0===e||e.off()}}return(e=AddonMessagesSearchPage).ɵfac=function AddonMessagesSearchPage_Factory(n){return new(n||e)},e.ɵcmp=f.VBU({type:e,selectors:[["page-addon-messages-search"]],viewQuery:function AddonMessagesSearchPage_Query(e,n){if(1&e&&f.GBs(m.M,5),2&e){let e;f.mGM(e=f.lsd())&&(n.splitView=e.first)}},decls:20,vars:16,consts:[["resultsTemplate",""],["slot","start"],[3,"text"],["slot","end"],["autocorrect","off","searchArea","AddonMessagesSearch",3,"onSubmit","onClear","disabled","spellcheck","autoFocus","lengthCheck"],[3,"hideUntil","message"],[4,"ngIf"],["icon","fas-magnifying-glass","role","alert",3,"message",4,"ngIf"],[4,"ngTemplateOutlet","ngTemplateOutletContext"],[3,"action","enabled","error"],["icon","fas-magnifying-glass","role","alert",3,"message"],[1,"ion-text-wrap"],["class","addon-message-discussion ion-text-wrap","button","",3,"detail","click",4,"ngFor","ngForOf"],["button","",1,"addon-message-discussion","ion-text-wrap",3,"click","detail"],["slot","start",3,"user","checkOnline","linkProfile"],[1,"item-heading"],[3,"text","highlight","filter"],["name","fas-ban",4,"ngIf"],[1,"addon-message-last-message"],["class","addon-message-last-message-user",4,"ngIf"],["clean","true","singleLine","true","contextLevel","system",1,"addon-message-last-message-text",3,"text","highlight","contextInstanceId"],["name","fas-ban"],[1,"addon-message-last-message-user"],["class","ion-padding-horizontal",4,"ngIf"],["class","ion-padding ion-text-center",4,"ngIf"],[1,"ion-padding-horizontal"],["expand","block","fill","outline",3,"click"],[1,"ion-padding","ion-text-center"]],template:function AddonMessagesSearchPage_Template(e,n){if(1&e){const e=f.RV6();f.j41(0,"ion-header")(1,"ion-toolbar")(2,"ion-buttons",1),f.nrm(3,"ion-back-button",2),f.nI1(4,"translate"),f.k0s(),f.j41(5,"ion-title")(6,"h1"),f.EFF(7),f.nI1(8,"translate"),f.k0s()(),f.j41(9,"ion-buttons",3),f.nrm(10,"core-context-menu"),f.k0s()()(),f.j41(11,"ion-content")(12,"core-split-view")(13,"core-search-box",4),f.bIt("onSubmit",(function AddonMessagesSearchPage_Template_core_search_box_onSubmit_13_listener(s){return f.eBV(e),f.Njj(n.search(s))}))("onClear",(function AddonMessagesSearchPage_Template_core_search_box_onClear_13_listener(){return f.eBV(e),f.Njj(n.clearSearch())})),f.k0s(),f.j41(14,"core-loading",5),f.nI1(15,"translate"),f.DNE(16,AddonMessagesSearchPage_ion_list_16_Template,5,14,"ion-list",6)(17,AddonMessagesSearchPage_core_empty_box_17_Template,2,3,"core-empty-box",7),f.k0s()()(),f.DNE(18,AddonMessagesSearchPage_ng_template_18_Template,1,1,"ng-template",null,0,f.C5r)}2&e&&(f.R7$(3),f.Y8G("text",f.bMT(4,10,"core.back")),f.R7$(4),f.JRh(f.bMT(8,12,"addon.messages.searchcombined")),f.R7$(6),f.Y8G("disabled",n.disableSearch)("spellcheck",!1)("autoFocus",!0)("lengthCheck",1),f.R7$(),f.Y8G("hideUntil",!n.displaySearching)("message",f.bMT(15,14,"core.searching")),f.R7$(2),f.Y8G("ngIf",n.displayResults),f.R7$(),f.Y8G("ngIf",n.displayResults&&!n.contacts.results.length&&!n.nonContacts.results.length&&!n.messages.results.length))},dependencies:[M.Sq,M.bT,M.T3,v.B,C.h,k.b,b.R,m.M,P.T,x.t,D.B,I.i,w.T,O.Jm,O.QW,O.W9,O.eU,O.iq,O.uz,O.Dg,O.he,O.nf,O.JI,O.w2,O.BC,O.ai,O.el,y.M,ce.Y,T.D9],encapsulation:2}),AddonMessagesSearchPage})();var me=s(28186),ue=s(47720),he=s(42858),fe=s(51734);const pe=function(){var e=(0,a.A)((function*(e){const n=r.AddonMessages.isGroupMessagingEnabled(),s=l.Ix.parseUrl(`/main/${me.o.PAGE_NAME}/`+(n?"group-conversations":"index"));return s.queryParams=e.queryParams,s}));return function messagesIndexGuard(n){return e.apply(this,arguments)}}();function buildRoutes(e){const n=[{path:"discussion/user/:userId",component:te},{path:"discussion/:conversationId",component:te}],o=[{path:"contacts",component:$},{path:"index",data:{mainMenuTabRoot:me.o.PAGE_NAME},component:de},{path:"contacts-35",component:A},{path:"group-conversations",data:{mainMenuTabRoot:me.o.PAGE_NAME},component:ge},{path:"search",component:_e}].reduce(((e,s)=>[...e,s,...n.map((e=>({...e,path:`${s.path}/${e.path}`})))]),[]),a=[{path:"contacts",component:$,children:n},{path:"index",data:{mainMenuTabRoot:me.o.PAGE_NAME},component:de,children:n},{path:"contacts-35",component:A,children:n},{path:"group-conversations",data:{mainMenuTabRoot:me.o.PAGE_NAME},component:ge,children:n},{path:"search",component:_e,children:n}];return[...(0,t.VI)(o,(()=>g.CoreScreen.isMobile)),...(0,t.VI)(a,(()=>g.CoreScreen.isTablet)),...n,{path:"message-settings",loadChildren:()=>s.e(1876).then(s.bind(s,31876))},...(0,he.B)(e,{canActivate:[pe]})]}let Me=(()=>{var e;class AddonMessagesLazyModule{}return(e=AddonMessagesLazyModule).ɵfac=function AddonMessagesLazyModule_Factory(n){return new(n||e)},e.ɵmod=f.$C({type:e}),e.ɵinj=f.G2t({providers:[{provide:p.bw,multi:!0,deps:[f.zZn],useFactory:buildRoutes}],imports:[o.n,fe._,ue.E]}),AddonMessagesLazyModule})();void(("undefined"==typeof ngJitMode||ngJitMode)&&f.Obh(Me,{declarations:[A,$,te,de,ge,_e],imports:[o.n,fe._,ue.E]}))}}]);