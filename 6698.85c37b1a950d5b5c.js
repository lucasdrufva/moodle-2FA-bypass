"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[6698],{96698:(t,e,n)=>{n.r(e),n.d(e,{AddonModH5PActivityIndexComponent:()=>G});var i=n(10467),o=n(54438),a=n(74431),s=n(69006),r=n(74691),d=n(53867),c=n(59863),l=n(65630),p=n(94455),m=n(88793),_=n(15324),u=n(52749),y=n(89911),f=n(49882),A=n(34961),v=n(8257),h=n(88436),I=n(75383),g=n(55554),C=n(9153),x=n(73465),P=n(51024),w=n(60177),D=n(69502),M=n(17388),b=n(64422),S=n(13988),F=n(49234),T=n(86198),O=n(66731),k=n(43570),H=n(6736),E=n(30864),R=n(88695),U=n(73955);function AddonModH5PActivityIndexComponent_core_context_menu_item_2_Template(t,e){if(1&t){const t=o.RV6();o.j41(0,"core-context-menu-item",10),o.nI1(1,"translate"),o.bIt("action",(function AddonModH5PActivityIndexComponent_core_context_menu_item_2_Template_core_context_menu_item_action_0_listener(){o.eBV(t);const e=o.XpG();return o.Njj(e.viewMyAttempts())})),o.k0s()}2&t&&o.Y8G("priority",1e3)("content",o.bMT(1,2,"addon.mod_h5pactivity.attempts_report"))}function AddonModH5PActivityIndexComponent_core_context_menu_item_3_Template(t,e){if(1&t){const t=o.RV6();o.j41(0,"core-context-menu-item",10),o.nI1(1,"translate"),o.bIt("action",(function AddonModH5PActivityIndexComponent_core_context_menu_item_3_Template_core_context_menu_item_action_0_listener(){o.eBV(t);const e=o.XpG();return o.Njj(e.viewAllAttempts())})),o.k0s()}2&t&&o.Y8G("priority",1e3)("content",o.bMT(1,2,"addon.mod_h5pactivity.attempts_report"))}function AddonModH5PActivityIndexComponent_Conditional_4_Template(t,e){if(1&t){const t=o.RV6();o.j41(0,"core-context-menu-item",11),o.nI1(1,"translate"),o.bIt("action",(function AddonModH5PActivityIndexComponent_Conditional_4_Template_core_context_menu_item_action_0_listener(){o.eBV(t);const e=o.XpG();return o.Njj(e.openModuleSummary())})),o.k0s()}2&t&&o.Y8G("priority",5e3)("content",o.bMT(1,2,"core.info"))}function AddonModH5PActivityIndexComponent_Conditional_5_Template(t,e){if(1&t){const t=o.RV6();o.j41(0,"ion-button",12),o.nI1(1,"translate"),o.bIt("click",(function AddonModH5PActivityIndexComponent_Conditional_5_Template_ion_button_click_0_listener(){o.eBV(t);const e=o.XpG();return o.Njj(e.openModuleSummary())})),o.nrm(2,"ion-icon",13),o.k0s()}2&t&&o.Y8G("ariaLabel",o.bMT(1,1,"core.info"))}function AddonModH5PActivityIndexComponent_ion_card_8_Template(t,e){1&t&&(o.j41(0,"ion-card",14)(1,"ion-item"),o.nrm(2,"ion-icon",15),o.j41(3,"ion-label"),o.EFF(4),o.nI1(5,"translate"),o.nI1(6,"translate"),o.k0s()()()),2&t&&(o.R7$(4),o.Lme(" ",o.bMT(5,2,"core.h5p.offlinedisabled")," ",o.bMT(6,4,"addon.mod_h5pactivity.offlinedisabledwarning")," "))}function AddonModH5PActivityIndexComponent_ion_card_9_Template(t,e){1&t&&(o.j41(0,"ion-card",14)(1,"ion-item"),o.nrm(2,"ion-icon",15),o.j41(3,"ion-label"),o.EFF(4),o.nI1(5,"translate"),o.k0s()()()),2&t&&(o.R7$(4),o.SpI(" ",o.bMT(5,1,"addon.mod_h5pactivity.previewmode")," "))}function AddonModH5PActivityIndexComponent_ion_list_10_ion_item_1_Template(t,e){if(1&t&&(o.j41(0,"ion-item",19)(1,"ion-label"),o.EFF(2),o.nI1(3,"translate"),o.k0s()()),2&t){const t=o.XpG(2);o.R7$(2),o.JRh(o.bMT(3,1,t.stateMessage))}}function AddonModH5PActivityIndexComponent_ion_list_10_ion_button_2_Template(t,e){if(1&t){const t=o.RV6();o.j41(0,"ion-button",20),o.bIt("click",(function AddonModH5PActivityIndexComponent_ion_list_10_ion_button_2_Template_ion_button_click_0_listener(e){o.eBV(t);const n=o.XpG(2);return o.Njj(n.downloadAndPlay(e))})),o.EFF(1),o.nI1(2,"translate"),o.k0s()}2&t&&(o.R7$(),o.SpI(" ",o.bMT(2,1,"addon.mod_h5pactivity.downloadh5pfile")," "))}function AddonModH5PActivityIndexComponent_ion_list_10_ion_item_3_p_4_Template(t,e){if(1&t&&(o.j41(0,"p",24),o.EFF(1),o.nI1(2,"translate"),o.k0s()),2&t){const t=o.XpG(3);o.R7$(),o.JRh(o.bMT(2,1,t.progressMessage))}}function AddonModH5PActivityIndexComponent_ion_list_10_ion_item_3_core_progress_bar_5_Template(t,e){if(1&t&&o.nrm(0,"core-progress-bar",25),2&t){const t=o.XpG(3);o.Y8G("progress",t.percentage)("a11yText",t.progressMessage)}}function AddonModH5PActivityIndexComponent_ion_list_10_ion_item_3_Template(t,e){if(1&t&&(o.j41(0,"ion-item",21)(1,"ion-label"),o.nrm(2,"ion-spinner"),o.nI1(3,"translate"),o.DNE(4,AddonModH5PActivityIndexComponent_ion_list_10_ion_item_3_p_4_Template,3,3,"p",22)(5,AddonModH5PActivityIndexComponent_ion_list_10_ion_item_3_core_progress_bar_5_Template,1,2,"core-progress-bar",23),o.k0s()()),2&t){const t=o.XpG(2);o.R7$(2),o.BMQ("aria-label",o.bMT(3,3,"core.loading")),o.R7$(2),o.Y8G("ngIf",t.progressMessage),o.R7$(),o.Y8G("ngIf",t.showPercentage)}}function AddonModH5PActivityIndexComponent_ion_list_10_Template(t,e){if(1&t&&(o.j41(0,"ion-list"),o.DNE(1,AddonModH5PActivityIndexComponent_ion_list_10_ion_item_1_Template,4,3,"ion-item",16)(2,AddonModH5PActivityIndexComponent_ion_list_10_ion_button_2_Template,3,3,"ion-button",17)(3,AddonModH5PActivityIndexComponent_ion_list_10_ion_item_3_Template,6,5,"ion-item",18),o.k0s()),2&t){const t=o.XpG();o.R7$(),o.Y8G("ngIf",t.stateMessage),o.R7$(),o.Y8G("ngIf",!t.downloading&&t.needsDownload),o.R7$(),o.Y8G("ngIf",t.downloading)}}function AddonModH5PActivityIndexComponent_core_h5p_iframe_11_Template(t,e){if(1&t&&o.nrm(0,"core-h5p-iframe",26),2&t){const t=o.XpG();o.Y8G("fileUrl",t.fileUrl)("displayOptions",t.displayOptions)("onlinePlayerUrl",t.onlinePlayerUrl)("trackComponent",t.trackComponent)("contextId",null==t.h5pActivity?null:t.h5pActivity.context)("enableInAppFullscreen",!0)("saveFreq",t.saveFreq)("state",t.contentState)}}let G=(()=>{var t;class AddonModH5PActivityIndexComponent extends s.y{constructor(t,e){super("AddonModH5PActivityIndexComponent",t,e),this.content=t,this.onActivityFinish=new o.bkB,this.component=C.hS,this.pluginName="h5pactivity",this.downloading=!1,this.needsDownload=!1,this.showPercentage=!1,this.playing=!1,this.siteCanDownload=!1,this.hasOffline=!1,this.isOpeningPage=!1,this.canViewAllAttempts=!1,this.saveStateEnabled=!1,this.fetchContentDefaultError="addon.mod_h5pactivity.errorgetactivity",this.syncEventName=C.EJ,this.checkCompletionAfterLog=!1,this.site=u.CoreSites.getRequiredCurrentSite(),this.siteCanDownload=this.site.canDownloadFiles()&&!d.CoreH5P.isOfflineDisabledInSite(),this.messageListenerFunction=t=>this.onIframeMessage(t),window.addEventListener("message",this.messageListenerFunction)}ngOnInit(){var _superprop_getNgOnInit=()=>super.ngOnInit,t=this;return(0,i.A)((function*(){_superprop_getNgOnInit().call(t),t.loadContent(!1,!0)}))()}fetchContent(t,e=!1,n=!1){var o=this;return(0,i.A)((function*(){var t,i,s;o.showLoading=!0,o.playing=!1,o.h5pActivity=yield A.R.getH5PActivity(o.courseId,o.module.id,{siteId:o.siteId}),o.dataRetrieved.emit(o.h5pActivity),o.description=o.h5pActivity.intro,o.displayOptions=r.P.decodeDisplayOptions(o.h5pActivity.displayoptions),e&&(yield o.syncActivity(n)),yield Promise.all([o.checkHasOffline(),o.fetchAccessInfo(),o.fetchDeployedFileData()]),yield o.loadContentState(),o.trackComponent=null!==(t=o.accessInfo)&&void 0!==t&&t.cansubmit?C.$J:"",o.canViewAllAttempts=!!o.h5pActivity.enabletracking&&!(null===(i=o.accessInfo)||void 0===i||!i.canreviewattempts)&&A.R.canGetUsersAttemptsInSite(),o.h5pActivity.package&&o.h5pActivity.package[0]&&(o.onlinePlayerUrl=d.CoreH5P.h5pPlayer.calculateOnlinePlayerUrl(o.site.getURL(),o.h5pActivity.package[0].fileurl,o.displayOptions,o.trackComponent)),o.siteCanDownload&&o.state!==a.DownloadStatus.DOWNLOADED?(o.state==a.DownloadStatus.DOWNLOADABLE_NOT_DOWNLOADED||o.state==a.DownloadStatus.OUTDATED)&&p.WE.isOnline()&&null!==(s=o.deployedFile)&&void 0!==s&&s.filesize&&m.CoreFilepool.shouldDownload(o.deployedFile.filesize)&&o.downloadAutomatically():o.play()}))()}checkHasOffline(){var t=this;return(0,i.A)((function*(){t.h5pActivity&&(t.hasOffline=yield c.CoreXAPIOffline.contextHasData(t.h5pActivity.context,t.siteId))}))()}fetchAccessInfo(){var t=this;return(0,i.A)((function*(){t.h5pActivity&&(t.accessInfo=yield A.R.getAccessInformation(t.h5pActivity.id,{cmId:t.module.id,siteId:t.siteId}))}))()}fetchDeployedFileData(){var t=this;return(0,i.A)((function*(){if(!t.siteCanDownload||!t.h5pActivity)return;t.deployedFile=yield A.R.getDeployedFile(t.h5pActivity,{displayOptions:t.displayOptions,siteId:t.siteId}),t.fileUrl=h.CoreFileHelper.getFileUrl(t.deployedFile);const e=yield m.CoreFilepool.getFileEventNameByUrl(t.site.getId(),t.fileUrl);t.observer||(t.observer=f.z.on(e,(()=>{t.calculateFileState()}))),yield t.calculateFileState()}))()}loadContentState(){var t=this;return(0,i.A)((function*(){var e;if(!t.h5pActivity||!t.accessInfo||!A.R.isSaveStateEnabled(t.h5pActivity,t.accessInfo))return t.saveStateEnabled=!1,t.contentState=void 0,void 0;t.saveStateEnabled=!0,t.saveFreq=t.h5pActivity.savestatefreq;const n=yield l.CoreXAPI.getState(C.$J,t.h5pActivity.context,C.HB,{appComponent:C.hS,appComponentId:t.h5pActivity.coursemodule,readingStrategy:3});if(null===n)return t.contentState=void 0,void 0;const i=I.Ni.parseJSON(n,{h5p:"{}"});t.contentState=null!==(e=i.h5p)&&void 0!==e?e:"{}"}))()}calculateFileState(){var t=this;return(0,i.A)((function*(){t.fileUrl&&t.deployedFile&&(t.state=yield m.CoreFilepool.getFileStateByUrl(t.site.getId(),t.fileUrl,t.deployedFile.timemodified),t.showFileState())}))()}invalidateContent(){return A.R.invalidateActivityData(this.courseId)}showFileState(){var t=this;return(0,i.A)((function*(){t.state===a.DownloadStatus.OUTDATED?(t.stateMessage="addon.mod_h5pactivity.filestateoutdated",t.needsDownload=!0):t.state===a.DownloadStatus.DOWNLOADABLE_NOT_DOWNLOADED?(t.stateMessage="addon.mod_h5pactivity.filestatenotdownloaded",t.needsDownload=!0):t.state===a.DownloadStatus.DOWNLOADING?(t.stateMessage="",t.downloading||(yield t.downloadDeployedFile(),t.play())):(t.stateMessage="",t.needsDownload=!1)}))()}downloadAndPlay(t){var e=this;return(0,i.A)((function*(){if(null==t||t.preventDefault(),null==t||t.stopPropagation(),e.deployedFile){if(!p.WE.isOnline())return y.CoreDomUtils.showErrorModal("core.networkerrormsg",!0),void 0;try{yield y.CoreDomUtils.confirmDownloadSize({size:e.deployedFile.filesize||0,total:!0}),yield e.downloadDeployedFile(),e.isDestroyed||e.play()}catch(t){if(y.CoreDomUtils.isCanceledError(t)||e.isDestroyed)return;y.CoreDomUtils.showErrorModalDefault(t,"core.errordownloading",!0)}}}))()}downloadAutomatically(){var t=this;return(0,i.A)((function*(){try{yield t.downloadDeployedFile(),t.isDestroyed||t.play()}catch(t){y.CoreDomUtils.showErrorModalDefault(t,"core.errordownloading",!0)}}))()}downloadDeployedFile(){var t=this;return(0,i.A)((function*(){if(!t.fileUrl||!t.deployedFile)return;const e=t.deployedFile;t.downloading=!0,t.progressMessage="core.downloading",t.deleteOfflineStates();try{yield m.CoreFilepool.downloadUrl(t.site.getId(),t.fileUrl,!1,t.component,t.componentId,e.timemodified,(n=>{if(n)if(t.percentage=void 0,t.showPercentage=!1,n.message)t.progressMessage=n.message;else if(void 0!==n.loaded){const i="core.downloading"==t.progressMessage?e.filesize:n.total;if(void 0!==i){const e=100*Number(n.loaded/i);t.percentage=e.toFixed(1),t.showPercentage=e>=0&&e<=100}}}))}finally{t.progressMessage=void 0,t.percentage=void 0,t.showPercentage=!1,t.downloading=!1}}))()}play(){var t=this;return(0,i.A)((function*(){t.h5pActivity&&(t.playing=!0,yield A.R.logView(t.h5pActivity.id,t.siteId),t.checkCompletion(),t.analyticsLogEvent("mod_h5pactivity_view_h5pactivity"))}))()}viewMyAttempts(){var t=this;return(0,i.A)((function*(){t.isOpeningPage=!0;const e=u.CoreSites.getCurrentSiteUserId();try{yield _.CoreNavigator.navigateToSitePath(`${C.zr}/${t.courseId}/${t.module.id}/userattempts/${e}`)}finally{t.isOpeningPage=!1}}))()}viewAllAttempts(){var t=this;return(0,i.A)((function*(){t.isOpeningPage=!0;try{yield _.CoreNavigator.navigateToSitePath(`${C.zr}/${t.courseId}/${t.module.id}/users`)}finally{t.isOpeningPage=!1}}))()}onIframeMessage(t){var e=this;return(0,i.A)((function*(){const n=t.data;n&&e.h5pActivity&&(l.CoreXAPI.canPostStatementsInSite(e.site)&&e.isCurrentXAPIPostStatement(n)?e.postStatements(n):e.saveStateEnabled&&e.isCurrentXAPIState(n,"xapi_post_state")&&e.isXAPIPostState(n)?e.postState(n):e.saveStateEnabled&&e.isCurrentXAPIState(n,"xapi_delete_state")&&e.deleteState(n))}))()}isH5PEventForApp(t){return"moodleapp"===t.environment&&"h5p"===t.context}activityIdIsCurrentActivity(t){if(!t||!this.h5pActivity)return!1;if(!this.site.containsUrl(t))return!1;const e=t.match(/xapi\/activity\/(\d+)/);return!!e&&Number(e[1])===this.h5pActivity.context}isCurrentXAPIPostStatement(t){return!!this.h5pActivity&&(!(!this.isH5PEventForApp(t)||"xapi_post_statement"!==t.action||!t.statements)&&this.activityIdIsCurrentActivity(t.statements[0]&&t.statements[0].object&&t.statements[0].object.id))}postStatements(t){var e=this;return(0,i.A)((function*(){if(e.h5pActivity)try{const n={offline:e.hasOffline,courseId:e.courseId,extra:e.h5pActivity.name,siteId:e.site.getId()},i=yield l.CoreXAPI.postStatements(e.h5pActivity.context,t.component,JSON.stringify(t.statements),n);if(e.hasOffline=!i,e.deleteOfflineStates(),i){try{yield A.R.invalidateUserAttempts(e.h5pActivity.id,void 0,e.siteId)}catch{}const n=t.statements.some((t=>!t.object.id.includes("subContentId=")));n&&(e.onActivityFinish.emit(n),e.checkCompletion())}}catch(t){y.CoreDomUtils.showErrorModalDefault(t,"Error sending tracking data.")}}))()}isCurrentXAPIState(t,e){return!!this.h5pActivity&&(!(!this.isH5PEventForApp(t)||t.action!==e)&&this.activityIdIsCurrentActivity(t.activityId))}isXAPIPostState(t){return"stateData"in t}postState(t){var e=this;return(0,i.A)((function*(){try{var n;const i={offline:e.hasOffline,courseId:e.courseId,extra:null===(n=e.h5pActivity)||void 0===n?void 0:n.name,siteId:e.site.getId()},o=yield l.CoreXAPI.postState(t.component,t.activityId,t.agent,t.stateId,t.stateData,i);e.hasOffline=!o}catch(t){y.CoreDomUtils.showErrorModalDefault(t,"Error sending tracking data.")}}))()}deleteState(t){var e=this;return(0,i.A)((function*(){try{yield l.CoreXAPI.deleteState(t.component,t.activityId,t.agent,t.stateId,{siteId:e.site.getId()})}catch(t){y.CoreDomUtils.showErrorModalDefault(t,"Error sending tracking data.")}}))()}deleteOfflineStates(){var t=this;return(0,i.A)((function*(){t.h5pActivity&&(yield g.g.ignoreErrors(c.CoreXAPIOffline.deleteStates(C.$J,{itemId:t.h5pActivity.context})))}))()}sync(){var t=this;return(0,i.A)((function*(){return t.h5pActivity?v.U.syncActivity(t.h5pActivity.context,t.site.getId()):{updated:!1,warnings:[]}}))()}autoSyncEventReceived(){this.checkHasOffline()}ngOnDestroy(){var t;super.ngOnDestroy(),null===(t=this.observer)||void 0===t||t.off(),setTimeout((()=>{window.removeEventListener("message",this.messageListenerFunction)}),2e3)}}return(t=AddonModH5PActivityIndexComponent).ɵfac=function AddonModH5PActivityIndexComponent_Factory(e){return new(e||t)(o.rXU(x.W9),o.rXU(P.k,8))},t.ɵcmp=o.VBU({type:t,selectors:[["addon-mod-h5pactivity-index"]],outputs:{onActivityFinish:"onActivityFinish"},features:[o.Vt3],decls:13,vars:18,consts:[["slot","end"],["iconAction","fas-chart-bar",3,"priority","content","action",4,"ngIf"],["iconAction","fas-circle-info",3,"priority","content"],["fill","clear","aria-haspopup","true",3,"ariaLabel"],[3,"hideUntil"],[3,"completionChanged","module","description","component","componentId","courseId","hasDataToSync"],["class","core-warning-card",4,"ngIf"],[4,"ngIf"],[3,"fileUrl","displayOptions","onlinePlayerUrl","trackComponent","contextId","enableInAppFullscreen","saveFreq","state",4,"ngIf"],["collapsible-footer","",3,"hidden","courseId","currentModuleId"],["iconAction","fas-chart-bar",3,"action","priority","content"],["iconAction","fas-circle-info",3,"action","priority","content"],["fill","clear","aria-haspopup","true",3,"click","ariaLabel"],["name","fas-circle-info","slot","icon-only","aria-hidden","true"],[1,"core-warning-card"],["name","fas-triangle-exclamation","slot","start","aria-hidden","true"],["class","ion-text-wrap",4,"ngIf"],["class","ion-text-wrap ion-margin","expand","block",3,"click",4,"ngIf"],["class","ion-text-center",4,"ngIf"],[1,"ion-text-wrap"],["expand","block",1,"ion-text-wrap","ion-margin",3,"click"],[1,"ion-text-center"],["class","item-heading",4,"ngIf"],[3,"progress","a11yText",4,"ngIf"],[1,"item-heading"],[3,"progress","a11yText"],[3,"fileUrl","displayOptions","onlinePlayerUrl","trackComponent","contextId","enableInAppFullscreen","saveFreq","state"]],template:function AddonModH5PActivityIndexComponent_Template(t,e){1&t&&(o.j41(0,"core-navbar-buttons",0)(1,"core-context-menu"),o.DNE(2,AddonModH5PActivityIndexComponent_core_context_menu_item_2_Template,2,4,"core-context-menu-item",1)(3,AddonModH5PActivityIndexComponent_core_context_menu_item_3_Template,2,4,"core-context-menu-item",1)(4,AddonModH5PActivityIndexComponent_Conditional_4_Template,2,4,"core-context-menu-item",2),o.k0s(),o.DNE(5,AddonModH5PActivityIndexComponent_Conditional_5_Template,3,3,"ion-button",3),o.k0s(),o.j41(6,"core-loading",4)(7,"core-course-module-info",5),o.bIt("completionChanged",(function AddonModH5PActivityIndexComponent_Template_core_course_module_info_completionChanged_7_listener(){return e.onCompletionChange()})),o.k0s(),o.DNE(8,AddonModH5PActivityIndexComponent_ion_card_8_Template,7,6,"ion-card",6)(9,AddonModH5PActivityIndexComponent_ion_card_9_Template,6,3,"ion-card",6)(10,AddonModH5PActivityIndexComponent_ion_list_10_Template,4,3,"ion-list",7)(11,AddonModH5PActivityIndexComponent_core_h5p_iframe_11_Template,1,8,"core-h5p-iframe",8),o.k0s(),o.nrm(12,"core-course-module-navigation",9)),2&t&&(o.R7$(2),o.Y8G("ngIf",e.h5pActivity&&e.h5pActivity.enabletracking&&e.accessInfo&&!e.accessInfo.canreviewattempts),o.R7$(),o.Y8G("ngIf",e.canViewAllAttempts),o.R7$(),o.vxM(4,e.courseContentsPage?4:-1),o.R7$(),o.vxM(5,e.courseContentsPage?-1:5),o.R7$(),o.Y8G("hideUntil",!e.showLoading),o.R7$(),o.Y8G("module",e.module)("description",e.description)("component",e.component)("componentId",e.componentId)("courseId",e.courseId)("hasDataToSync",e.hasOffline),o.R7$(),o.Y8G("ngIf",!e.siteCanDownload&&e.playing),o.R7$(),o.Y8G("ngIf",e.accessInfo&&!e.trackComponent),o.R7$(),o.Y8G("ngIf",e.deployedFile&&!e.playing),o.R7$(),o.Y8G("ngIf",e.playing),o.R7$(),o.Y8G("hidden",e.showLoading)("courseId",e.courseId)("currentModuleId",e.module.id))},dependencies:[w.bT,D.B,M.Q,b.R,S.c,F.z,T.t,O.i,k.T,x.Jm,x.b_,x.iq,x.uz,x.he,x.nf,x.w2,H.Y,E.Q,R.m,U.D9],encapsulation:2}),AddonModH5PActivityIndexComponent})()}}]);