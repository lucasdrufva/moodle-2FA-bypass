"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[1664],{21664:(e,t,n)=>{n.r(t),n.d(t,{default:()=>z});var o=n(3353),s=n(21182),r=n(10467),i=n(49882),a=n(52749),m=n(54638),c=n(63540),l=n(73465),d=n(74431),C=n(15324),g=n(79555),f=n(55554),u=n(89911),_=n(98870),h=n(75383),p=n(75629),I=n(62152),v=n(16474),w=n(94455),b=n(96508),D=n.n(b),y=n(89818),x=n(44426),N=n(45433),O=n(23780),P=n(3716),T=n(54438),M=n(60177),L=n(69502),G=n(17388),V=n(16986),R=n(66198),k=n(64422),A=n(28042),E=n(85122),U=n(86198),S=n(58197),j=n(88246),$=n(43570),Y=n(59528),B=n(73955);const _c0=e=>({$a:e});function CoreCommentsViewerPage_ion_button_9_ion_icon_2_Template(e,t){1&e&&T.nrm(0,"ion-icon",19)}function CoreCommentsViewerPage_ion_button_9_ion_icon_3_Template(e,t){1&e&&T.nrm(0,"ion-icon",20)}function CoreCommentsViewerPage_ion_button_9_Template(e,t){if(1&e){const e=T.RV6();T.j41(0,"ion-button",16),T.nI1(1,"translate"),T.bIt("click",(function CoreCommentsViewerPage_ion_button_9_Template_ion_button_click_0_listener(){T.eBV(e);const t=T.XpG();return T.Njj(t.toggleDelete())})),T.DNE(2,CoreCommentsViewerPage_ion_button_9_ion_icon_2_Template,1,0,"ion-icon",17)(3,CoreCommentsViewerPage_ion_button_9_ion_icon_3_Template,1,0,"ion-icon",18),T.k0s()}if(2&e){const e=T.XpG();T.Y8G("ariaLabel",T.bMT(1,3,"core.toggledelete")),T.R7$(2),T.Y8G("ngIf",!e.showDelete),T.R7$(),T.Y8G("ngIf",e.showDelete)}}function CoreCommentsViewerPage_core_empty_box_20_Template(e,t){1&e&&(T.nrm(0,"core-empty-box",21),T.nI1(1,"translate")),2&e&&T.Y8G("message",T.bMT(1,1,"core.comments.nocomments"))}function CoreCommentsViewerPage_ng_container_23_p_1_Template(e,t){if(1&e&&(T.j41(0,"p",24),T.EFF(1),T.nI1(2,"coreFormatDate"),T.k0s()),2&e){const e=T.XpG().$implicit;T.R7$(),T.SpI(" ",T.i5U(2,1,1e3*e.timecreated,"strftimedayshort")," ")}}function CoreCommentsViewerPage_ng_container_23_Template(e,t){if(1&e){const e=T.RV6();T.qex(0),T.DNE(1,CoreCommentsViewerPage_ng_container_23_p_1_Template,3,4,"p",22),T.j41(2,"core-message",23),T.bIt("onDeleteMessage",(function CoreCommentsViewerPage_ng_container_23_Template_core_message_onDeleteMessage_2_listener(){const t=T.eBV(e).$implicit,n=T.XpG();return T.Njj(n.deleteComment(t))}))("onUndoDeleteMessage",(function CoreCommentsViewerPage_ng_container_23_Template_core_message_onUndoDeleteMessage_2_listener(){const t=T.eBV(e).$implicit,n=T.XpG();return T.Njj(n.undoDeleteComment(t))})),T.k0s(),T.bVm()}if(2&e){const e=t.$implicit,n=T.XpG();T.R7$(),T.Y8G("ngIf",e.showDate),T.R7$(),T.Y8G("message",e)("text",e.content)("time",1e3*e.timecreated)("user",e)("showDelete",n.showDelete)("contextLevel",n.contextLevel)("instanceId",n.instanceId)("courseId",n.courseId)}}function CoreCommentsViewerPage_ion_badge_24_Template(e,t){1&e&&(T.j41(0,"ion-badge",25),T.nrm(1,"ion-icon",26),T.EFF(2),T.nI1(3,"translate"),T.nI1(4,"lowercase"),T.nI1(5,"translate"),T.k0s()),2&e&&(T.R7$(2),T.SpI(" ",T.i5U(5,5,"core.thereisdatatosync",T.eq3(8,_c0,T.bMT(4,3,T.bMT(3,1,"core.comments.comments"))))," "))}function CoreCommentsViewerPage_core_message_25_Template(e,t){if(1&e){const e=T.RV6();T.j41(0,"core-message",27),T.bIt("onDeleteMessage",(function CoreCommentsViewerPage_core_message_25_Template_core_message_onDeleteMessage_0_listener(){T.eBV(e);const t=T.XpG();return T.Njj(t.deleteComment(t.offlineComment))})),T.k0s()}if(2&e){const e=T.XpG();T.Y8G("message",e.offlineComment)("text",e.offlineComment.content)("user",e.offlineComment)("showDelete",e.showDelete)("contextLevel",e.contextLevel)("instanceId",e.instanceId)("courseId",e.courseId)}}function CoreCommentsViewerPage_ion_footer_26_Template(e,t){if(1&e){const e=T.RV6();T.j41(0,"ion-footer",28)(1,"ion-toolbar")(2,"core-send-message-form",29),T.nI1(3,"translate"),T.bIt("onSubmit",(function CoreCommentsViewerPage_ion_footer_26_Template_core_send_message_form_onSubmit_2_listener(t){T.eBV(e);const n=T.XpG();return T.Njj(n.addComment(t))})),T.k0s()()()}if(2&e){const e=T.XpG();T.R7$(2),T.Y8G("sendDisabled",e.sending)("message",e.newComment)("placeholder",T.bMT(3,3,"core.comments.addcomment"))}}let F=(()=>{var e;class CoreCommentsViewerPage{constructor(e){this.route=e,this.comments=[],this.commentsLoaded=!1,this.itemId=0,this.area="",this.page=0,this.title="",this.canLoadMore=!1,this.loadMoreError=!1,this.canAddComments=!1,this.canDeleteComments=!1,this.showDelete=!1,this.hasOffline=!1,this.refreshIcon=d.CoreConstants.ICON_LOADING,this.syncIcon=d.CoreConstants.ICON_LOADING,this.sending=!1,this.newComment="",this.addDeleteCommentsAvailable=!1,this.viewDestroyed=!1,this.currentUserId=a.CoreSites.getCurrentSiteUserId(),this.syncObserver=i.z.on(P.G,(e=>{e.contextLevel==this.contextLevel&&e.instanceId==this.instanceId&&e.componentName==this.componentName&&e.itemId==this.itemId&&e.area==this.area&&(this.showSyncWarnings(e.warnings),this.commentsLoaded=!1,this.refreshIcon=d.CoreConstants.ICON_LOADING,this.syncIcon=d.CoreConstants.ICON_LOADING,this.page=0,this.comments=[],this.fetchComments(!1))}),a.CoreSites.getCurrentSiteId()),this.isOnline=w.WE.isOnline(),this.onlineObserver=w.WE.onChange().subscribe((()=>{g.SK.run((()=>{this.isOnline=w.WE.isOnline()}))}))}ngOnInit(){var e=this;return(0,r.A)((function*(){try{e.contextLevel=C.CoreNavigator.getRequiredRouteParam("contextLevel"),e.instanceId=C.CoreNavigator.getRequiredRouteNumberParam("instanceId"),e.componentName=C.CoreNavigator.getRequiredRouteParam("componentName"),e.itemId=C.CoreNavigator.getRequiredRouteNumberParam("itemId"),e.area=C.CoreNavigator.getRouteParam("area")||"",e.title=C.CoreNavigator.getRouteParam("title")||g.HT.instant("core.comments.comments"),e.courseId=C.CoreNavigator.getRouteNumberParam("courseId")}catch(e){return u.CoreDomUtils.showErrorModal(e),C.CoreNavigator.back(),void 0}e.addDeleteCommentsAvailable=yield m.CoreComments.isAddCommentsAvailable(),e.currentUserId=a.CoreSites.getCurrentSiteUserId(),e.commentsLoaded=!1,yield e.fetchComments(!0)}))()}fetchComments(e,t=!1){var n=this;return(0,r.A)((function*(){n.loadMoreError=!1,e&&(yield f.g.ignoreErrors(n.syncComments(t)));try{const e=yield m.CoreComments.getComments(n.contextLevel,n.instanceId,n.componentName,n.itemId,n.area,n.page);n.canAddComments=n.addDeleteCommentsAvailable&&!!e.canpost;let t=e.comments.sort(((e,t)=>e.timecreated-t.timecreated));n.canLoadMore=void 0!==e.count?n.comments.length+t.length<e.count:e.comments.length>0&&e.comments.length>=m.CoreCommentsProvider.pageSize,t=yield Promise.all(t.map((e=>n.loadCommentProfile(e)))),n.comments=t.concat(n.comments),n.comments.forEach(((e,t)=>n.calculateCommentData(e,n.comments[t-1]))),n.canDeleteComments=n.addDeleteCommentsAvailable&&(n.hasOffline||n.comments.some((e=>!!e.delete))),yield n.loadOfflineData()}catch(e){n.loadMoreError=!0,e&&"assignsubmission_comments"==n.componentName?u.CoreDomUtils.showAlertTranslated("core.notice","core.comments.commentsnotworking"):u.CoreDomUtils.showErrorModalDefault(e,g.HT.instant("core.error")+": get_comments")}finally{n.commentsLoaded=!0,n.refreshIcon=d.CoreConstants.ICON_REFRESH,n.syncIcon=d.CoreConstants.ICON_SYNC,0==n.page&&n.scrollToBottom()}}))()}calculateCommentData(e,t){var n;e.showDate=this.showDate(e,t),e.showUserData=this.showUserData(e,t),e.showTail=this.showTail(e,t),e.delete=null!==(n=e.delete)&&void 0!==n&&n}loadPrevious(e){var t=this;return(0,r.A)((function*(){t.page++,t.canLoadMore=!1;try{yield t.fetchComments(!0)}finally{e&&e()}}))()}refreshComments(e,t){var n=this;return(0,r.A)((function*(){n.commentsLoaded=!1,n.refreshIcon=d.CoreConstants.ICON_LOADING,n.syncIcon=d.CoreConstants.ICON_LOADING,yield f.g.ignoreErrors(n.invalidateComments()),n.page=0,n.comments=[];try{yield n.fetchComments(!0,e)}finally{null==t||t.complete()}}))()}showSyncWarnings(e){const t=h.Ni.buildMessage(e);t&&u.CoreDomUtils.showAlert(void 0,t)}syncComments(e){var t=this;return(0,r.A)((function*(){try{const e=yield c.CoreCommentsSync.syncComments(t.contextLevel,t.instanceId,t.componentName,t.itemId,t.area);t.showSyncWarnings((null==e?void 0:e.warnings)||[])}catch(t){throw e&&u.CoreDomUtils.showErrorModalDefault(t,"core.errorsync",!0),new p.CoreError(t)}}))()}addComment(e){var t=this;return(0,r.A)((function*(){x.p.close();const n=yield O.CoreLoadings.show("core.sending",!0);t.sending=!0;try{const n=yield m.CoreComments.addComment(e,t.contextLevel,t.instanceId,t.componentName,t.itemId,t.area);if(N.CoreToasts.show({message:n?"core.comments.eventcommentcreated":"core.datastoredoffline",translateMessage:!0,duration:N.ToastDuration.LONG,position:"bottom",positionAnchor:"viewer-footer"}),n){t.invalidateComments();const e=yield t.loadCommentProfile(n);t.calculateCommentData(e,t.comments[t.comments.length-1]),t.comments=t.comments.concat([e]),t.canDeleteComments=t.addDeleteCommentsAvailable,i.z.trigger(m.CoreCommentsProvider.COMMENTS_COUNT_CHANGED_EVENT,{contextLevel:t.contextLevel,instanceId:t.instanceId,component:t.componentName,itemId:t.itemId,area:t.area,countChange:1},a.CoreSites.getCurrentSiteId()),t.refreshInBackground()}else!1===n&&(yield t.loadOfflineData())}catch(e){u.CoreDomUtils.showErrorModal(e)}finally{n.dismiss(),t.sending=!1,t.scrollToBottom()}}))()}deleteComment(e){var t=this;return(0,r.A)((function*(){const n=v.CoreTimeUtils.userDate(1e3*("lastmodified"in e?e.lastmodified:e.timecreated),"core.strftimerecentfull"),o={contextlevel:t.contextLevel,instanceid:t.instanceId,component:t.componentName,itemid:t.itemId,area:t.area,content:e.content,id:"id"in e?e.id:void 0};try{yield u.CoreDomUtils.showDeleteConfirm("core.comments.deletecommentbyon",{$a:{user:e.fullname||"",time:n}})}catch{return}try{const n=yield m.CoreComments.deleteComment(o);if(t.showDelete=!1,n&&"id"in e){const n=t.comments.findIndex((t=>t.id==e.id));n>=0&&(t.comments.splice(n,1),i.z.trigger(m.CoreCommentsProvider.COMMENTS_COUNT_CHANGED_EVENT,{contextLevel:t.contextLevel,instanceId:t.instanceId,component:t.componentName,itemId:t.itemId,area:t.area,countChange:-1},a.CoreSites.getCurrentSiteId()),t.refreshInBackground())}else t.loadOfflineData();t.invalidateComments(),N.CoreToasts.show({message:"core.comments.eventcommentdeleted",translateMessage:!0,duration:N.ToastDuration.LONG})}catch(e){u.CoreDomUtils.showErrorModalDefault(e,"Delete comment failed.")}}))()}invalidateComments(){return m.CoreComments.invalidateCommentsData(this.contextLevel,this.instanceId,this.componentName,this.itemId,this.area)}loadCommentProfile(e){return(0,r.A)((function*(){if(!e.userid)return e;try{const t=yield _.CoreUser.getProfile(e.userid,void 0,!0);e.profileimageurl=t.profileimageurl,e.fullname=t.fullname}catch{}return e}))()}showUserData(e,t){return!(e.userid==this.currentUserId||t&&t.userid==e.userid&&!e.showDate)}showTail(e,t){return!t||t.userid!=e.userid||!!t.showDate}showDate(e,t){return!t||!D()(1e3*e.timecreated).isSame(1e3*t.timecreated,"day")}loadOfflineData(){var e=this;return(0,r.A)((function*(){const t=[];let n=!1;t.push(I.CoreCommentsOffline.getComment(e.contextLevel,e.instanceId,e.componentName,e.itemId,e.area).then(function(){var t=(0,r.A)((function*(t){e.offlineComment=t,e.offlineComment&&(""==e.newComment&&(e.newComment=e.offlineComment.content),e.offlineComment.userid=e.currentUserId,e.offlineComment.pending=!0)}));return function(e){return t.apply(this,arguments)}}())),t.push(I.CoreCommentsOffline.getDeletedComments(e.contextLevel,e.instanceId,e.componentName,e.itemId,e.area).then((t=>{n=t&&t.length>0,n&&t.forEach((t=>{const n=e.comments.find((e=>e.id==t.commentid));n&&(n.deleted=!!t.deleted)}))}))),yield Promise.all(t),e.hasOffline=!!e.offlineComment||n}))()}undoDeleteComment(e){var t=this;return(0,r.A)((function*(){yield I.CoreCommentsOffline.undoDeleteComment(e.id),e.deleted=!1,t.showDelete=!1}))()}scrollToBottom(){setTimeout((()=>{var e;this.viewDestroyed||(null===(e=this.content)||void 0===e||e.scrollToBottom())}),100)}toggleDelete(){this.showDelete=!this.showDelete}refreshInBackground(){var e=this;return(0,r.A)((function*(){yield f.g.ignoreErrors(e.invalidateComments());const t=[];for(let n=0;n<=e.page;n++)t.push(m.CoreComments.getComments(e.contextLevel,e.instanceId,e.componentName,e.itemId,e.area,n));yield Promise.all(t)}))()}ngOnDestroy(){var e;null===(e=this.syncObserver)||void 0===e||e.off(),this.onlineObserver.unsubscribe(),this.viewDestroyed=!0}}return(e=CoreCommentsViewerPage).ɵfac=function CoreCommentsViewerPage_Factory(t){return new(t||e)(T.rXU(s.nX))},e.ɵcmp=T.VBU({type:e,selectors:[["page-core-comments-viewer"]],viewQuery:function CoreCommentsViewerPage_Query(e,t){if(1&e&&T.GBs(l.W9,5),2&e){let e;T.mGM(e=T.lsd())&&(t.content=e.first)}},decls:27,vars:34,consts:[["slot","start"],[3,"text"],[3,"text","contextLevel","contextInstanceId","courseId"],["slot","end"],["slot","end","fill","clear",3,"ariaLabel","click",4,"ngIf"],[3,"action","hidden","priority","content","iconAction","closeOnClick"],["slot","fixed",3,"ionRefresh","disabled"],[3,"pullingText"],[3,"hideUntil"],["icon","fas-comments",3,"message",4,"ngIf"],["position","top",3,"action","enabled","error"],[1,"addon-messages-discussion-container"],[4,"ngFor","ngForOf"],["class","ion-text-wrap","color","info",4,"ngIf"],[3,"message","text","user","showDelete","contextLevel","instanceId","courseId","onDeleteMessage",4,"ngIf"],["class","footer-adjustable","id","viewer-footer",4,"ngIf"],["slot","end","fill","clear",3,"click","ariaLabel"],["name","fas-pen","slot","icon-only","aria-hidden","true",4,"ngIf"],["name","fas-check","slot","icon-only","aria-hidden","true",4,"ngIf"],["name","fas-pen","slot","icon-only","aria-hidden","true"],["name","fas-check","slot","icon-only","aria-hidden","true"],["icon","fas-comments",3,"message"],["class","ion-text-center addon-messages-date",4,"ngIf"],[3,"onDeleteMessage","onUndoDeleteMessage","message","text","time","user","showDelete","contextLevel","instanceId","courseId"],[1,"ion-text-center","addon-messages-date"],["color","info",1,"ion-text-wrap"],["name","fas-triangle-exclamation","aria-hidden","true"],[3,"onDeleteMessage","message","text","user","showDelete","contextLevel","instanceId","courseId"],["id","viewer-footer",1,"footer-adjustable"],[3,"onSubmit","sendDisabled","message","placeholder"]],template:function CoreCommentsViewerPage_Template(e,t){1&e&&(T.j41(0,"ion-header")(1,"ion-toolbar")(2,"ion-buttons",0),T.nrm(3,"ion-back-button",1),T.nI1(4,"translate"),T.k0s(),T.j41(5,"ion-title")(6,"h1"),T.nrm(7,"core-format-text",2),T.k0s()(),T.j41(8,"ion-buttons",3),T.DNE(9,CoreCommentsViewerPage_ion_button_9_Template,4,5,"ion-button",4),T.j41(10,"core-context-menu")(11,"core-context-menu-item",5),T.nI1(12,"translate"),T.bIt("action",(function CoreCommentsViewerPage_Template_core_context_menu_item_action_11_listener(){return t.refreshComments(!1)})),T.k0s(),T.j41(13,"core-context-menu-item",5),T.nI1(14,"translate"),T.bIt("action",(function CoreCommentsViewerPage_Template_core_context_menu_item_action_13_listener(){return t.refreshComments(!0)})),T.k0s()()()()(),T.j41(15,"ion-content")(16,"ion-refresher",6),T.bIt("ionRefresh",(function CoreCommentsViewerPage_Template_ion_refresher_ionRefresh_16_listener(e){return t.refreshComments(!1,e.target)})),T.nrm(17,"ion-refresher-content",7),T.nI1(18,"translate"),T.k0s(),T.j41(19,"core-loading",8),T.DNE(20,CoreCommentsViewerPage_core_empty_box_20_Template,2,3,"core-empty-box",9),T.j41(21,"core-infinite-loading",10),T.bIt("action",(function CoreCommentsViewerPage_Template_core_infinite_loading_action_21_listener(e){return t.loadPrevious(e)})),T.k0s(),T.j41(22,"ion-list",11),T.DNE(23,CoreCommentsViewerPage_ng_container_23_Template,3,9,"ng-container",12)(24,CoreCommentsViewerPage_ion_badge_24_Template,6,10,"ion-badge",13)(25,CoreCommentsViewerPage_core_message_25_Template,1,7,"core-message",14),T.k0s()()(),T.DNE(26,CoreCommentsViewerPage_ion_footer_26_Template,4,5,"ion-footer",15)),2&e&&(T.R7$(3),T.Y8G("text",T.bMT(4,26,"core.back")),T.R7$(4),T.Y8G("text",t.title)("contextLevel",t.contextLevel)("contextInstanceId",t.instanceId)("courseId",t.courseId),T.R7$(2),T.Y8G("ngIf",t.canDeleteComments),T.R7$(2),T.Y8G("hidden",!(t.commentsLoaded&&!t.hasOffline))("priority",100)("content",T.bMT(12,28,"core.refresh"))("iconAction",t.refreshIcon)("closeOnClick",!0),T.R7$(2),T.Y8G("hidden",!(t.commentsLoaded&&t.hasOffline&&t.isOnline))("priority",100)("content",T.bMT(14,30,"core.settings.synchronizenow"))("iconAction",t.syncIcon)("closeOnClick",!1),T.R7$(3),T.Y8G("disabled",!t.commentsLoaded),T.R7$(),T.FS9("pullingText",T.bMT(18,32,"core.pulltorefresh")),T.R7$(2),T.Y8G("hideUntil",t.commentsLoaded),T.R7$(),T.Y8G("ngIf",!(null!=t.comments&&t.comments.length||t.offlineComment)),T.R7$(),T.Y8G("enabled",t.canLoadMore)("error",t.loadMoreError),T.R7$(2),T.Y8G("ngForOf",t.comments),T.R7$(),T.Y8G("ngIf",t.hasOffline),T.R7$(),T.Y8G("ngIf",t.hasOffline&&t.offlineComment),T.R7$(),T.Y8G("ngIf",t.commentsLoaded&&t.canAddComments))},dependencies:[M.Sq,M.bT,L.B,G.Q,V.h,R.b,k.R,A.A,E.u,U.t,S.B,j.i,$.T,l.In,l.Jm,l.QW,l.W9,l.M0,l.eU,l.iq,l.nf,l.To,l.Ki,l.BC,l.ai,l.el,M.GH,Y.f,B.D9],styles:[".ios[_nghost-%COMP%]   ion-footer[_ngcontent-%COMP%]   .toolbar[_ngcontent-%COMP%]:last-child, .ios   [_nghost-%COMP%]   ion-footer[_ngcontent-%COMP%]   .toolbar[_ngcontent-%COMP%]:last-child{padding-bottom:4px;min-height:0px}ion-content[_ngcontent-%COMP%]{--content-background: var(--background-alternative);--background: var(--content-background)}ion-content[_ngcontent-%COMP%]::part(scroll){padding-bottom:0!important}ion-content[_ngcontent-%COMP%]   core-empty-box[_ngcontent-%COMP%]{--core-empty-box-icon-color: var(--dark)}.addon-messages-discussion-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;padding-bottom:16px!important;background:var(--content-background)}.addon-messages-date[_ngcontent-%COMP%]{font-weight:400;font-size:.9rem}","ion-badge[_ngcontent-%COMP%]{margin:8px auto}"],data:{animation:[y.d.SLIDE_IN_OUT]}}),CoreCommentsViewerPage})();const X=[{path:":contextLevel/:instanceId/:componentName/:itemId",component:F}];let z=(()=>{var e;class CoreCommentsLazyModule{}return(e=CoreCommentsLazyModule).ɵfac=function CoreCommentsLazyModule_Factory(t){return new(t||e)},e.ɵmod=T.$C({type:e}),e.ɵinj=T.G2t({imports:[s.iI.forChild(X),o.n]}),CoreCommentsLazyModule})();void(("undefined"==typeof ngJitMode||ngJitMode)&&T.Obh(z,{declarations:[F],imports:[s.iI,o.n]}))}}]);