"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[1877],{74339:(e,r,t)=>{t.d(r,{M:()=>a});var n=t(10467),s=t(52749),i=t(75383),o=t(79555),u=t(25191),d=t(54438);let y=(()=>{var e;class AddonModSurveyOfflineProvider{deleteSurveyAnswers(e,r,t){return(0,n.A)((function*(){const n=yield s.CoreSites.getSite(r);t=t||n.getUserId(),yield n.getDb().deleteRecords(u.K,{surveyid:e,userid:t})}))()}getAllData(e){return(0,n.A)((function*(){const r=yield s.CoreSites.getSite(e);return(yield r.getDb().getAllRecords(u.K)).map((e=>Object.assign(e,{answers:i.Ni.parseJSON(e.answers)})))}))()}getSurveyAnswers(e,r,t){var s=this;return(0,n.A)((function*(){try{return(yield s.getSurveyData(e,r,t)).answers||[]}catch{return[]}}))()}getSurveyData(e,r,t){return(0,n.A)((function*(){const n=yield s.CoreSites.getSite(r);t=t||n.getUserId();const o=yield n.getDb().getRecord(u.K,{surveyid:e,userid:t});return Object.assign(o,{answers:i.Ni.parseJSON(o.answers)})}))()}hasAnswers(e,r,t){var s=this;return(0,n.A)((function*(){return!!(yield s.getSurveyAnswers(e,r,t)).length}))()}saveAnswers(e,r,t,i,o,d){return(0,n.A)((function*(){const n=yield s.CoreSites.getSite(o);d=d||n.getUserId();const y={surveyid:e,name:r,courseid:t,userid:d,answers:JSON.stringify(i),timecreated:Date.now()};yield n.getDb().insertRecord(u.K,y)}))()}}return(e=AddonModSurveyOfflineProvider).ɵfac=function AddonModSurveyOfflineProvider_Factory(r){return new(r||e)},e.ɵprov=d.jDH({token:e,factory:e.ɵfac,providedIn:"root"}),AddonModSurveyOfflineProvider})();const a=(0,o.Qd)(y)},51877:(e,r,t)=>{t.d(r,{o:()=>w});var n=t(10467),s=t(49446),i=t(37690),o=t(44682),u=t(97254),d=t(94455),y=t(52749),a=t(43411),c=t(79555),v=t(49882),l=t(97810),S=t(72829),g=t(74339),f=t(67039),A=t(55554),h=t(54438);let C=(()=>{var e;class AddonModSurveySyncProvider extends i.L{constructor(){super("AddonModSurveySyncProvider"),this.componentTranslatableString="survey"}getSyncId(e,r){return e+"#"+r}syncAllSurveys(e,r){return this.syncOnSites("all surveys",(e=>this.syncAllSurveysFunc(!!r,e)),e)}syncAllSurveysFunc(e,r){var t=this;return(0,n.A)((function*(){const s=(yield g.M.getAllData(r)).map(function(){var s=(0,n.A)((function*(n){const s=yield e?t.syncSurvey(n.surveyid,n.userid,r):t.syncSurveyIfNeeded(n.surveyid,n.userid,r);s&&s.updated&&v.z.trigger(f.A9,{surveyId:n.surveyid,userId:n.userid,warnings:s.warnings},r)}));return function(e){return s.apply(this,arguments)}}());yield Promise.all(s)}))()}syncSurveyIfNeeded(e,r,t){var s=this;return(0,n.A)((function*(){const n=s.getSyncId(e,r);if(yield s.isSyncNeeded(n,t))return s.syncSurvey(e,r,t)}))()}syncSurvey(e,r,t){var s=this;return(0,n.A)((function*(){const n=yield y.CoreSites.getSite(t);t=n.getId(),r=r||n.getUserId();const i=s.getSyncId(e,r),o=s.getOngoingSync(i,t);if(o)return o;s.logger.debug(`Try to sync survey '${e}' for user '${r}'`);const u=s.performSyncSurvey(e,r,t);return s.addOngoingSync(i,u,t)}))()}performSyncSurvey(e,r,t){var i=this;return(0,n.A)((function*(){const n={warnings:[],updated:!1};A.g.ignoreErrors(u.CoreCourseLogHelper.syncActivity(f.TV,e,t));let y,c=0;try{y=yield g.M.getSurveyData(e,t,r),c=y.answers.length}catch{}if(c>0&&y){if(!d.WE.isOnline())throw new s.CoreNetworkError;n.courseId=y.courseid;try{yield S.h.submitAnswersOnline(e,y.answers,t),n.updated=!0,yield g.M.deleteSurveyAnswers(e,t,r)}catch(s){if(!a.CoreWSError.isWebServiceError(s))throw s;n.updated=!0,yield g.M.deleteSurveyAnswers(e,t,r),i.addOfflineDataDeletedWarning(n.warnings,y.name,s)}if(n.courseId){yield S.h.invalidateSurveyData(n.courseId,t);const r=yield o.CoreCourse.getModuleBasicInfoByInstance(e,"survey",{siteId:t});A.g.ignoreErrors(i.prefetchAfterUpdate((0,l.j)(),r,n.courseId,void 0,t))}}const v=i.getSyncId(e,r);return A.g.ignoreErrors(i.setSyncTime(v,t)),n}))()}}return(e=AddonModSurveySyncProvider).ɵfac=function AddonModSurveySyncProvider_Factory(r){return new(r||e)},e.ɵprov=h.jDH({token:e,factory:e.ɵfac,providedIn:"root"}),AddonModSurveySyncProvider})();const w=(0,c.Qd)(C)},72829:(e,r,t)=>{t.d(r,{h:()=>A});var n=t(10467),s=t(75629),i=t(97254),o=t(94455),u=t(88793),d=t(52749),y=t(43411),a=t(79555),c=t(74339),v=t(67039),l=t(74431),S=t(55554),g=t(54438);let f=(()=>{var e;class AddonModSurveyProvider{getQuestions(e,r={}){var t=this;return(0,n.A)((function*(){const n=yield d.CoreSites.getSite(r.siteId),i={surveyid:e},o={cacheKey:t.getQuestionsCacheKey(e),updateFrequency:l.CoreCacheUpdateFrequency.RARELY,component:v.TV,componentId:r.cmId,...d.CoreSites.getReadingStrategyPreSets(r.readingStrategy)},u=yield n.read("mod_survey_get_questions",i,o);if(u.questions)return u.questions;throw new s.CoreError("No questions were found.")}))()}getQuestionsCacheKey(e){return AddonModSurveyProvider.ROOT_CACHE_KEY+"questions:"+e}getSurveyCacheKey(e){return AddonModSurveyProvider.ROOT_CACHE_KEY+"survey:"+e}getSurveyDataByKey(e,r,t,i={}){var o=this;return(0,n.A)((function*(){const n=yield d.CoreSites.getSite(i.siteId),u={courseids:[e]},y={cacheKey:o.getSurveyCacheKey(e),updateFrequency:l.CoreCacheUpdateFrequency.RARELY,component:v.TV,...d.CoreSites.getReadingStrategyPreSets(i.readingStrategy)},c=(yield n.read("mod_survey_get_surveys_by_courses",u,y)).surveys.find((e=>e[r]==t));if(c)return c;throw new s.CoreError(a.HT.instant("core.course.modulenotfound"))}))()}getSurvey(e,r,t={}){return this.getSurveyDataByKey(e,"coursemodule",r,t)}getSurveyById(e,r,t={}){return this.getSurveyDataByKey(e,"id",r,t)}invalidateContent(e,r,t){var s=this;return(0,n.A)((function*(){t=t||d.CoreSites.getCurrentSiteId();const i=[];i.push(s.getSurvey(r,e).then(function(){var e=(0,n.A)((function*(e){const n=[];n.push(s.invalidateSurveyData(r,t)),n.push(s.invalidateQuestions(e.id,t)),yield Promise.all(n)}));return function(r){return e.apply(this,arguments)}}())),i.push(u.CoreFilepool.invalidateFilesByComponent(t,v.TV,e)),yield S.g.allPromises(i)}))()}invalidateQuestions(e,r){var t=this;return(0,n.A)((function*(){const n=yield d.CoreSites.getSite(r);yield n.invalidateWsCacheForKey(t.getQuestionsCacheKey(e))}))()}invalidateSurveyData(e,r){var t=this;return(0,n.A)((function*(){const n=yield d.CoreSites.getSite(r);yield n.invalidateWsCacheForKey(t.getSurveyCacheKey(e))}))()}logView(e,r){return(0,n.A)((function*(){const t={surveyid:e};yield i.CoreCourseLogHelper.log("mod_survey_view_survey",t,v.TV,e,r)}))()}submitAnswers(e,r,t,s,i){var u=this;return(0,n.A)((function*(){const a=function(){var o=(0,n.A)((function*(){return yield c.M.saveAnswers(e,r,t,s,i),!1}));return function storeOffline(){return o.apply(this,arguments)}}();if(i=i||d.CoreSites.getCurrentSiteId(),!o.WE.isOnline())return a();try{return yield c.M.deleteSurveyAnswers(e,i),yield u.submitAnswersOnline(e,s,i),!0}catch(e){if(y.CoreWSError.isWebServiceError(e))throw e;return a()}}))()}submitAnswersOnline(e,r,t){return(0,n.A)((function*(){const n=yield d.CoreSites.getSite(t),i={surveyid:e,answers:r};if(!(yield n.write("mod_survey_submit_answers",i)).status)throw new s.CoreError("Error submitting answers.")}))()}}return(e=AddonModSurveyProvider).ROOT_CACHE_KEY="mmaModSurvey:",e.ɵfac=function AddonModSurveyProvider_Factory(r){return new(r||e)},e.ɵprov=g.jDH({token:e,factory:e.ɵfac,providedIn:"root"}),AddonModSurveyProvider})();const A=(0,a.Qd)(f)}}]);